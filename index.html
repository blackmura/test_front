<!DOCTYPE html>
<html>

<head>
	<meta charset="windows-1251">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Шaxдаг App</title>
	<link rel="stylesheet"  href="css/jqm-icon-pack-fa.css" />
	<link rel="stylesheet" href="css/default/jquery.mobile-1.4.5.min.css">
	<link rel="stylesheet"  href="css/autocomplete.css" />
	<link rel="stylesheet"  href="css/font-awesome/css/font-awesome.min.css" />
	<link href="js/photoswipe/photoswipe.css" type="text/css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="css/player360/360player.css" />
	<link href="css/style.css?2" rel="stylesheet" type="text/css" />
	
	<script src="js/jquery.js"></script>
	<script src="js/jquery.mobile-1.4.5.min.js"></script>
	<script type="text/javascript" src="js/jquery.autocomplete.js"></script>
	
	<script src="js/realplexor.js"></script>
	
	<script type="text/javascript" src="js/photoswipe/klass.min.js"></script>
	<script type="text/javascript" src="js/photoswipe/photoswipe_my.js"></script>
	
	<script type="text/javascript" src="js/badger.js"></script>
	<link rel="stylesheet" href="css/badger.css" type="text/css" />

	<script type="text/javascript" src="js/general.js"></script>
	
	<script type="text/javascript" src="js/audio_api_patch.js"></script> 

	<!-- Audio -->
	<script type="text/javascript" src="js/audio_api_patch.js"></script>
	<script type="text/javascript" src="js/player360/berniecode-animator.js"></script>
	<script type="text/javascript" src="js/player360/soundmanager2.js"></script>
	<script type="text/javascript" src="js/player360/360player.js"></script>
	<!-- Velocity -->
	<script type="text/javascript" src="js/velocity.min.js"></script>
	

	
	
	
</head>

<body>
<script language='javascript'>
	<!----------------------------------------------------------------------------------- General events-->
	var GLOBAL_APP_VERS = new Object({type: "web_mobile", version: "1.0"}); //app_mobile
	var GLOBAL_SESSID=null;
	var GLOBAL_SERVER="http://shaxdag.com/";
	if(GLOBAL_APP_VERS.type == "web_mobile"){
		GLOBAL_HOST=document.domain;
		var GLOBAL_SERVER="http://"+GLOBAL_HOST+"/";
	}
	else{
		GLOBAL_HOST="shaxdag.com";
		var GLOBAL_SERVER="http://shaxdag.com/";
	}
	var GLOBAL_TEST
	var my_player;
	var photoSwipeInstance;
	var realplexor = new Dklab_Realplexor(
				"http://rpl."+GLOBAL_HOST+":8088",  // Realplexor's engine URL
				"users" // namespace (optional)
			);
	
	$( document ).on( "popupafterclose", "#popup_window", function() {
		$( this ).remove();
	});
	$( document ).on( "popupafterclose", "#popup_votes", function() {
		$( this ).remove();
	});
	
	//Обработка ajax
	$(document).ajaxSend(function(event, jqxhr, settings) { 
		if ( settings.url.indexOf("autocomplete/show")>0 || settings.url.indexOf("method=clearDialogNtfy")>0 || settings.url.indexOf("server/proc_typing.php")>0 || settings.url.indexOf("method=refreshOnline")>0 ) {
			//если автозаполнение  то ничего не делаем
		}
		else{
			$(".ajax-loader-center").show();
			//$(".ajax-loader-center i").css({display: "initial"}); 
		}
		//обработчики
		Fotos.Utils.HandleAjax("send", settings);
		
		console.log(settings.url); 
	});
	$(document).ajaxComplete(function(event, jqxhr, settings) {
		$(".ajax-loader-center").hide();
		//обработчики
		Fotos.Utils.HandleAjax("stop", settings);
	});
	$( document ).ajaxError(function( event, request, settings ) {
		if ( settings.url.indexOf("autocomplete/show")>0) {
			
		}
		else
		if ( settings.url != "ajax/missing.html" ) { //пример
			Environment.System.LastAjaxCall = settings;
			var text = 'Проблемы с интернет соединением <a href="" class="ui-btn ui-corner-all ui-shadow ui-btn-b" id="retry_ajax">Повторить</a>';
			show_popup("ajax not complited", text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
			$("#retry_ajax").off("click");
			$("#retry_ajax").on("click", Environment.Utils.retryAjax);
			console.log(settings);
		}
	});
	//обработка логаут
	$( ".nav-logout" ).on( "vclick", function() {
		gl_logout();
	});
	$( document ).on( "mobileinit", function() {
		
		
	});
	
	//документ готов
	$( document ).ready(function() {
		$.mobile.defaultPageTransition = "none"; 
		$( ":mobile-pagecontainer" ).on( "pagecontainershow", function( event, ui ) {
		  //console.log(ui.prevPage); 
		  //console.log(ui.toPage);
		  console.log($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
		}); 		
		$( "body>[data-role='panel']" ).panel();
		$( document ).on( "swipeleft", "#left_panel", function( e ) {
			console.log("aa");
			if ( $( ".ui-page-active" ).jqmData( "panel" ) == "open" ) {
				if ( e.type === "swipeleft" ) {
					$( "#left_panel" ).panel( "close" );
				}
			}
		});
		//обработчик догрузок контента при скроллинге
		$(document).on("scrollstop", function(){
			if ($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_fotos"){
				if(($(document).height() - $(window).height() <= $(window).scrollTop()+ 100) && Fotos.loading_data==0){
					Fotos.GoAppend();
				}
			}
			if ($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_usersearch"){
				if(($(document).height() - $(window).height() <= $(window).scrollTop()+ 100) && UserList.loading_data==0){
					UserList.GoAppend();
				}
			}
			if ($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_msg2"){				
				if(($(document).height() - $(window).height() <= $(window).scrollTop()+ 100) && NavMsg.loading_data==0){
					NavMsg.GoAppendDialog();
				}
			}
			if ($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_music"){				
				if(($(document).height() - $(window).height() <= $(window).scrollTop()+ 100) && Music.loading_data==0){
					Music.GoAppend();
				}
			}
			if ($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_evants"){				
				if(($(document).height() - $(window).height() <= $(window).scrollTop()+ 100) && Evants.loading_data==0){
					Evants.onScroll();
				}
			}
		}); 
		//-------------------- Авторизация по сохраненным данным в хранилище
		var auth_str = get_session_auth();
		//если есть данные для авторизации
		if(auth_str != null){
			try {
			  var auth_obj = JSON.parse(auth_str);
			  if(/*auth_obj.sesstime > Math.round(+new Date()/1000)*/ 1==1){
				//если срок хранения данных не истек, то пробуем логиниться
				gl_auth(auth_obj.login, auth_obj.pass, 0); // не сохраняя пароль
				console.log("Авторизация из локального хранилища"); 
			  }
			  else{
				// если срок хранения истек, то стираем данные о входе из хранилища и переходим на страницу авторизации
				window.localStorage.removeItem("auth");
				$( ":mobile-pagecontainer" ).pagecontainer( "change", "#page_auth" );
			  }
			} catch (e) {
			  console.error("Ошибка чтения данных о входе из JSON:", e); 
			}
		}
		//если данных для авторизации нет, то проверяем на живость сессии
		else{
			//----------проверяем наличие сессии в хранилище сессиий. Если нет, то пробуем присвоить из URL
			var sessid = get_session();
			//если сессия жива у клиента, то обновляем инфу по юзеру с сервера
			if(sessid != null){
				console.log("Авторизация из существующей сессии "+sessid); 
				refresh_ui();
				
			}
			else{
				//пробуем  получить параметры из строки
				var url_obj = getUrlVars();
				if (url_obj.PHPSESSID != null){
					console.log("Авторизация из адресной строки  "+url_obj.PHPSESSID); 
					set_session({uid: null, passwd: null, remember: 0}, url_obj.PHPSESSID);
					refresh_ui();
				}
				else{
					//иначе юзер не залогинен, отправить на страницу авторизации
					$( ":mobile-pagecontainer" ).pagecontainer( "change", "#auth_page" );
				}
			}
		}
		//создаем объект audio API
		Audio_.init();
		console.log("document ready fired");
		
		
	});

	<!-- ---------------------------------------------------------------------------------------------------------------GLOBAL FUNCTIONS-->
	// обновляем информацию о пользователе вместе с проверкой сессии
	function refresh_ui(){
		var sessid = get_session();
		//если есть переменная сессии не пустая
		if (sessid !=null){
			$.get( LS("refresh_ui.php"), { method: "init", PHPSESSID: sessid}, 
				function( data ) {
					if(data.auth_status=="success"){
						Environment.init(data);
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
				},
				"json"
			);
			
		}
		//если сессия даже не установлена
		else{
			$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#auth_page"), { transition: "none", reverse: true} );
		}
	}
	
	function clear_sessid(){
		if(GLOBAL_APP_VERS.type == "web_mobile"){
			setCookie ("m_sessid", null);
			setCookie("m_auth", null);
		}
		else
		if(GLOBAL_APP_VERS.type == "app_mobile"){
			window.sessionStorage.removeItem("sessid");
			window.localStorage.removeItem("auth");
		}
	};
	function set_session(obj, sessid){ //like params object in login request {request: {uid, passwd, remember}, sessid}
		if(GLOBAL_APP_VERS.type == "web_mobile"){
			if(sessid){
				console.log("Устанавливаем сессию s Cookie "+sessid);
				setCookie ("m_sessid", sessid);
				if(obj.remember){
					var date = new Date;
					date.setDate( date.getDate() + 360);

					setCookie("m_auth", JSON.stringify({login: obj.uid, pass: obj.passwd}), date.toUTCString());
				}
			}
		}
		else
		if(GLOBAL_APP_VERS.type == "app_mobile"){
			console.log("Устанавливаем сессию s Storage "+sessid);
			window.sessionStorage.setItem("sessid", sessid);
			if(obj.remember){
				window.localStorage.removeItem("auth");
				window.localStorage.setItem("auth", JSON.stringify({login: obj.uid, pass: obj.passwd}));
			}
		}
	};
	function get_session(){
		var sessid=null;
		if(GLOBAL_APP_VERS.type == "web_mobile"){
			sessid = getCookie("m_sessid");
		}
		else
		if(GLOBAL_APP_VERS.type == "app_mobile"){
			sessid = window.sessionStorage.getItem("sessid");
		}
		return sessid;
	};
	function get_session_auth(){
		var sessid=null;
		if(GLOBAL_APP_VERS.type == "web_mobile"){
			sessid = getCookie("m_auth");
		}
		else
		if(GLOBAL_APP_VERS.type == "app_mobile"){
			sessid = window.localStorage.getItem("auth");
		}
		return sessid;
	}
	function show_popup(type, text, page_id){
		if(!page_id)
				var page_id = $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id");
		if(type == "fast_ntfy"){ //быстрый нотифай. В приложении можно юзать нативный нотифай
			var html='<div data-role="popup" data-overlay-theme="b"  id="popup_window" class="ui-content" style="max-width:280px; z-index:99;">';
				html+='<p>'+text+'</p></div>';
			
			var popup_obj=$("#" +page_id).append(html);
			$( "#popup_window" ).popup();
			$( "#popup_window" ).popup( "open", {PositionTo : "window"} );

			Environment.System.popupclose_timeout_id= setTimeout(function(){
			if($( "#popup_window" )!=null){
				$( "#popup_window" ).fadeOut(400);
				setTimeout(function(){$( "#popup_window" ).popup( "close")},500);
			}
			},3000);
			
		}
		else{ //обычный попап
			var html='<div data-role="popup"  id="popup_window" class="ui-content" style="max-width:280px; z-index:99;"><a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Закрыть</a>';
				html+='<p>'+text+'</p></div>';
			var popup_obj=$("#" +page_id).append(html);
			$( "#popup_window" ).popup();
			$( "#popup_window" ).popup( "open", {PositionTo : "window"} );
			if(type=='ajax not complited'){
				Environment.System.popupclose_timeout_id= setTimeout(function(){
				if($( "#popup_window" )!=null){
					$( "#popup_window" ).fadeOut(400);
					setTimeout(function(){$( "#popup_window" ).popup( "close")},500);
				}
				},5000);
			}
		}
	}
	
	//вход
	function gl_auth(login, pass, remember){
		$.get( LS_wo("login.php"), { uid: login, passwd: pass, remember_zun : remember, token: "z" }, 
			function( data ) {
				if(data.auth_status=="success"){ 
					console.log(JSON.stringify(data));
					if(data.sessid){
						console.log("Устанавливаем сессию "+data.sessid);
						set_session({uid: login, passwd: pass, remember: remember}, data.sessid);					
						refresh_ui();
					}					

				}
				else{
					clear_sessid();
					show_popup("error", data.error_txt, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
				}
			},
			"json"
		);
	}
	//выход
	function gl_logout(){
		var sessid = get_session();
		$.get( LS("logout.php"), { PHPSESSID: sessid}, 
				function( data ) {
					if(data.logout_status=="success"){
						//Отписываемся от событий
						realplexor.unsubscribe("u"+User.I.id);
						realplexor.execute();
						//выходим
						clear_sessid();
						$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_auth") );						
						console.log("Сессия удалена" + JSON.stringify(data));
						NavLefPanel.turnOff();
						window.location.reload()
						
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						clear_sessid();
						$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_auth") );
					}
				},
				"json"
			);
	}
	
	
	function music_play(path){
		
	}
	
	//-------------------------------------------------------------------------------------Объекты приложения
	NavLefPanel = new Object({
		turnOff : function(){
			var html_='<h2>Меню</h2><p>Вы не вошли под своим аккаунтом на Шах-Даг</p>';
			html_ += '<p><a href="#page_auth"  data-transition="slide" data-icon="lock" class="ui-btn ui-shadow ui-corner-all ui-btn-b nav-login">Войти</a></p>';
			$("#left_panel").html(html_);
			console.log("Отработал объект NavLeftPanel. закрытие");
		},
		turnOn : function(req_obj){
			//обновление панели
			var html_left_panel='';
				html_left_panel+='<div class="user-info-wrapper">';
				html_left_panel+='	<div class="nav-home user-avatar-wrapper" user_id="'+User.I.id+'"><img src="'+User.html.avatar_url(User.I.foto, 60)+'" class="user-avatar-circle"></div>';
				html_left_panel+='	<div class="nav-home user-name-wrapper" user_id="'+User.I.id+'">'+User.html.online_status(User.I, "tiny")+' '+User.I.name+'</div>';
				html_left_panel+='	<div class="nav-home user-buttons-wrapper"><input type="button" data-icon="gear" data-iconpos="notext"  data-inline="true" data-mini="true" id="nav-settings" value="Настрокйи"> <input type="button" data-iconpos="notext" data-icon="power"  data-inline="true"  data-mini="true" class="cl_nav-logout" value="Выход"></div>';
				html_left_panel+='</div>';
				
				
				html_left_panel+='<ul data-role="listview" id="nav-listview1" class="ui-nodisc-icon ui-alt-icon">';
				html_left_panel+=' <li class="nav-news"><a href="#home" ><i class="fa fa-home"></i> Мои новости</a> <span class="ui-li-count b" style="display: none;"></span></li>';
				html_left_panel+=' <li class="nav-msg"><a href="#page_msg1" ><i class="fa fa-envelope"></i> Мои сообщения</a> <span class="ui-li-count b" style="display: none;"></span></li>';
				html_left_panel+=' <li class="nav-fotos"><a href="#home" ><i class="fa fa-camera"></i> Мои фотографии</a> <span class="ui-li-count b" style="display: none;"></span></li>';
				html_left_panel+=' <li class="nav-music" user_id="'+User.I.id+'"><a > <i class="fa fa-music"></i> Моя музыка</a> <span class="ui-li-count b" style="display: none;"></span></li>';
				html_left_panel+=' <li class="nav-friends"><a > <i class="fa fa-users"></i> Мои друзья</a> <span class="ui-li-count b" style="display: none;"></span></li>';
				
				html_left_panel+='</ul>';
				//друзья онлайн и пользователи онлайн
				html_left_panel+='<div class="friends-div"><div class="friends-online"><div class="ui-bar ui-bar-b"><h2><i class="fa fa-circle user-online"></i> Друзья онлайн (<span>0</span>)</h2></div><ul data-role="listview">';
				html_left_panel+='</div></ul></div>';
				//пользователи онлайн
				html_left_panel+='<div class="users-div"><div class="friends-online"><div class="ui-bar ui-bar-b"><h2><i class="fa fa-circle user-online"></i> Люди онлайн (<span>0</span>)</h2></div><ul data-role="listview">';
				html_left_panel+='</div></ul></div>';

				$("#left_panel").html(html_left_panel);
				$( "#nav-listview1" ).listview();
				$( ".cl_nav-logout" ).button();
				$( "#nav-settings" ).button();
				
				//adding events
				$( ".cl_nav-logout" ).on( "vclick", function() {
					gl_logout();
				});
				$( "#left_panel .user-avatar-wrapper, .user-name-wrapper" ).on( "vclick",  UserPage.Go); 
				$( "#nav-listview1 .nav-music" ).on( "vclick",  Music.GoUserMusic); 
				$( "#nav-listview1 .nav-news" ).on( "vclick",  Evants.Go);
				$("#left_panel").on("panelbeforeopen", NavLefPanel.Handlers.onOpen);
		},
		Users : {
			html : function(users_obj){
				var html="";
				$.each(users_obj, function(key,obj){
					html+='<li class="ui-shadow" id="userlist_'+obj.id+'" user_id="'+obj.id+'">';
					html+='<div class="foto"><img src="'+User.html.avatar_url(obj.foto,60)+'" class="user-avatar-rounded" user_id="'+obj.id+'"></div>';
					html+='<div class="name"><h2>'+User.html.online_status(obj, "tiny")+" "+ User.html.gender(obj)+ " " + obj.name+'</h2>'; 
					html+='<a user_id="'+obj.id+'" class="ui-btn ui-btn-b ui-btn-inline ui-mini ui-btn-icon-notext ui-icon-envelope kvadro-btn userlist_amsg" >Сообщение</a>';
					html+="<div class='info_1'>";
					if(obj.city)
						html+="Живет в: "+obj.city+"<br>";
					if(obj.nation_id>0)
						html+="Народность: "+Environment.Nations.nation_by_id(obj.nation_id).nationality+"<br>";	
					else
					if(obj.resp)
						html+="Родом из: "+obj.resp+" ";	
					html+='</div>';
					html+='</div><div style="clear: left"></div></li>';
				});
				return html;
			},
			display : function(users_obj, variant) {
				var total = users_obj.total;
				//если нужно отобразить друзей онлайн
				if(variant == "friends_online"){
					if(total>0){
						$("#left_panel .friends-div .friends-online").css({display: "block"});
						$("#left_panel .friends-div .friends-online h2 span").html(total);
						$("#left_panel .friends-div .friends-online ul").html(NavLefPanel.Users.html(users_obj.list));
						$("#left_panel .friends-div .friends-online ul").listview();
					}
					else{
						$("#left_panel .friends-div .friends-online h2 span").html("0");
						$("#left_panel .friends-div .friends-online").css({display: "none"});
					}
				}
				else	
				if(variant == "users_online"){
					if(total>0){
						$("#left_panel .users-div .friends-online").css({display: "block"});
						$("#left_panel .users-div .friends-online h2 span").html(total);
						$("#left_panel .users-div .friends-online ul").html(NavLefPanel.Users.html(users_obj.list));
						$("#left_panel .users-div .friends-online ul").listview();
					}
					else{
						$("#left_panel .users-div .friends-online h2 span").html("0");
						$("#left_panel .users-div .friends-online").css({display: "none"});
					}
				}
				//добавляем обработчики
				$( "#left_panel .user-avatar-rounded" ).off( "vclick"); 
				$( "#left_panel .user-avatar-rounded" ).on( "vclick",  UserPage.Go); 
				//Обработчики кнопок
				$( "#left_panel .userlist_amsg").on( "vclick", function (ev){
					ev.preventDefault();
					NavMsg.OpenDialog($(this).attr("user_id"))
				});
			},
			//отображалка для всех пользователей онлайн с подргрузкой данных с сервера
			display_all : function(){
				var total = Environment.OnlineUsers.total;
				if(total>0){
					$("#left_panel .users-div .friends-online").css({display: "block"});
					$("#left_panel .users-div .friends-online h2 span").html(total);
					$.get( LS("refresh_ui.php"), {method : "refreshOnline"}, 
						function( data ) {
							console.log(data);
							if(data.auth_status=="success" ){
								if(data.method_status=="success"){
									Environment.OnlineUsers = data.online_users;
									NavLefPanel.Users.display(Environment.OnlineUsers, "users_online");
								}								
							}
							
						},
						"json"
					);
				}
				else{
					$("#left_panel .users-div .friends-online h2 span").html("0");
					$("#left_panel .users-div .friends-online").css({display: "none"});
				}
			}
			
		},
		Handlers : {
			onOpen : function(){
				//обновляем визуализацию списка друзей онлайн
				NavLefPanel.Users.display(Environment.Friends.online, "friends_online");
				//обновляем визуализацию всех пользователей онлайн
				NavLefPanel.Users.display_all();
			}
		},
		Ntfy : {
			obj : {evants: 0, friends: 0, board: 0, msg: 0},			
			grab : function(){
				if(Evants.new_!=null){
					NavLefPanel.Ntfy.obj.evants=Evants.new_.fotos+Evants.new_.music+Evants.new_.clips;
				}
				NavLefPanel.Ntfy.obj.msg = NavMsg.Utils.count_new();
			},
			display: function(){
				var btn_left_count=0;
				//------левая панель
				//обновления
				if(NavLefPanel.Ntfy.obj.evants>0){
					$(".nav-news .ui-li-count").css({display: "block"});
					$(".nav-news .ui-li-count").html(NavLefPanel.Ntfy.obj.evants);
					btn_left_count=btn_left_count+NavLefPanel.Ntfy.obj.evants;
				}
				else{
					$(".nav-news .ui-li-count").css({display: "none"});
					$(".nav-news .ui-li-count").html(null);
				}
				//сообщения
				if(NavLefPanel.Ntfy.obj.msg>0){
					$(".nav-msg .ui-li-count").css({display: "block"});
					$(".nav-msg .ui-li-count").html(NavLefPanel.Ntfy.obj.msg);
				}
				else{
					$(".nav-msg .ui-li-count").css({display: "none"});
					$(".nav-msg .ui-li-count").html(null);
				}
				
				//-----добавляем счетчики на кнопки топ меню
				//кнопка левого меню
				if(btn_left_count>0)
					$('.topmenu-left').badger(btn_left_count.toString());
				else
					$('.topmenu-left').badger('');
				//кнопка сообщений
				if(NavLefPanel.Ntfy.obj.msg>0){
					$('.topmenu-msg').badger(NavLefPanel.Ntfy.obj.msg.toString());
				}
				else{
					$('.topmenu-msg').badger('');
				}
			},
			refresh : function(){
				NavLefPanel.Ntfy.grab();
				NavLefPanel.Ntfy.display();
			}
		}
	});

	NavMsg = new Object({
		MsgListObj : Object(), //список диалогов
		ActiveDialogObj : Object(), //активная переписка
		ActiveUser : Object(),
		loading_data : 0,
		D_el_per_page: 32,
		D_total_all : 0,
		D_params: Object(),
		initDialog : function(){
			NavMsg.loading_data=0;
			NavMsg.D_el_per_page=32;
			NavMsg.D_total_all=0;
			NavMsg.ActiveDialogObj = new Object();
			NavMsg.ActiveUser = new Object();
			//очищаем стек выделенных сообщений и добавляем событие на клик
			NavMsg.Utils.stack = new Array();
			NavMsg.D_params = new Object();
			
		},
		GoDialogs : function(){
			$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_msg") );
			//NavMsg.LoadMsgList(NavMsg.MsgListObj);
		},
		//Полная прорисовка диалога сообщений
		LoadMsgList : function (msgObj){
			//$("#debug_div").append("<br> loading MsgList");
			var i=0;
			var html_count_new=null;
			NavMsg.MsgListObj=msgObj;
			var html_='<ul data-role="listview" data-count-theme="b"  id="nav-msg-list">';
			$.each(msgObj, function(key, obj){
				if(msgObj[i].message.count_new>0){
					html_count_new='<span class="ui-li-count b" style="display: block;">'+ msgObj[i].message.count_new +'</span>';
				}
				else
					html_count_new='<span class="ui-li-count" style="display: none;"></span>';
				html_+='<li class="ui-shadow" id="nav-msg-list-li_'+msgObj[i].user.id+'" user_id="'+msgObj[i].user.id+'">';
				html_+='<img src="'+User.html.avatar_url(msgObj[i].user.foto,60)+'" class="user-avatar-rounded">';
				html_+='<h2>'+msgObj[i].user.name+' '+html_count_new+'</h2>'; 
				html_+='<p>'+ msgObj[i].message.text +'</p>';
				
				html_+='</li>';
				i++;
			});
			
			html_+='</ul>';
			$("#msg-list").html(html_);
			$( "#nav-msg-list" ).listview();
			//привязываем событие на клик
			i=0;
			$.each(msgObj, function(key, obj){
				$( "#nav-msg-list-li_"+msgObj[i].user.id ).on( "click", function(ev){
					ev.preventDefault();
					NavMsg.OpenDialog($(this).attr("user_id"));
					//console.log($(this).attr("user_id"));
				});
				i++;
			});
			//обрабатываем новые сообщения
			NavMsg.Utils.refresh_notification();
		},
		//обработка входящего comet сообщения. объект имеет такую же структуру что и NavMsg.MsgListObj
		RplIncome : function(data){
			var msgObj = new Object();
			//msgObj.sender_user=data.sender_user;
			//msgObj.message=data.msg;
			NavMsg.Utils.process_add(data, "income");
			
			//------------ если открыта страница переписки с пользоваталем то добавляем сообщение
			if($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_msg2"){
				//если сообщение пришло от пользователя с текущего диалога
				if($("#nav-sendmsg-btn").attr("send_to") == data.from.id){
					NavMsg.SingleMessage.Add(data,"prepend");
					//обнуляем счетчик новых сообщений
					NavMsg.MsgListObj[0].message.count_new=0;
					//очищаем оповещение на сервере
					NavMsg.Utils.clearNtfy(data.from.id);
					//добавляем сообщение в массива
					NavMsg.ActiveDialogObj.unshift(data.message);
				}
				else{
					//$('.topmenu-msg').badger('3');
				}
			}
			//озвучиваем сообщение
			Audio_.income_msg.play();
			//обрисовываем список диалогов
			NavMsg.LoadMsgList(NavMsg.MsgListObj);
			
			
		},
		OpenDialog : function(retrievers_id){
			//очищаем предыдущую переписку
			$("#dialog-msg-list").remove();
			NavMsg.initDialog();
			$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_msg2") );
			//загружаем данные с сервера и прорисовываем
			NavMsg.D_params={ method: "getMessages", 
							retrievers_id: retrievers_id, 
							initial: 1, 
							el_per_page : NavMsg.D_el_per_page,
							last : 0
							};
			NavMsg.getDialogFromServer(retrievers_id, NavMsg.D_params);
			//обновляем ссылки, кнопки и тд
			$("#nav-sendmsg-btn").attr("send_to", retrievers_id); //меняем парметр кнопки
			//обновляем счетчик
			var obj_index=NavMsg.Utils.get_dialog_index(retrievers_id);
			if(obj_index>=0){
				NavMsg.MsgListObj[obj_index].message.count_new=0;
				NavMsg.LoadMsgList(NavMsg.MsgListObj);
			}
			
		}, 
		getDialogFromServer : function(user_id, params){
			$("#debug_div").append("<br> loading messages");
			NavMsg.loading_data=1;
			$.get( LS("server/proc_msg.php"), params, 
				function( data ) {
					var sender_user;
					var retruever_user;
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							NavMsg.D_total_all = data.total_all;
							NavMsg.D_params = params;
							NavMsg.ActiveUser = data.retriever_user;
							
							//если первая загрузка
							if(params.initial == 1){
								NavMsg.AppendMsg(data);
								NavMsg.ActiveDialogObj = data.messages;
							}
							//Если запрос отправлен для догрузки сообщений
							else{
								NavMsg.ActiveDialogObj=NavMsg.ActiveDialogObj.concat(data.messages);
								$.each(data.messages,  function (i, message){
									if(data.i_user.id==message.senders_id){
										sender_user= data.i_user;
										retriever_user = data.retriever_user;
									}
									else{
										sender_user= data.retriever_user;
										retriever_user = data.i_user;
									}
									if(i>0){
										if(how_long_time(timestamp2date(message.time)).day!=how_long_time(timestamp2date(data.messages[i-1].time)).day){ //время отправки сообщения
											$("#dialog-msg-list").append("<div class='daysdevider'>"+how_long_time(timestamp2date(message.time)).day+"</div>");
										}
									}
									NavMsg.SingleMessage.Add({message: message, sender_user: sender_user, retriever_user: retriever_user},  "append");
									//console.log(message); 
								}); 
							}
							console.log("Получен ответ со списком диалогов" + JSON.stringify(data));
							
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
					NavMsg.loading_data=0;
				},
				"json"
			)
			.fail(function(){
					NavMsg.loading_data=0;
				});
		},
		GoAppendDialog : function(){ //отрабатывает для догрузки данных
			$("#debug_div").append("<br> scrolling handled messages"+JSON.stringify(params));
			var params=NavMsg.D_params;
			if(NavMsg.ActiveDialogObj.length<NavMsg.D_total_all){
				params.last=NavMsg.ActiveDialogObj.length;
				params.initial=0;
				NavMsg.getDialogFromServer(NavMsg.ActiveUser.id, params);
			}
		},
		//загрузка списка переписки из объекта
		AppendMsg : function(msg_obj){  
			var html_="";
			var i=0;
			var user = new Object();
			html_+='<div  id="dialog-msg-list">';
			$.each(msg_obj.messages, function(key,obj){
				if(i>0){
					if(how_long_time(timestamp2date(msg_obj.messages[i].time)).day!=how_long_time(timestamp2date(msg_obj.messages[i-1].time)).day){
						html_+="<div class='daysdevider'>"+how_long_time(timestamp2date(msg_obj.messages[i].time)).day+"</div>";
					}
				}
				html_+=NavMsg.SingleMessage.getHTML(msg_obj.messages[i], msg_obj.i_user, msg_obj.retriever_user);
				i++;
			});
			html_+='</div>';
			
			$("#msg-with-user").append(html_);
			//меняем заголовок страницы
			$("#page_msg2 .topheader h1").html(User.html.online_status(msg_obj.retriever_user,"tiny")+ " "+msg_obj.retriever_user.name);
			$("#page_msg2 .topheader h1").attr("user_id", msg_obj.retriever_user.id);
			//добавляем смайлы и тд к полученной переписке
			$("#page_msg2 .talktext p").text2richtext(); 
			$("#page_msg2 .talk-bubble").on("vclick", NavMsg.Utils.onSelect);
			
			
		},
		SendMsgHandler : function (send_to){
			var msg_text=$("#nav-msg-txtarea").val();
			$("#nav-msg-txtarea").val("");
			$.get( LS("server/proc_msg.php"), { method: "postMessage", retrievers_id: send_to, "msg" : msg_text}, 
				function( data ) {
					if(data.auth_status=="success"){
						if(data.method_status=="success"){
						//рисуем диалог
							NavMsg.SingleMessage.Add(data, "prepend");
							//обработка обновления спиков диалогов и переписки
							NavMsg.Utils.process_add(data, "outcome");
							//добавляем сообщение в массива
							NavMsg.ActiveDialogObj.unshift(data.message);
							//обновляем диалоги
							NavMsg.LoadMsgList(NavMsg.MsgListObj);
							//звуковое сопровождение
							Audio_.outcome_msg.play();
							console.log("SendMsgHandler. Получен ответ " + JSON.stringify(data));	
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{ 
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
						console.log("SendMsgHandler");
				},
				"json"
			);
		},
		SingleMessage : Object({ 
			getHTML : function(singleMsgObj, SenderObj, RetrieverObj){
				var html_="";
				var user = new Object();
				if(singleMsgObj.senders_id==SenderObj.id){
					user=SenderObj;
				}
				else{
					user=RetrieverObj;
				}
				html_+="<div id='msg_"+singleMsgObj.num+"'>";
				if(user.id==User.I.id){
					html_+='<div style="float:right"><img src="'+User.html.avatar_url(user.foto,60)+'" class="user-avatar-rounded"></div>';
					html_+='<div class="talk-bubble me tri-right round right-in" style="float:right"  msg_id="'+singleMsgObj.num+'">';
					}
				else{
					html_+='<div style="float:left"><img src="'+User.html.avatar_url(user.foto,60)+'" class="user-avatar-rounded"></div>';
					html_+='<div class="talk-bubble another tri-right round left-in" msg_id="'+singleMsgObj.num+'">';
					}
				html_+='		<div class="talktext">';
				html_+='		<div class="options">'+how_long_time(timestamp2date(singleMsgObj.time)).msg_label+'</div>';
				html_+='			<p>'+ singleMsgObj.text +'</p>';
				html_+='		</div>';
				html_+='</div>';
				html_+="</div>";
				html_+='<div style="clear:both"></div>';
				return html_;
			},
			Add : function(responseMethodObj, append_type){
				var new_msg_dom= new Object();
				if(append_type == "prepend"){
					$("#dialog-msg-list").prepend(NavMsg.SingleMessage.getHTML(responseMethodObj.message, responseMethodObj.sender_user, responseMethodObj.retriever_user));
					$.mobile.silentScroll(0);
				}
				else
				if(append_type == "append"){
					$("#dialog-msg-list").append(NavMsg.SingleMessage.getHTML(responseMethodObj.message, responseMethodObj.sender_user, responseMethodObj.retriever_user));
				}

				new_msg_dom=$("#msg_"+responseMethodObj.message.num+" .talktext p");
				new_msg_dom.text2richtext();
				//добавляем эффект
				clickEffect1($("#msg_"+responseMethodObj.message.num+" .talk-bubble"));
				//обработчики клика на сообщение
				$("#msg_"+responseMethodObj.message.num+" .talk-bubble").on ( "vclick", NavMsg.Utils.onSelect);
			}
		}),
		Delete :{
			//Выполняется при клике на кнопки удаления
			Do: function(){
				var del_type=$(this).attr("del_type"); //dialog - активный диалог с пользоваталем; all - все диалоги; selected - выбранные сообщения диалога
				var params = new Object();
				var error=0;
				if(del_type=="selected"){
					if(NavMsg.Utils.stack.length>0){
						var track_num = NavMsg.Utils.stack.join(",");
					}
					else
						error=1;
					params = {base: "messages", track_num: track_num, del_type : del_type};
				}
				else
				if(del_type=="dialog"){
					params = {base: "messages", track_num: "all", track_num2: $( "#nav-sendmsg-btn").attr("send_to"), del_type : del_type};
				}
				if(!error){
					$.get( LS("server/proc_delete.php"), params, 
						function( data ) {
							if(data.auth_status=="success"){
								if(data.method_status=="success"){
								//обрабатываем успешное удаление
									NavMsg.Delete.Handle(params);
								}
								else{
									show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
								}
								
							}
							else{ 
								console.log("Сессия не существует на сервере." + JSON.stringify(data));	
								gl_logout();
							}
							
						},
						"json" 
					);
				}
			},
			//манипуляция с интерфейсом после успешного удаления с сервера
			Handle : function(params){
				if(params.del_type=="selected"){
					var stack = params.track_num.split(",");
					var i=0;
					for(i=0;i<stack.length;i++){
						$("#msg_"+stack[i]).remove();
						//удаляем из объекта переписки
						var found_msg = NavMsg.Utils.get_message_index(stack[i]);
						if(found_msg>=0){
							NavMsg.ActiveDialogObj.splice(found_msg,1);
						}
						NavMsg.Utils.refresh_MsgList();
					}
					NavMsg.Utils.stack = new Array();
					$("#page_msg2-trashbutton").css({display : "none"});
					$("#page_msg2-trashbutton i").html("");	
					//синхронизируем панели
					/*
					if($("#page_msg2 div[data-role=header]").toolbar("option", "tapToggle")==false){
						$("#page_msg2 div[data-role=header]").toolbar("option", "tapToggle", true)
						$("#page_msg2 div[data-role=footer]").toolbar("option", "tapToggle", true)
						
					}
					*/
				}
				else
				if(params.del_type=="dialog"){
					$("#dialog-msg-list").html(""); 
					$("#page_msg2_confirm_delete").popup("close");
					//удаляем из объекта переписки
					NavMsg.ActiveDialogObj = new Object();
					NavMsg.Utils.refresh_MsgList(); 
				}
				//
				NavMsg.LoadMsgList(NavMsg.MsgListObj);
				
			}
			
		},
		Utils : {
			count_new : function(){
				var i=0;
				var total=0;
				$.each(NavMsg.MsgListObj, function(key,obj){
					if(NavMsg.MsgListObj[i].message.count_new>0)
						total=total+parseInt(NavMsg.MsgListObj[i].message.count_new);
					i++;
				});
				return total;
			},
			process_add : function(msgObj, type){
				var found_i = -1;
				var newDialogMsg = new Object();
				if(type=="income"){
					newDialogMsg.user=msgObj.sender_user;
					newDialogMsg.message=msgObj.message;
					newDialogMsg.message.count_new=1;
					if(NavMsg.MsgListObj.length>0){
						found_i = NavMsg.Utils.get_dialog_index(msgObj.sender_user.id);
						if(found_i>=0){
							NavMsg.MsgListObj[found_i].message.count_new++;
							NavMsg.MsgListObj[found_i].message.text=msgObj.message.text;
							//поднимаем диалог вверх
							NavMsg.MsgListObj.unshift(NavMsg.MsgListObj[found_i]);
							NavMsg.MsgListObj.splice(found_i+1,1);
						}
						//иначе добавляем объект в начало массива сообщений
						else{
							NavMsg.MsgListObj.unshift(newDialogMsg);
						}	
					}
					//если список пустой, то добавляем первое сообщение
					else{
						NavMsg.MsgListObj.unshift(newDialogMsg);
					}
				}
				if(type=="outcome"){
					newDialogMsg.user=msgObj.retriever_user;
					newDialogMsg.message=msgObj.message;
					newDialogMsg.message.count_new=0;
					if(NavMsg.MsgListObj.length>0){
						found_i = NavMsg.Utils.get_dialog_index(msgObj.retriever_user.id);
						if(found_i>=0){
							NavMsg.MsgListObj[found_i].message.count_new=0;
							NavMsg.MsgListObj[found_i].message.text=msgObj.message.text;
							//поднимаем диалог вверх
							NavMsg.MsgListObj.unshift(NavMsg.MsgListObj[found_i]);
							NavMsg.MsgListObj.splice(found_i+1,1);
						}
						//иначе добавляем объект в начало массива сообщений
						else{
							NavMsg.MsgListObj.unshift(newDialogMsg);
						}	
					}
					//если список пустой, то добавляем первое сообщение
					else{
						NavMsg.MsgListObj.unshift(newDialogMsg);
					}
				}
			},
			
			refresh_notification: function(){
				NavLefPanel.Ntfy.refresh();
			},
			get_dialog_index: function(user_id){
				var found_i=-1;
				var i=0;
				$.each(NavMsg.MsgListObj, function(key, obj){
					//если входящее сообщение из существующего списка то обновляем счетчик
					if(NavMsg.MsgListObj[i].user.id==user_id){
						found_i=i;
					}
					i++;
				});
				return found_i
			},
			get_message_index: function(msg_num){
				var found_i=-1;
				var i=0;
				$.each(NavMsg.ActiveDialogObj, function(key, obj){
					//если входящее сообщение из существующего списка то обновляем счетчик
					if(obj.num==msg_num){
						found_i=i;
					}
					i++;
				});
				return found_i
			},
			stack : Array(),
			onSelect : function(){ //при клике на textbubble
				$("#debug_div").append("<br> selecting message");
				var msg_id = $(this).attr("msg_id");
				var stack_pos = -1;
				stack_pos = NavMsg.Utils.stack.indexOf(msg_id);
				//если есть то удаляем
				if(stack_pos>=0){
					NavMsg.Utils.stack.splice(stack_pos,1);
					$("#msg_"+msg_id+" .talk-bubble").removeClass("selected");
				}
				else
				//если нет то добавляем
				{
					NavMsg.Utils.stack.push(msg_id);
					$("#msg_"+msg_id+" .talk-bubble").addClass("selected");
				}
				//рисуем кнопку удаления
				if(NavMsg.Utils.stack.length>0){
					$("#page_msg2-trashbutton").css({display : "inline-block"});
					$("#page_msg2-trashbutton i").html(NavMsg.Utils.stack.length);	
				}
				else{
					$("#page_msg2-trashbutton").css({display : "none"});
					$("#page_msg2-trashbutton i").html("");	
					/*
					//синхронизируем панели
					if($("#page_msg2 div[data-role=header]").toolbar("option", "tapToggle")==false){
						$("#page_msg2 div[data-role=header]").toolbar("option", "tapToggle", true)
						$("#page_msg2 div[data-role=footer]").toolbar("option", "tapToggle", true)
						
					}
					*/
				}
			},
			clearNtfy : function(user_id){	//удаляет оповещения о сообщениях на сервере
				$.get( LS("server/proc_msg.php"), { method: "clearDialogNtfy", retrievers_id: user_id}, 
					function( data ) {
						if(data.auth_status=="success" ){
							if(data.method_status=="success"){
								console.log("Оповещения на сервере удалены");
								
							}
							else{
								show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
							}
							
						}
						else{
							console.log("Сессия не существует на сервере." + JSON.stringify(data));	
							gl_logout();
						}
					},
					"json"
				);
			},
			confirm : function(){ //вызывает окноп подтверждения для удаления всех сообщений
				console.log($(this).attr("option_type"));
				if($(this).attr("option_type")=="delete_all"){
					$("#page_msg2_menu").popup("close");
					setTimeout(function(){$("#page_msg2_confirm_delete").popup("open")},500);
				}
				else
				if($(this).attr("option_type")=="ban"){
					$("#page_msg2_menu").popup("close");
				}
				
			},
			keyPress : {
				last : 0,
				send_handler : function(){
					var press_time = Date.now();
					if((NavMsg.ActiveUser.id>0) && (press_time-NavMsg.Utils.keyPress.last)>2000){ //бльше 1 сек прошло с последней отправки
						NavMsg.Utils.keyPress.last = press_time
						$.get( LS("server/proc_typing.php"), {retrievers_id: NavMsg.ActiveUser.id}, 
							function( data ) {
								if(data.auth_status=="success" ){
									if(data.method_status=="success"){
										console.log("отправка события");
										
									}
									else{
										console.log("ошибка метода");
									}
									
								}
								else{
									console.log("ошибка авторизации");
								}
							},
							"json"
						);
					}
					else
						console.log("Пропускаем");
				},
				rec_handler : function(data){
					if(data.type=="typing"){
						if(($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_msg2") && (NavMsg.ActiveUser.id == data.from.id)){
							$("#page_msg2_typing").css({display : "block"});
							setTimeout(function(){
								$("#page_msg2_typing").css({display : "none"});
							},2000);
						}
					}
				}
			
			},
			refresh_MsgList : function(){ //обновляет список диалогов после манипуляций с активной перепиской
				var user_id = NavMsg.ActiveUser.id;
				var found_i = NavMsg.Utils.get_dialog_index(user_id);
				var total_msg = NavMsg.ActiveDialogObj.length;
				if(found_i>=0){
					if(total_msg>0){
						NavMsg.MsgListObj[found_i].message.text=NavMsg.ActiveDialogObj[0].text;
						
					}
					else{
						NavMsg.MsgListObj.splice(found_i,1);
					}
				}
			}			
		}
		
	});

	UserPage = new Object({
		Go : function (ev){
			ev.preventDefault();
			//если переход из PS то сначала закрываем его
			if (typeof photoSwipeInstance != "undefined" && photoSwipeInstance != null) { 
				if(Fotos.PS.isShown){
					photoSwipeInstance.hide();
				}
			}
			
			UserPage.GoId($(this).attr("user_id"));
		},
		GoId : function(user_id){
			UserPage.Load(user_id);
		},
		Load : function(user_id){
			$.get( LS("server/proc_user.php"), { method: "getPage", user_id: user_id}, 
				function( data ) {
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							//рисуем диалог
							UserPage.Display(data);
							console.log("go to user page");
							
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
				},
				"json"
			);
		},
		Display: function(resp_obj){ 
			var html="";
			//прорисовываем страницу
			//----имя
			html='<h3 class="ui-bar ui-bar-a ui-corner-all">'+User.html.gender(resp_obj.user)+resp_obj.user.name+' '+User.html.online_status(resp_obj.user, "user_page")+'</h3>';
			$("#page_user_name").html(html);
			//----аватарка
			html="<img src='"+User.html.avatar_url(resp_obj.user.foto, 200)+"'>";
			$("#page_user_avatar").html(html);
			//если страница моя, то добавляем кнопку обновления аватарки
			if(resp_obj.user.id==User.I.id){   
				$("#page_user_avatar").append('<div class="file-avatar"><i class="fa fa-plus fa-button-circle"></i> <input  type="file" name="images" id="upload_avatar" accept="image/jpeg,image/png,image/gif" /></div>');
				$("#upload_avatar").on("change", User.Settings.UploadAvatar);
				$("#page_user_avatar .file-avatar").trigger("create");
			}
			else{
				//удаляем кнопку загрузки фотки
				$("#page_user_avatar .file-avatar").remove();
			}
			//----Основная инфа пользователя 
			html="";
			if(resp_obj.user.place!=null){
				html+='<div class="user-page-info-t1">Живет в</div><div class="user-page-info-t2">'+resp_obj.user.place.country+', '+ resp_obj.user.place.city+'</div>';
				
			}
			if(resp_obj.user.origin_from!=null){
				html+='<div class="user-page-info-t1">Родом из</div><div class="user-page-info-t2">'+resp_obj.user.origin_from.resp+', '+ resp_obj.user.origin_from.raion+' р-н, '+ resp_obj.user.origin_from.selo+'</div>';

			}
			if(resp_obj.user.edu!=null){
				html+='<div class="user-page-info-t1">Учеба </div><div class="user-page-info-t2">'+resp_obj.user.edu.vuz_name+' '+resp_obj.user.edu.year+', '+ resp_obj.user.edu.faculty+' фак-т</div>';
			}
			if(resp_obj.user.family_status!=null){
				html+='<div class="user-page-info-t1">Семейное положение </div><div class="user-page-info-t2">'+resp_obj.user.family_status+'</div>';
			}
			$("#page_user_info1").html(html);
			//----Фотки
			html="";
			if(resp_obj.fotos_block.total>0){
				html='<div class="ui-corner-all rounded-corners">';
				html+='<div class="ui-bar ui-bar-a">';
				html+='<h3>Фотографии</h3>'; 
				html+='<div class="ui-btn-right"><a  id="page_user_fotos_allfotos" user_id="'+resp_obj.user.id+'" class="ui-btn ui-btn-inline ui-mini ui-corner-all" >все '+resp_obj.fotos_block.total+'</a></div>';
				html+='</div>';
				html+='<div class="ui-body ui-body-a"><p>';
				var i=0;
				$.each(resp_obj.fotos_block.fotos, function(key,obj){
					html+= "<div class='foto'><img src='"+User.html.fotos_url(resp_obj.fotos_block.fotos[i].path, resp_obj.fotos_block.fotos[i].private_foto, "small")+"'></div>";
					i++;
				});
				html+='</p></div>';
				html+='</div>';
			}
			$("#page_user_fotos").html(html);
			$( "#page_user_fotos_allfotos" ).on( "vclick",  Fotos.GoUsersFotos);
			//----Друзья
			html="";
			if(resp_obj.friends_block != null){
				if( resp_obj.friends_block.total>0){
					html='<div class="ui-corner-all rounded-corners">';
					html+='<div class="ui-bar ui-bar-a">';
					html+='<h3>Друзья</h3>';
					html+='<div class="ui-btn-right"><a href="#" class="ui-btn ui-btn-inline ui-mini ui-corner-all" >все '+resp_obj.friends_block.total+'</a>';
					if(resp_obj.friends_block.total_joint>0){
						html+='<a href="#" class="ui-btn ui-btn-inline ui-mini ui-corner-all" >общие '+resp_obj.friends_block.total_joint+'</a>';
					}
					if(resp_obj.friends_block.total_online>0){
						html+='<a href="#" class="ui-btn ui-btn-inline ui-mini ui-corner-all" >онлайн '+resp_obj.friends_block.total_online+'</a>';
					}
					html+='</div></div>';
					html+='<div class="ui-body ui-body-a"><p>';
					var i=0;
					$.each(resp_obj.friends_block.limits, function(key,obj){
						html+= "<div class='friend'>";
						html+="<img src='"+User.html.avatar_url(resp_obj.friends_block.limits[i].foto, 100)+"' user_id='"+resp_obj.friends_block.limits[i].id+"' class='user-avatar'>";
						html+="<div>"+User.html.gender(resp_obj.friends_block.limits[i])+" "+User.html.online_status(resp_obj.friends_block.limits[i], "tiny")+" "+resp_obj.friends_block.limits[i].name+"</div></div>";
						i++;
					});
					html+='</p></div>';
					html+='</div>';
				}
			}
			$("#page_user_friends").html(html);
			$( ".friend .user-avatar").on( "vclick", UserPage.Go);
			//Переход на страницу. Если пришли из фотографий, то нужно дать задержку
			/*
			if($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_fotos" || $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id") == "page_usersfotos"){
				setTimeout(function(){
					$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_user"), { transition: "none", allowSamePageTransition: true} )
					$.mobile.silentScroll(0); 
					},300);
			}
			else{*/
				$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_user"), { transition: "none", allowSamePageTransition: true} )
				$.mobile.silentScroll(0); 
			
			console.log(resp_obj); 
		} 
		
	});
	
	User = new Object({
		I : Object(),
		html :{
			gender : function(user_obj){
				if(user_obj.gender=="Ж")
					return '<i class="fa fa-female fa-lg"></i> '
				else
					return '<i class="fa fa-male fa-lg"></i> '
			},
			online_status : function(user_obj, format){
				if(user_obj.online_status.code>0){
					if(format=="user_page")
						return '<div class="user-status user-online"><i class="fa fa-circle fa-lg"></i> <span>'+user_obj.online_status.txt+'</span></div>';
					else
					if(format=="tiny")
						return '<i class="fa fa-circle user-online"></i>';
				}
				else{
					if(format=="user_page")
						return '<div class="user-status user-offline"><i class="fa fa-circle-thin fa-lg"></i> <span>'+user_obj.online_status.txt+'</span></div>';
					else
					if(format=="tiny")
						return '';
				}
			},
			fotos_url : function (path, type, size){
				var p="";
				if(type==1){
					if(size=="small")
						p="small/";
					else
					if(size=="full")
						p="";
					return LLocal("users_fotos/"+p+path);
				
				}
				else
				if(type==0){
					if(size=="small")
						p="small/";
					else
					if(size=="full")
						p="";
					return LLocal("fotos/"+p+path);
				}
				else
					return "no_foto";
			},
			preview_url : function (path, type){
				var p="";
				if(type=="fotos"){
					return LLocal("previews/fotos/"+path);
				
				}
				else
				if(type=="music"){
					return LLocal("previews/music/"+path);
				
				}
				else
					return "no_foto";
			},
			avatar_url: function(path,size){
				if(size==60){
					return LLocal("avatars/small/"+path);
				}
				else
				if(size==40){
					return LLocal("avatars/small/small/"+path);
				}
				else
				if(size==100){
					return LLocal("avatars/small_100/"+path);
				}
				else{
					return LLocal("avatars/"+path);
				}
			},
			mark_icon :function(mark_val){
				if(mark_val=="+" || mark_val=="++") 
					return '<i class="fa fa-thumbs-o-up" style="color: rgb(32, 163, 32);"></i>';
				else
				if(mark_val=="-")
					return '<i class="fa fa-thumbs-o-down" style="color: rgb(237, 81, 81);"></i>';
			},
			translate : function (user, lang, word){
				if(lang=="ru"){
					if(user.gender == 'М')
						return word;
					else
						return word+'а';
				}
			},
			gift_url : function(path){
				return LLocal("gifts/"+path);
			}
		},
		Settings : {
			UploadAvatar : function(ev){
				var	len = this.files.length; 
				var file;				
				var formdata = new FormData();
				for ( i=0; i < len; i++ ) {
					file = this.files[i];
					console.log(this.files[i]);
					//alert(JSON.stringify(file));
					if (getFileExt(file.name)=="jpg" || getFileExt(file.name)=="jpeg" || getFileExt(file.name)=="png" ||  getFileExt(file.name)=="gif") {
						if (formdata) {
							formdata.append("userfile", file);
							formdata.append("method", "setAvatar");
							$.ajax({
								url: LS("server/proc_settings.php"),
								type: "POST",
								data: formdata,
								processData: false,
								contentType: false,
								success: function (res) {
									var data;
									data = JSON.parse(res); 
									if(data.auth_status == "success"){	
										if(data.method_status == "success"){
											$("#page_user_avatar img").attr("src", User.html.avatar_url(data.src, 200)); 
										}
										else
											show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
									} 
									else{
										console.log(data);	
										gl_logout();
									}
									console.log(data);
								}
							});
						}
					}
					else{
						show_popup("message_not_sent", "Фотография должна быть формата jpg/gif/png", $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
					}
				}
			}
		}
	});
	//Music
	Music = new Object({
		list : Object(),
		active_user : Object(),
		el_per_page : 32,
		loading_data : 0,
		total_all: 0,
		url_params : Object(),
		init : function(){
			Music.list = new Array();
			Music.el_per_page = 32;
			Music.loading_data =0;
			Music.total_all = 0;
			Music.url_params = new Object();
			Music.Filter = Music.constructFilter();
			
		},
		constructFilter : function(){
			return {
				searchterm: null,
				nation_id: null,
				order: null
			}
		},
		GoUserMusic : function (){
			var user_id = $(this).attr("user_id");
			Music.GoAll({user_id: user_id},1);
				
		},
		GoAll : function (filter, init){
			var params;
			if(init==1){
				Music.init();
				if(filter==null || filter.user_id==null){
					//показываем навбар
					$("#page_music .navbar-public").css({display : "block"});
					Environment.Utils.refresh_public_navbar("#page_music .navbar-public", "btn-music");
				}
				else
				if(filter!=null || filter.user_id!=null){
					$("#page_music .navbar-public").css({display : "none"});
				}
				$("#page_music_list").html("");
				
				$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_music"), { transition: "none", allowSamePageTransition: true} );
				Music.link.SearchForm.hide();
			}
			
			$.mobile.silentScroll(0);
			//устанавливаем фильтры
			if(filter!=null){
				Music.Filter=$.extend(Music.Filter, filter);
			}
			//задаем параметры запроса
			params=Music.Filter; 
			params.initial=1;
			params.el_per_page=Music.el_per_page;
			params.method="getMusic";
			params.last=0;
			Music.Load(params);
		},
		Load : function(params){
			Music.loading_data=1;
			$.get( LS("server/proc_music.php"), params, 
				function( data ) {
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							Music.url_params=params;
							Music.total_all=data.total_all;
							//если загрузка инициализирующая
							if(params.initial==1){
								//дополняем список песен
								Music.list=data.musics;
								if(params.user_id)
									Music.active_user = data.user;
								Music.Display(data, params);
								console.log("Load initial Music");
							}
							//если догрузка песен
							else{
								if(data.musics.length>0){
									Music.list=Music.list.concat(data.musics);
									Music.Display(data, params);
									console.log("Load appended Music");
								}
							}
							
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
					Music.loading_data=0;
				},
				"json"
			);
		},
		GoAppend : function(){
			var params=Music.url_params;
			if(Music.list.length<Music.total_all){
				params.last=Music.list.length;
				params.initial=0;
				Music.Load(params, 0);
			}
		},
		
		Display: function(resp_obj, params){ 
			var html="";
			var html_menu="";
			var i=0;
			var page_id = $(":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id");
			$.each(resp_obj.musics, function(key,obj){
				html+= "<div class='song-item mus_"+resp_obj.musics[i].num+"'><div class='ui360'><a href='http://media.shaxdag.com/Music/"+resp_obj.musics[i].path+"'>"+resp_obj.musics[i].artist+" "+resp_obj.musics[i].title+"</a></div></div>";
				i++;
			});
			 
			if(params.initial == 1){
				$("#page_music_list").html(html);
				$.mobile.silentScroll(0);
				//меняем заголовок
				if(params.user_id!=null){
					//если моя музыка
					if(params.user_id == User.I.id){
						$("#page_music .topheader h1").html("Моя музыка");
					}
					else{
						$("#page_music .topheader h1").html(User.html.online_status(resp_obj.user,"tiny")+ " "+resp_obj.user.name);
						$("#page_music .topheader h1").attr("user_id", resp_obj.user.id);
					}
				}
				else{
					$("#page_music .topheader h1").html("Музыка");
				}
				
			}
			else{
				$("#page_music_list").append(html);
			}
			console.log(resp_obj);
			threeSixtyPlayer.config.playNext=true;
			threeSixtyPlayer.init();
			//добавляем режим flex
			$.each(resp_obj.musics, function(key,obj){

				$("#"+page_id+" .mus_"+ obj.num).append('<div class="song_title"><div class="title" base="music" t_key="'+obj.num+'">'+obj.artist+' - '+obj.title+'</div></div>');
				$("#"+page_id+" .mus_"+ obj.num).append('<div class="btn-add" base="music" t_key="'+obj.num+'"></div>');
				
				//добавляем кнопки снизу
				html_menu="";
				html_menu+='<div class="nation">'+Environment.Nations.modify(Environment.Nations.nation_by_id(obj.lang).title, "ая")+'</div>';
				html_menu+="<div class='options'>";				
				html_menu+='<a base="music" t_key="'+obj.num+'" mark="plus" class="ui-btn ui-btn-inline ui-mini ui-corner-all ui-icon-thumbs-o-up ui-btn-icon-notext btn-like" >Нравится</a>';
				html_menu+='<a base="music" t_key="'+obj.num+'" mark="minus"  class="ui-btn ui-btn-inline ui-mini ui-corner-all ui-icon-thumbs-o-down ui-btn-icon-notext btn-unlike" >Не нравится</a>';
				html_menu+='<span base="music" t_key="'+obj.num+'" mark="plus" class="rating"></span><span base="music" t_key="'+obj.num+'"  class="btn-comments" ></span>';				
				html_menu+="</div>";
				
				$("#"+page_id+" .mus_"+ obj.num+" .song_title").append(html_menu);				
				Music.link.refresh_like_menu(obj);				
				$("#"+page_id+" .mus_"+ obj.num+" .btn-like, #"+page_id+" .mus_"+ obj.num+" .btn-unlike").on ("vclick", Music.link.Like);
				$("#"+page_id+" .mus_"+ obj.num+" .title, #"+page_id+" .mus_"+ obj.num+" .btn-comments").on ("vclick", Comments.Go);
				$("#"+page_id+" .mus_"+ obj.num+" .rating").on ("vclick", Music.link.Like);
				$("#"+page_id+" .mus_"+ obj.num+" .btn-add").on ("vclick", Music.link.add);
			});
		},
		Single :{
			insert : function(container_id, obj){
				var html ="";
				var title;				
				var page_id = $(":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id");
				if(obj.artist && obj.title)
					title = obj.artist +" - "+ obj.title;
				else
				if(obj.artist)
					title = obj.artist;
				else
					title = obj.title;
				Music.list.push(obj);
				html+= "<div class='song-item mus_"+obj.num+"'><div class='ui360'><a href='http://media.shaxdag.com/Music/"+obj.path+"'>"+title+"</a></div></div>";
				$("#"+container_id).html(html);
				threeSixtyPlayer.config.playNext=false;
				threeSixtyPlayer.init();
				$("#"+container_id+" .mus_"+ obj.num).append('<div class="song_title"><div class="title" base="music" t_key="'+obj.num+'">'+title+'</div></div>');
				$("#"+container_id+" .mus_"+ obj.num).append('<div class="btn-add" base="music" t_key="'+obj.num+'"></div>');	
				//добавляем кнопки снизу				
				Music.link.refresh_like_menu(obj);				
				$("#"+container_id+" .mus_"+ obj.num+" .btn-add").on ("vclick", Music.link.add);
			}
		},
		Utils : {
			get_obj_index: function(objs, num){
				var found_i=-1;
				var i=0;
				$.each(objs, function(key, obj){
					//если входящее сообщение из существующего списка то обновляем счетчик
					if(obj.num==num){
						found_i=i;
					}
					i++;
				});
				return found_i
			},
		},
		link : {
			refresh_nation_footer : function(){
				$("#page_music_nation_popup .navbar_footer_nation_ul").append(Environment.Nations.nations_listview()); 
				$("#page_music_nation_popup .navbar_footer_nation_ul").listview("refresh");
				$("#page_music_nation_popup .navbar_footer_nation_ul a").on ("click", Music.link.btn_nations_onClick);
			},
			refresh_navbar : function(){
				var dom_sort=$("#page_music_navbar .navbar_footer_sort");
				var dom_nation=$("#page_music_navbar .navbar_footer_nation");
				var dom_search=$("#page_music_navbar .navbar_footer_search");
				
				if(Music.Filter.order>0){
					dom_sort.addClass("ui-btn-active"); 

				}
				else{
					dom_sort.removeClass("ui-btn-active");

				}
								
				//подсветка меню наций
				if(Music.Filter.nation_id!=null){
					dom_nation.addClass("ui-btn-active"); 
					dom_nation.html(Environment.Nations.modify(Environment.Nations.nation_by_id(Music.Filter.nation_id).title, "ие"));

				}
				else{
					dom_nation.removeClass("ui-btn-active");
					dom_nation.html("Народы");

				}
				
				//подсветка меню поиска
				if(Music.Filter.searchterm!=null){
					dom_search.addClass("ui-btn-active"); 

				}
				else{
					dom_search.removeClass("ui-btn-active");

				}
				//настраиваем панель поиска
				$("#page_music .ui-footer .ui-controlgroup").css({display: "none"});
				$("#page_music_navbar").css({display: "block"});
				
			},
			btn_nations_onClick : function(ev){ 
				ev.preventDefault();
				$("#page_music_nation_popup").popup("close");
				var ExtendFilter = new Object();
				if($(this).attr("nation_id")){
					ExtendFilter={nation_id: $(this).attr("nation_id")};
				}
				else{
					ExtendFilter={nation_id: null};
				}
				Music.GoAll(ExtendFilter, 0);
				setTimeout(Music.link.refresh_navbar,100);
				
			},
			btn_sort_onClick : function(ev){ 
				ev.preventDefault();	
				$("#page_music_sort_popup").popup("close");
				var ExtendFilter = new Object();
				if($(this).attr("sort_id")){
					ExtendFilter={order: $(this).attr("sort_id")};
				}
				else{
					ExtendFilter={order: null};
				}
				Music.GoAll(ExtendFilter, 0);
				setTimeout(Music.link.refresh_navbar,100);				
			},
			btn_search_onClick : function(ev){ 
				ev.preventDefault();	
				Music.link.SearchForm.show(ev);		
			},
			refresh_like_menu : function(obj){
				var vote_html="";
				var page_id = $(":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id");
				//если мы на странице все музыки, то обновляем нижнее меню с рейтингом и комментариями
				
				if($(":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_music"){
					//сколько лайков
					if(obj.rating){
						if(obj.voted==1)
							vote_html = '<i class="fa fa-heart"></i>: ' + obj.rating;
						else
							vote_html = '<i class="fa fa-heart-o"></i>: ' + obj.rating;
						$("#"+page_id+" .mus_"+ obj.num+" .song_title span.rating").html(vote_html);
					}
					else
						$("#"+page_id+" .mus_"+ obj.num+" .song_title span.rating").html('<i class="fa fa-heart-o"></i>: 0');
					//сколько комментов
					if(obj.comments>0){
						$("#"+page_id+" .mus_"+ obj.num+" .song_title .btn-comments").html('<i class="fa fa-comment"></i>: ' + obj.comments); 
					}
					else
						$("#"+page_id+" .mus_"+ obj.num+" .song_title .btn-comments").html('<i class="fa fa-comment-o"></i>: 0');
					//если проголосовали
					if(obj.voted>0){
						$("#"+page_id+" .mus_"+ obj.num+" .btn-like, #mus_"+ obj.num+" .song_title .btn-unlike").css({visibility: "hidden"});
						$("#"+page_id+" .mus_"+ obj.num+" .btn-like, #mus_"+ obj.num+" .song_title .btn-unlike").off ("vclick");
					}
				}
				
				//если добавлен в мои записи
				if(obj.added>0){
					$("#"+page_id+" .mus_"+ obj.num+" .btn-add").html('<i class="fa fa-minus fa-button-circle fa-button-theme-a"></i>'); 
					$("#"+page_id+" .mus_"+ obj.num+" .btn-add").attr('method', 'delete');
				}
				else{ 
					// круглый плюс $("#mus_"+ obj.num+" .btn-add").html('<a href="#" class="ui-btn ui-icon-plus ui-btn-icon-notext ui-corner-all ui-mini">Добавить</a>');
					$("#"+page_id+" .mus_"+ obj.num+" .btn-add").html('<i class="fa fa-plus fa-button-circle fa-button-theme-a"></i>'); 
					$("#"+page_id+" .mus_"+ obj.num+" .btn-add").attr('method', 'add');
				}				
			},
			SearchForm: {
				show : function(ev){
					ev.preventDefault();
					//настраиваем панель поиска
					$("#page_music .ui-controlgroup-controls .ui-input-search").css({width: document.documentElement.scrollWidth-180})
					$("#page_music .ui-footer .searchform").css({display: "block"});
					$("#page_music_navbar").css({display: "none"});
					if(Music.Filter.searchterm){
						$("#page_music .ui-controlgroup-controls .ui-input-search input").val(Music.Filter.searchterm);
					}
					else
						$("#page_music .ui-controlgroup-controls .ui-input-search input").val("");
				},
				hide : function(ev){
					if(ev)
						ev.preventDefault();
					$("#page_music .ui-footer .searchform").css({display: "none"});
					$("#page_music_navbar").css({display: "block"});
				},
				search : function(ev){
					ev.preventDefault();	
					var ExtendFilter = new Object();
					var searchterm = $("#page_music .ui-controlgroup-controls .ui-input-search input").val();
					if(searchterm){
						ExtendFilter={searchterm: searchterm};
					}
					else{
						ExtendFilter={searchterm: null};
					}
					Music.GoAll(ExtendFilter, 0);
					setTimeout(Music.link.refresh_navbar,100);		
					
				}
			},
			Like : function(ev){
				ev.preventDefault();
				var page_id = $(":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id");
				var params= {base: $(this).attr("base"), t_key: $(this).attr("t_key"), value: $(this).attr("mark"), method: "putMark"};
				rotateEffect1($("#"+page_id+" .mus_"+ params.t_key+" .rating i"));
				$.get( LS("server/proc_votes.php"), params, 
					function( data ) {
						console.log(data);
						if(data.auth_status=="success" ){
							if(data.method_status=="success"){
								//Обновляем  оценки
								var found_i = Music.Utils.get_obj_index(Music.list, params.t_key);
								if(found_i>=0){
									Music.list[found_i].rating = data.vote.rating;
									Music.list[found_i].voted = 1;
									Music.link.refresh_like_menu(Music.list[found_i]);									
								}		
							}
							else{
								show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
							}	
						}
						else{
							console.log("Сессия не существует на сервере." + JSON.stringify(data));	
							gl_logout();
						}
					},
					"json"
				);
				
			},
			add : function(ev){
				ev.preventDefault();
				var method = $(this).attr("method");
				var page_id = $(":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id");
				var params= {base: $(this).attr("base"), num: $(this).attr("t_key"), s_base: "users", method: method};
				$.get( LS("server/proc_adddelete.php"), params, 
					function( data ) {
						console.log(data);
						if(data.auth_status=="success" ){
							if(data.method_status=="success"){
								//Обновляем  оценки
								var found_i = Music.Utils.get_obj_index(Music.list, params.num);
								if(found_i>=0){
									if(params.method=="add")
										Music.list[found_i].added = 1;
									else
										Music.list[found_i].added = 0;
									$("#"+page_id+" .mus_"+ params.num+" .btn-add").velocity({rotateY : "180deg"});	
									Music.link.refresh_like_menu(Music.list[found_i]);
									$("#"+page_id+" .mus_"+ params.num+" .btn-add").velocity({rotateY : "0deg"});	
								}		
							}
							else{
								show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
							}	
						}
						else{
							console.log("Сессия не существует на сервере." + JSON.stringify(data));	
							gl_logout();
						}
					},
					"json"
				);
				
			},
			
		}
	
	});
	Audio_ = new Object({
		context :  Object(),
		buffer : {income_msg : null, outcome_msg : null,},	
		loadSoundFile : function(type, play) {
			var url="";
			//определяем url  к файлу
			if(type=="income_msg"){
				url="bin/msg_in.mp3";
			}else
			if(type=="outcome_msg"){
				url="bin/msg_out.mp3";
			}
			
			console.log(url);
		  // делаем XMLHttpRequest (AJAX) на сервер
		  var xhr = new XMLHttpRequest();
		  xhr.open('GET', url, true);
		  xhr.responseType = 'arraybuffer'; // важно
		  xhr.onload = function(e) {
			// декодируем бинарный ответ
			Audio_.context.decodeAudioData(this.response,
			function(decodedArrayBuffer) {
			  // получаем декодированный буфер
			  if(type=="income_msg"){
				Audio_.buffer.income_msg = decodedArrayBuffer;
			  }
			  else
			  if(type=="outcome_msg"){
				Audio_.buffer.outcome_msg = decodedArrayBuffer;
			  }
			  if(play){
				Audio_.play(type);
			  }
			}, function(e) {
			  console.log('Error decoding file', e);
			});
		  };
		  xhr.send();
		},
		play : function(type){
		  // создаем источник
		  var source = Audio_.context.createBufferSource();
		  // подключаем буфер к источнику
		   if(type=="income_msg"){
				source.buffer = Audio_.buffer.income_msg;
		  }
		  else
		  if(type=="outcome_msg"){
				source.buffer = Audio_.buffer.outcome_msg;
		  }
		  // дефолтный получатель звука
		  var destination = Audio_.context.destination;
		  // подключаем источник к получателю
		  source.connect(destination);
		  // воспроизводим
		  source.start(0);
		},
		init : function(){
			Audio_.context =  new window.AudioContext();
		},
		income_msg : {
			play : function(){
				if(Audio_.buffer.income_msg==null){
					Audio_.loadSoundFile("income_msg", 1);
				}
				else
					Audio_.play("income_msg");
			}
		},
		outcome_msg : {
			play : function(){
				if(Audio_.buffer.outcome_msg==null){
					Audio_.loadSoundFile("outcome_msg", 1);
				}
				else
					Audio_.play("outcome_msg");
			}
		},
		
		
	});
	//Fotos
	Fotos = new Object({
		list : Object(),
		active_user : Object(),
		el_per_page : 16,
		loading_data : 0,
		total_all: 0,
		url_params : Object(),
		Filter : Object(),
		GoGallery : function (filter){
			var params;
			if ($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_fotos"){
				
			}
			else{
				Fotos.init();
				$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_fotos"), { transition: "none", allowSamePageTransition: true} );
				//показываем навбар
				$("#page_fotos .navbar-public").css({display : "block"});
				Environment.Utils.refresh_public_navbar("#page_fotos .navbar-public", "btn-fotos");
				
				
			}
			$.mobile.silentScroll(0);
			//устанавливаем фильтры
			if(filter!=null){
				Fotos.Filter=$.extend(Fotos.Filter, filter);
			}
			//задаем параметры запроса
			params=Fotos.Filter;
			params.initial=1;
			params.el_per_page=Fotos.el_per_page;
			params.method="getGalleryFotos";
			params.last=0;
			Fotos.Load(params);
			setTimeout(Fotos.link.refresh_navbar,100);
		},
		GoUsersFotos : function (){
			var params = new Object();
			//ФОрмируем кнопки и оформление страницы личных фотографий
			if($(this).attr("user_id")==User.I.id){
				$( "#page_usersfotos .topheader .btn-upload").css({display : "inline-block"});
			}
			else
				$( "#page_usersfotos .topheader .btn-upload").css({display : "none"});
			if ($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_usersfotos"){
				
			}
			else{
				Fotos.init();
				$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_usersfotos"), { transition: "none", allowSamePageTransition: true} );
				$("#page_fotos .navbar-public").css({display : "none"});
				
			}
			$.mobile.silentScroll(0);
			//задаем параметры запроса
			params.user_id = $(this).attr("user_id"),
			params.initial=1;
			params.el_per_page=Fotos.el_per_page;
			params.method="getUserFotos";
			params.last=0;
			Fotos.Load(params);
		},
		GoAppend : function(){
			var params=Fotos.url_params;
			if(Fotos.list.length<Fotos.total_all){
				params.last=Fotos.list.length;
				params.initial=0;
				Fotos.Load(params);
			}
		},
		Load : function(params){
			Fotos.loading_data=1;
			$.get( LS("server/proc_fotos.php"), params, 
				function( data ) {
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							Fotos.url_params=params;
							Fotos.total_all=data.fotos.total_all;
							//если загрузка инициализирующая
							if(params.initial==1){
								//дополняем список фоток
								Fotos.list=data.fotos.fotos;
								if(params.method == "getUserFotos")
									Fotos.active_user = data.user;
								Fotos.Display(data, params);
								console.log("Load initial fotos");
							}
							//если догрузка фоток
							else{
								if(data.fotos.fotos.length>0){
									Fotos.list=Fotos.list.concat(data.fotos.fotos);
									Fotos.Append(data, params);
									console.log("Load appended fotos");
								}
							}
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
					Fotos.loading_data=0;
				},
				"json"
			);
		},
		//первая отрисовка страницы фоток
		Display: function(resp_obj, params){ 
			var html="";
			//очищаем список фоток
			$("#page_fotos_list").html("");
			//если галерея
			if(params.method=="getGalleryFotos"){
				if(resp_obj.fotos.total>0){
					var i=0;
					$.each(resp_obj.fotos.fotos, function(key,obj){
						html+= "<div class='foto'><a href='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "small")+"'></a></div>";
						i++;
					});
					$("#page_fotos_list").html(html);
					//применяем Swipe
					Fotos.PS.ReCreate($("#page_fotos_list .foto a"));
				}
				console.log("appended new fotos"+JSON.stringify(resp_obj));
				
			}
			else
			if(params.method=="getUserFotos"){
				if(resp_obj.fotos.total>0){
					var i=0;
					$.each(resp_obj.fotos.fotos, function(key,obj){
						html+= "<div class='foto'><a href='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "small")+"'></a></div>";
						i++;
					});
					$("#page_usersfotos_list").html(html);
					$(".foto").velocity("fadeIn",500)
					//применяем Swipe
					Fotos.PS.ReCreate($("#page_usersfotos_list .foto a"));
				}
				console.log("appended new fotos"+JSON.stringify(resp_obj));
				
			}
		},
		//Догрузка фоток
		Append: function(resp_obj, params){ 
			var html="";
			//если галерея
			if(params.method=="getGalleryFotos"){
				if(resp_obj.fotos.total>0){
					var i=0;
					$.each(resp_obj.fotos.fotos, function(key,obj){
						html+= "<div class='foto'><a href='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "small")+"'></a></div>";
						i++;
					});
					$("#page_fotos_list").append(html);
					//$(".foto").velocity("fadeIn",500)
					//если PS открыт, то закрываем, обновляем и открываем
					if(Fotos.PS.isShown==1){
						photoSwipeInstance.hide();
						Fotos.PS.ReCreate($("#page_fotos_list .foto a"));
						photoSwipeInstance.show(Fotos.PS.cursor);
					}
					else{
						Fotos.PS.ReCreate($("#page_fotos_list .foto a"));
					}
				}
				
				console.log("appended new fotos"+JSON.stringify(resp_obj));
			}
			else
			//если галерея
			if(params.method=="getUserFotos"){
				if(resp_obj.fotos.total>0){
					var i=0;
					$.each(resp_obj.fotos.fotos, function(key,obj){
						html+= "<div class='foto'><a href='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "small")+"'></a></div>";
						i++;
					});
					$("#page_fotos_list").append(html);
					//если PS открыт, то закрываем, обновляем и открываем
					if(Fotos.PS.isShown==1){
						photoSwipeInstance.hide();
						Fotos.PS.ReCreate($("#page_usersfotos_list .foto a"));
						photoSwipeInstance.show(Fotos.PS.cursor);
					}
					else{
						Fotos.PS.ReCreate($("#page_usersfotos_list .foto a"));
					}
				}
				
				console.log("appended new fotos"+JSON.stringify(resp_obj));
			}
		},
		PS : {
			cursor: 0,
			isShown: 0,
			OnDisplay : function(e){
				if((e.index==(Fotos.list.length-3)) && e.action=="next"){
					Fotos.GoAppend();
				}
				Fotos.PS.cursor=e.index;
				Fotos.PS.Toolbar.refresh(); 
				Fotos.PS.Toolbar.refresh_caption();
			},
			onShow : function(e){
				Fotos.PS.isShown=1;
			},
			onHide : function(e){
				Fotos.PS.isShown=0;
			},
			Toolbar :{
				get : function(){  
					var html;
					html='<div class="ps-toolbar-close ps-btn-close"><i class="fa fa-times fa-lg fa-button-theme-a"></i></div>';
					html+='<div class="ps-toolbar-previous ps-btn-back"><i class="fa fa-chevron-left fa-lg fa-button-theme-a"></i></div>';
					html+='<div class="ps-btn-like" base="" t_key=""><i class="fa fa-heart-o fa-lg fa-button-theme-a"></i><span></span></div>'; 
					html+='<div class="ps-btn-comments"><i class="fa fa-comment-o fa-lg fa-button-theme-a"></i><span></span></div>'; 
					html+='<div class="ps-toolbar-next ps-btn-forward"><i class="fa fa-chevron-right fa-lg fa-button-theme-a"></i></div>';
					return html;
				},
				refresh : function(){
					if(Fotos.list[Fotos.PS.cursor].private_foto)
						var base = "users_fotos";
					else
						var base = "fotos";
					//сколько комментов
					if(Fotos.list[Fotos.PS.cursor].comments>0){
						$(".ps-btn-comments span").html(Fotos.list[Fotos.PS.cursor].comments); 
					}
					else{
						$(".ps-btn-comments span").html(""); 
					}
					//сколько лайков
					if(Fotos.list[Fotos.PS.cursor].rating){
						$(".ps-btn-like span").html(Fotos.list[Fotos.PS.cursor].rating);
						if(Fotos.list[Fotos.PS.cursor].rating>0)
							$(".ps-btn-like span").css({color: "rgb(85, 212, 51)"});
						else
						if(Fotos.list[Fotos.PS.cursor].rating<0)
							$(".ps-btn-like span").css({color: "rgb(229, 66, 38)"});
					}
					else{
						$(".ps-btn-like span").html("");
					}
					//добавляем атрибуты к ссылке
					$(".ps-btn-like").attr("t_key", Fotos.list[Fotos.PS.cursor].num);//like
					$(".ps-btn-like").attr("base", base);
					$(".ps-btn-comments").attr("t_key", Fotos.list[Fotos.PS.cursor].num);//comment
					$(".ps-btn-comments").attr("base", base);
					
						
					if(Fotos.list[Fotos.PS.cursor].voted!=null){
						$(".ps-btn-like i").removeClass("fa-heart-o");
						$(".ps-btn-like i").addClass("fa-heart");
					}
					else{
						$(".ps-btn-like i").removeClass("fa-heart"); 
						$(".ps-btn-like i").addClass("fa-heart-o");
					}
				},
				refresh_caption : function(){
					var html;
					if(Fotos.url_params.method == "getUserFotos")
						var user = Fotos.active_user; 
					else
						var user = Fotos.list[Fotos.PS.cursor].user;
					html='<div class="avatar" user_id="'+user.id+'"><img src="'+User.html.avatar_url(user.foto,40)+'" class="userlist_afoto user-avatar-rounded"></div>';
					html+='<div class="name" user_id="'+user.id+'">'+User.html.online_status(user, "tiny")+" "+ User.html.gender(user)+ " " + user.name+'<br><span>'+Fotos.list[Fotos.PS.cursor].title+'</span></div>';
					$(".ps-caption-content").html(html);
					//обработчики кликов
					//на страницу пользователя 
					$(".ps-caption-content .avatar, .ps-caption-content .name").off("vclick");
					$(".ps-caption-content .avatar, .ps-caption-content .name").on("vclick", Fotos.PS.Toolbar.Handler.GoUser);
					//Лайк
					$(".ps-btn-like").off("vclick");
					$(".ps-btn-like").on("vclick", Fotos.PS.Toolbar.Handler.Like);
					//комментарии 
					$(".ps-btn-comments").off("vclick");
					$(".ps-btn-comments").on("vclick", Fotos.PS.Toolbar.Handler.Comment);
				},
				Handler : { 
					Like : function(ev){
						if(Fotos.PS.isShown && Fotos.list[Fotos.PS.cursor].voted==null ){
							var params= {base: $(this).attr("base"), t_key: $(this).attr("t_key"), value: "plus", method: "putMark", cursor: Fotos.PS.cursor};
							$.get( LS("server/proc_votes.php"), params, 
								function( data ) {
									console.log(data);
									if(data.auth_status=="success" ){
										if(data.method_status=="success"){
											//обновляем туллбар к фотке по которой пришел ответ
											Fotos.list[params.cursor].rating=data.vote.rating;
											Fotos.list[params.cursor].voted=1; //метим что оценка проставлена
											Fotos.PS.Toolbar.refresh();			
										}
										else{
											show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
										}	
									}
									else{
										console.log("Сессия не существует на сервере." + JSON.stringify(data));	
										gl_logout();
									}
								},
								"json"
							);
						}
					},
					Comment : function(){
						var base=$(this).attr("base");
						var t_key=$(this).attr("t_key");
						//если переход из PS то сначала закрываем его
						if (typeof photoSwipeInstance != "undefined" && photoSwipeInstance != null) { 
							if(Fotos.PS.isShown){
								photoSwipeInstance.hide(true);
							}
						}
						Comments.OpenComments(t_key,base);
					},
					GoUser : function(ev){
						ev.preventDefault();
						var user_id=$(this).attr("user_id");
						//если переход из PS то сначала закрываем его
						if (typeof photoSwipeInstance != "undefined" && photoSwipeInstance != null) { 
							if(Fotos.PS.isShown){
								photoSwipeInstance.hide(true);
							}
						}
						UserPage.GoId(user_id);
					}
				}
			},
			ReCreate : function(dom_fotos){
				if (typeof photoSwipeInstance != "undefined" && photoSwipeInstance != null) { 
					window.Code.PhotoSwipe.detatch(photoSwipeInstance);
				}
				photoSwipeInstance = dom_fotos.photoSwipe({zIndex: 2, 
					loop: false, 
					getToolbar: Fotos.PS.Toolbar.get, 
					captionAndToolbarAutoHideDelay: 100000,
					fadeInSpeed: 0,
					fadeOutSpeed: 0});
				//обработчик показа изображения
				photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onDisplayImage, Fotos.PS.OnDisplay);
				photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onShow, Fotos.PS.onShow);
				photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onHide, Fotos.PS.onHide);
				photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onCaptionAndToolbarShow, Fotos.PS.Toolbar.refresh_caption);
			}
		},
		init : function(){
			Fotos.PS.cursor=0;
			Fotos.PS.isShown=0;
			Fotos.list = new Object();
			Fotos.el_per_page = 32;
			Fotos.loading_data =0;
			Fotos.total_all = 0;
			Fotos.url_params = new Object();
			Fotos.Filter = Fotos.constructFilter();
			
		},
		constructFilter : function(){
			return {
				album: null,
				nation_id: null,
				gender: null
			}
		},
		link :{
			btn_album_onClick : function(ev){
				ev.preventDefault();
				$("#page_fotos_album_popup").popup("close");
				var ExtendFilter = new Object();
				if($(this).attr("album_id")){
					ExtendFilter={album: $(this).attr("album_id")};
				}
				else{
					ExtendFilter={album: null};
				}
				Fotos.GoGallery(ExtendFilter);
				//setTimeout(Fotos.link.refresh_navbar,100);
				
			},
			btn_gender_onClick : function(ev){
				ev.preventDefault();
				$("#page_fotos_gender_popup").popup("close");
				var ExtendFilter = new Object();
				if($(this).attr("gender_id")){
					ExtendFilter={gender: $(this).attr("gender_id")};
				}
				else{
					ExtendFilter={gender: null};
				}
				Fotos.GoGallery(ExtendFilter);
				//setTimeout(Fotos.link.refresh_navbar,100);
				
			},
			btn_nations_onClick : function(ev){ 
				ev.preventDefault();
				$("#page_fotos_nation_popup").popup("close");
				var ExtendFilter = new Object();
				if($(this).attr("nation_id")){
					ExtendFilter={nation_id: $(this).attr("nation_id")};
				}
				else{
					ExtendFilter={nation_id: null};
				}
				Fotos.GoGallery(ExtendFilter);
				//setTimeout(Fotos.link.refresh_navbar,100);
				
			},
			btn_upload_onClick : function(ev){
				ev.preventDefault();
				var upload_type = $(this).attr("upload_type");
				Uploader.init(upload_type);
				Uploader.Display();
				
			},
			
			refresh_navbar : function(){
				console.log(Fotos.Filter);
				var dom_album=$("#page_fotos_navbar .navbar_footer_album");
				var dom_gender=$("#page_fotos_navbar .navbar_footer_gender");
				var dom_nation=$("#page_fotos_navbar .navbar_footer_nation");
				//альбом
				if(Fotos.Filter.album){
					dom_album.addClass("ui-btn-active");
					if(Fotos.Filter.album=="1"){
						dom_album.html("Люди");
					}
					else
					if(Fotos.Filter.album=="2"){
						dom_album.html("Культура");
					}
					else
					if(Fotos.Filter.album=="3"){
						dom_album.html("Графика");
					}
					else
					if(Fotos.Filter.album=="4"){
						dom_album.html("Природа");
					}
					
				}
				else{
					dom_album.removeClass("ui-btn-active");
					dom_album.html("Раздел");
				}
				//пол
				if(Fotos.Filter.gender){
					dom_gender.addClass("ui-btn-active");
					if(Fotos.Filter.gender=="М"){
						dom_gender.html("Мужской");
						dom_gender.removeClass("ui-icon-male"); dom_gender.removeClass("ui-icon-female");
						dom_gender.addClass("ui-icon-male");
					}
					else
					if(Fotos.Filter.gender=="Ж"){
						dom_gender.html("Женский");
						dom_gender.removeClass("ui-icon-male"); dom_gender.removeClass("ui-icon-female");
						dom_gender.addClass("ui-icon-female");
					}
					
				}
				else{
					dom_gender.removeClass("ui-btn-active");
					dom_gender.removeClass("ui-icon-male"); dom_gender.removeClass("ui-icon-female");
					dom_gender.addClass("ui-icon-male");
					dom_gender.html("Пол");
				}
				//подсветка меню наций
				if(Fotos.Filter.nation_id!=null){
					dom_nation.addClass("ui-btn-active"); 
					dom_nation.html(Environment.Nations.nation_by_id(Fotos.Filter.nation_id).nationality);

				}
				else{
					dom_nation.removeClass("ui-btn-active");
					dom_nation.html("Народы"); 

				}
				
			},
			refresh_nation_footer : function(){
				$("#page_fotos_nation_popup .navbar_footer_nation_ul").append(Environment.Nations.nations_listview()); 
				$("#page_fotos_nation_popup .navbar_footer_nation_ul").listview("refresh");
				$("#page_fotos_nation_popup .navbar_footer_nation_ul a").on ("click", Fotos.link.btn_nations_onClick);
			},
			Delete : function(ev){
				ev.preventDefault();
				var track_num = $(this).attr("num");
				var base = $(this).attr("base");
				var params;
				if(base=="fotos" || base=="users_fotos"){
					params ={track_num: track_num, base: base}
					$.get( LS("server/proc_delete.php"), params, 
						function( data ) {
							if(data.auth_status=="success" ){
								if(data.method_status=="success"){
									//обработчик страницы page_upload
									if(getCurrentPage()=="page_upload"){
										var found_i=-1;
										removeEffect1($("#page_upload .loaded .num_"+params.track_num));
										found_i=Uploader.Utils.get_list_index(params.track_num);
										if(found_i>=0)
											Uploader.list.splice(found_i,1);
										$("#page_upload .counter span").html(Uploader.list.length);
									}
								}
								else{
									show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
								}
								
							}
							else{
								console.log("Сессия не существует на сервере." + JSON.stringify(data));	
								gl_logout();
							}
						},
						"json"
					);
				}
			}
			
		},
		Utils :{
			ajax_overlay : function(action){
				if(action == "enable"){
					//$('div.foto').fadeTo('normal',0.5); --тормозит на мобильниках
					$('div.foto').append('<div class="ajax-overlay"></div>');
				}
				else
				if(action == "disable"){
					//$('div.foto').fadeTo('fast',1);
					$('div.foto .ajax-overlay').remove();
				}
			},
			HandleAjax : function(action,settings){
				if (settings.url.indexOf("server/proc_fotos.php")>=0){
					if(action=="send"){
						Fotos.Utils.ajax_overlay('enable');
					}
					else
					if(action=="stop"){
						Fotos.Utils.ajax_overlay('disable');
					}
				}
			},
			foto_url : function(foto_obj, size){
				var path;
				if(foto_obj.private_foto==1)
					path = LLocal("users_fotos/");
				else
					path = LLocal("fotos/");
				if(size == 800)
					path = path + foto_obj.path;
				else
				if(size == 150)
					path = path +"/small/"+ foto_obj.path;
				
				return path;
					
			}
		}
		
		
	});
	//UsersFotos
	UsersFotos = new Object({
		list : Object(),
		el_per_page : 16,
		loading_data : 0,
		total_all: 0,
		url_params : Object(),
		Go : function (){
			UsersFotos.init();
			UsersFotos.Load({
				user_id : $(this).attr("user_id"),
				method :"getUserFotos",
				el_per_page: Fotos.el_per_page,
				last : 0,
				initial: 1
				});
			//передаем параметры загрузки в глобал
			UsersFotos.url_params = {
				user_id : $(this).attr("user_id"),
				method :"getUserFotos",
				last : 0,
				el_per_page: Fotos.el_per_page
			}
		},
		GoAppend : function(){
			var params=Fotos.url_params;
			if(UsersFotos.list.length<UsersFotos.total_all){
				params.last=UsersFotos.list.length;
				params.initial=0;
				UsersFotos.Load(params);
			}
		},
		Load : function(params){
			UsersFotos.loading_data=1;
			$.get( LS("server/proc_fotos.php"), params, 
				function( data ) {
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							UsersFotos.total_all=data.fotos.total_all;
							//если загрузка инициализирующая
							if(params.initial==1){
								//дополняем список фоток
								UsersFotos.list=data.fotos.fotos;
								UsersFotos.Display(data, params);
								console.log("Load initial fotos");
							}
							//если догрузка фоток
							else{
								if(data.fotos.fotos.length>0){
									UsersFotos.list=Fotos.list.concat(data.fotos.fotos);
									UsersFotos.Append(data, params);
									console.log("Load appended fotos");
								}
							}
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
					UsersFotos.loading_data=0;
				},
				"json"
			);
		},
		//первая отрисовка страницы фоток
		Display: function(resp_obj, params){ 
			var html="";
			//если личные фотографии
			if(params.method=="getUserFotos"){
				if(resp_obj.fotos.total>0){
					var i=0;
					$.each(resp_obj.fotos.fotos, function(key,obj){
						html+= "<div class='foto'><a href='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "small")+"'></a></div>";
						i++;
					});
					$("#page_usersfotos_list").html(html);
					//применяем Swipe
					Fotos.PS.ReCreate($("#page_usersfotos_list .foto a"));
				}
				
				$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_usersfotos"), { transition: "none", allowSamePageTransition: true} );
				$.mobile.silentScroll(0);
				console.log(resp_obj);
				
			}
		},
		//Догрузка фоток
		Append: function(resp_obj, params){ 
			var html="";
			//если личные фотографии
			if(params.method=="getUserFotos"){
				if(resp_obj.fotos.total>0){
					var i=0;
					$.each(resp_obj.fotos.fotos, function(key,obj){
						html+= "<div class='foto'><a href='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(resp_obj.fotos.fotos[i].path, resp_obj.fotos.fotos[i].private_foto, "small")+"'></a></div>";
						i++;
					});
					$("#page_usersfotos_list").append(html);
					//если PS открыт, то закрываем, обновляем и открываем
					if(Fotos.PS.isShown==1){
						photoSwipeInstance.hide();
						Fotos.PS.ReCreate($("#page_usersfotos_list .foto a"));
						photoSwipeInstance.show(Fotos.PS.cursor);
					}
					else{
						Fotos.PS.ReCreate($("#page_usersfotos_list .foto a"));
					}
				}
				
				console.log("appended new fotos"+JSON.stringify(resp_obj));
			}
		},
		PS : {
			cursor: 0,
			isShown: 0,
			OnDisplay : function(e){
				if((e.index==(Fotos.list.length-3)) && e.action=="next"){
					Fotos.GoAppend();
				}
				Fotos.PS.cursor=e.index;
			},
			onShow : function(e){
				Fotos.PS.isShown=1;
			},
			onHide : function(e){
				Fotos.PS.isShown=0;
			},
			ReCreate : function(){
				if (typeof photoSwipeInstance != "undefined" && photoSwipeInstance != null) {
					window.Code.PhotoSwipe.detatch(photoSwipeInstance);
				}
				photoSwipeInstance = $("#page_fotos_list .foto a").photoSwipe({zIndex: 99, loop: false});
				//обработчик показа изображения
				photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onDisplayImage, Fotos.PS.OnDisplay);
				photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onShow, Fotos.PS.onShow);
				photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onHide, Fotos.PS.onHide);
			}
		},
		init : function(){
			Fotos.PS.cursor=0;
			Fotos.PS.isShown=0;
			Fotos.list = new Object();
			Fotos.el_per_page = 16;
			Fotos.loading_data =0;
			Fotos.total_all = 0;
			Fotos.url_params = new Object();
			
		}
	});
	//UserList
	UserList = new Object({
		list : Object(),
		el_per_page : 16,
		loading_data : 0,
		total_all: 0,
		url_params : Object(),
		Filter : Object(),
		init : function(){
			UserList.list = new Object();
			UserList.el_per_page = 16;
			UserList.loading_data =0;
			UserList.total_all = 0;
			UserList.url_params = new Object();
			UserList.Filter = UserList.constructFilter();
			
		},
		constructFilter : function(){
			return {
				name: null,
				country: null,
				city: null,
				resp: null,
				raion: null,
				selo: null,
				gender: null,
				user_nation: null,
				user_vuz_name: null,
				user_vuz_faculty: null,
				online: 0
			}
		},
		GoUsers : function(){ //функция открытия списка пользователей
			var params;
			UserList.init(); 
			$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_usersearch"), { transition: "none", allowSamePageTransition: true} );
			//показываем навбар
			$("#page_usersearch .navbar-public").css({display : "block"});
			Environment.Utils.refresh_public_navbar("#page_usersearch .navbar-public", "btn-users");
			
			params=UserList.Filter;
			params.initial=1;
			params.el_per_page=UserList.el_per_page;
			params.method='getUsersSearch';
			UserList.Load(params);
			setTimeout(UserList.link.refresh_navbar,100);
			
		},
		//функция перехода на страницу поиска людей
		GoSearch: function(filterObj){
			var params;
			if ($( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id")=="page_usersearch"){
				
			}
			else{
				UserList.init();
				$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_usersearch"), { transition: "none", allowSamePageTransition: true} );
				
			}
			$.mobile.silentScroll(0);
			//устанавливаем фильтры
			if(filterObj!=null){
				UserList.Filter=$.extend(UserList.Filter, filterObj);
			}
			//задаем параметры запроса
			params=UserList.Filter;
			params.initial=1;
			params.el_per_page=UserList.el_per_page;
			params.method='getUsersSearch';
			UserList.Load(params);
			setTimeout(UserList.link.refresh_navbar,100);
			
		},
		Load : function(params){
			UserList.loading_data=1;
			$.get( LS("server/proc_userlist.php"), params, 
				function( data ) {
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							UserList.total_all=data.users_data.total_all;
							UserList.url_params=params;
							//если загрузка инициализирующая
							if(params.initial==1){
								//заполняем список пользователей
								UserList.list=data.users_data.users;
								UserList.Display(data, params);

							}
							//если догрузка 
							else{
								if(data.users_data.users.length>0){
									UserList.list=UserList.list.concat(data.users_data.users);
									UserList.Append(data, params);
									console.log("Load appended userlist");
								}
							}
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
					UserList.loading_data=0;
				},
				"json"
			)
				.fail(function(){
					UserList.loading_data=0;
				});
		},
		GoAppend : function(){ //отрабатывает для догрузки данных
			var params=UserList.url_params;
			if(UserList.list.length<UserList.total_all){
				params.last=UserList.list.length;
				params.initial=0;
				UserList.Load(params);
			}
		},
		SingleUser : {
			html : function(users_obj){
				var i=0;
				var html="";
				$.each(users_obj, function(key,obj){
					html+='<li class="ui-shadow" id="userlist_'+obj.id+'" user_id="'+obj.id+'">';
					html+='<img src="'+User.html.avatar_url(obj.foto,100)+'" class="userlist_afoto user-avatar-rounded" user_id="'+obj.id+'"> ';
					html+='<h2>'+User.html.online_status(obj, "tiny")+" "+ User.html.gender(obj)+ " " + obj.name+'</h2>'; 
					//html+='<p><a user_id="'+obj.id+'" class="ui-btn  ui-btn-inline ui-mini ui-corner-all ui-btn-icon-left ui-icon-envelope" >Сообщение</a></p>';
					html+='<p>';
					html+="<span class='info_1'>Живет: "+obj.city+"</span>";
					if(obj.nation_id>0)
						html+="<span class='info_1'>Народность: "+Environment.Nations.nation_by_id(obj.nation_id).nationality+"</span>";
					html+="<br>";
					//откуда родом
					if(obj.resp)
						html+="<span class='add_info'>Родом из: "+obj.resp+"</span>";
					if(obj.raion)
						html+="<span class='add_info'>, "+obj.raion+"</span>";
					if(obj.selo) 
						html+="<span class='add_info'>, "+obj.selo+"</span>";
					html+="<span class='add_info'><br></span>";
					
					html+='<a user_id="'+obj.id+'" class="ui-btn ui-btn-b ui-btn-inline ui-mini ui-btn-icon-left ui-icon-envelope kvadro-btn userlist_amsg" >Сообщение</a>';
					if( Environment.Utils.is_friend(obj.id)==false )
						html+='<a user_id="'+obj.id+'" class="ui-btn ui-btn-b ui-btn-inline ui-mini ui-btn-icon-notext ui-icon-plus kvadro-btn userlist_afotos" >В друзья</a>';
					html+='<a user_id="'+obj.id+'" class="ui-btn ui-btn-b ui-btn-inline ui-mini ui-btn-icon-notext ui-icon-picture-o kvadro-btn userlist_afriends" >Фотографии</a>';
					html+='<a user_id="'+obj.id+'" class="ui-btn ui-btn-b ui-btn-inline ui-mini ui-btn-icon-notext ui-icon-ellipsis-h kvadro-btn userlist_amore" >Еще</a>';
					html+='</p>';
					html+='</li>';
					i++;
				});
				return html;
			}
		},
		//первая отрисовка списка пользователей
		Display: function(resp_obj, params){ 
			$("#page_userlist_list").html("");
			//если страница поиска
			if(params.method=="getUsersSearch"){
				if(resp_obj.users_data.total>0){
					var html='<ul id="page_userlist_list_ul" data-role="listview" data-theme="a" >';
					html+=UserList.SingleUser.html(resp_obj.users_data.users);
					html+='</ul>';
					$("#page_userlist_list").html(html);
					$( "#page_userlist_list_ul" ).listview();
					$( "#page_userlist_list_ul" ).listview('refresh');
					$( "#page_userlist_list_ul li").on("click", UserList.link.btn_details_onClick);
					$( "#page_userlist_list .userlist_afoto").on( "vclick", UserPage.Go);
					//Обработчики кнопок
					$( "#page_userlist_list .userlist_amsg").on( "vclick", function (ev){
						ev.preventDefault();
						NavMsg.OpenDialog($(this).attr("user_id"))
					});
				}
				
			}
			else
			//если галерея
			if(params.method=="getGalleryFotos"){
				
				
			}
		},
		Append: function(resp_obj, params){ 
			var html="";
			//если страница поиска
			if(params.method=="getUsersSearch"){
				if(resp_obj.users_data.total>0){
					html=UserList.SingleUser.html(resp_obj.users_data.users);
					$("#page_userlist_list_ul").append(html);
					$( "#page_userlist_list_ul" ).listview('refresh');
					$( "#page_userlist_list .userlist_afoto").off( "vclick");
					$( "#page_userlist_list_ul li").off( "click");
					$( "#page_userlist_list_ul li").on( "click", UserList.link.btn_details_onClick);
					$( "#page_userlist_list .userlist_afoto").on( "vclick", UserPage.Go);
					//Обработчики кнопок
					$( "#page_userlist_list .userlist_amsg").off( "vclick")
					$( "#page_userlist_list .userlist_amsg").on( "vclick", function (ev){
						ev.preventDefault();
						NavMsg.OpenDialog($(this).attr("user_id"))
					});
				}
				
			}
			else
			//если галерея
			if(params.method=="getGalleryFotos"){
				
				
			}
		},
		Search : function(){
			var filter = new Object();
			if($("#page_usersearch_name").val())
				filter.name = $("#page_usersearch_name").val();
			if($("#page_usersearch_country").val())
				filter.country = $("#page_usersearch_country").val();
			if($("#page_usersearch_city").val())  
				filter.city = $("#page_usersearch_city").val();
			if($("#page_usersearch_resp").val())
				filter.resp = $("#page_usersearch_resp").val();
			if($("#page_usersearch_raion").val())
				filter.raion = $("#page_usersearch_raion").val();
			if($("#page_usersearch_selo").val())
				filter.selo = $("#page_usersearch_selo").val();
			if($("#page_usersearch_gender").val())
				filter.gender = $("#page_usersearch_gender").val();
			if($("#page_usersearch_nation").val())
				filter.user_nation = $("#page_usersearch_nation").val();
			if($("#page_usersearch_vuz").val())
				filter.user_vuz_name = $("#page_usersearch_vuz").val();
			if($("#page_usersearch_faculty").val())
				filter.user_vuz_faculty = $("#page_usersearch_faculty").val();
			if(!$.isEmptyObject(filter)){
				UserList.GoSearch(filter);
			}
			else
				show_popup("message_not_sent", "Вы не задали ни одного параметра для поиска", $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
			
		},
		link :{
			btn_online_onClick : function(ev){
				console.log("online clicked");
				ev.preventDefault();
				var ExtendFilter = new Object();
				if(UserList.Filter.online==0){
					ExtendFilter={online: 1};
				}
				else{
					ExtendFilter={online: 0};
				}
				UserList.GoSearch(ExtendFilter);
				setTimeout(UserList.link.refresh_navbar,100);
				
			},
			btn_gender_onClick : function(ev){
				ev.preventDefault();
				$("#page_usersearch_gender_popup").popup("close");
				var ExtendFilter = new Object();
				if($(this).attr("gender_id")){
					ExtendFilter={gender: $(this).attr("gender_id")};
				}
				else{
					ExtendFilter={gender: null};
				}
				UserList.GoSearch(ExtendFilter);
				setTimeout(UserList.link.refresh_navbar,100);
				
			},
			btn_nations_onClick : function(ev){
				ev.preventDefault();
				$("#page_usersearch_nation_popup").popup("close");
				var ExtendFilter = new Object();
				if($(this).attr("nation_id")){
					ExtendFilter={user_nation: $(this).attr("nation_id")};
				}
				else{
					ExtendFilter={user_nation: null};
				}
				UserList.GoSearch(ExtendFilter);
				setTimeout(UserList.link.refresh_navbar,100);
				
			},
			
			refresh_navbar : function(){
				var dom_online=$("#page_usersearch_navbar .navbar_footer_online");
				var dom_gender=$("#page_usersearch_navbar .navbar_footer_gender");
				var dom_nation=$("#page_usersearch_navbar .navbar_footer_nation");
				var dom_search=$("#page_usersearch_navbar .navbar_footer_search");
				
				if(UserList.Filter.online>0){
					dom_online.addClass("ui-btn-active"); 

				}
				else{
					dom_online.removeClass("ui-btn-active");

				}
				
				if(UserList.Filter.gender){
					dom_gender.addClass("ui-btn-active");
					if(UserList.Filter.gender=="М"){
						dom_gender.html("Мужской");
						dom_gender.removeClass("ui-icon-male"); dom_gender.removeClass("ui-icon-female");
						dom_gender.addClass("ui-icon-male");
					}
					else
					if(UserList.Filter.gender=="Ж"){
						dom_gender.html("Женский");
						dom_gender.removeClass("ui-icon-male"); dom_gender.removeClass("ui-icon-female");
						dom_gender.addClass("ui-icon-female");
					}
					
				}
				else{
					dom_gender.removeClass("ui-btn-active");
					dom_gender.removeClass("ui-icon-male"); dom_gender.removeClass("ui-icon-female");
					dom_gender.addClass("ui-icon-male");
					dom_gender.html("Пол");
				}
				//подсветка меню наций
				if(UserList.Filter.user_nation!=null){
					dom_nation.addClass("ui-btn-active"); 

				}
				else{
					dom_nation.removeClass("ui-btn-active");

				}
				
				//подсветка меню поиска
				if(UserList.Filter.name!=null || UserList.Filter.city!=null || UserList.Filter.country!=null || UserList.Filter.resp!=null || UserList.Filter.raion!=null || UserList.Filter.selo!=null){
					dom_search.addClass("ui-btn-active"); 

				}
				else{
					dom_search.removeClass("ui-btn-active");

				}
			},
			refresh_nation_selectmenu_sp : function(dom_list){
				dom_list.append(Environment.Nations.nations_selectmenu()); 
				dom_list.selectmenu("refresh", true);
			},
			refresh_nation_footer : function(){
				$("#page_usersearch_nation_popup .navbar_footer_nation_ul").append(Environment.Nations.nations_listview()); 
				$("#page_usersearch_nation_popup .navbar_footer_nation_ul").listview("refresh");
				$("#page_usersearch_nation_popup .navbar_footer_nation_ul a").on ("click", UserList.link.btn_nations_onClick);
			},
			btn_details_onClick : function(ev){
				console.log("details clicked");
				var user_id = $(this).attr("user_id");
				var cur_css=$("#userlist_"+user_id+" .add_info").css("display");
				if(cur_css == "none"){
					$("#userlist_"+user_id+" .add_info").css({display : "inline"});
				}
				else
					$("#userlist_"+user_id+" .add_info").css({display : "none"});
				
			}
		}
		
		
	});
	Rpl =new Object({
		watch_online : function(data){
			var page_id = getCurrentPage();
			var found_i=-1;
			Environment.Friends.online.total=0;
			Environment.Friends.online.list = new Array();
			$.each(data, function(i, obj){
				//если активна страница переписки то обновляем статус пользователя
				if(page_id == "page_msg2"){	
					if(obj.id == NavMsg.ActiveUser.id){
						NavMsg.ActiveUser.online_status.code=obj.status;
						//меняем заголовок страницы
						$("#page_msg2 .topheader h1").html(User.html.online_status(NavMsg.ActiveUser,"tiny")+ " "+NavMsg.ActiveUser.name);
						User.html.online_status(NavMsg.ActiveUser, "tiny");
						
					}
				}
				//обновляем статусы друзей
				found_i=Environment.Utils.get_friend_index(Environment.Friends.list, obj.id);
				if(found_i>=0){
					Environment.Friends.list[found_i].online_status.code=obj.status;					
				}
				
				
			});
			//обновляем боковую панель с друзьями онлайн, если она открыта
			$.each(Environment.Friends.list, function(i, obj){ //заполяем по новой объект онлайн
				if(obj.online_status.code==1){
					Environment.Friends.online.list.push(obj);
					Environment.Friends.online.total++;
				}
			});
			if($("#left_panel").hasClass("ui-panel-open")){
				NavLefPanel.Users.display(Environment.Friends.online, "friends_online");
			}
			
		}
	});
	Debug = new Object({
		show : function(){
			var html=get_session()+"<br>";
			html+=User.I.name+"<br>";
			html+=Debug.getCookie("PHPSESSID")+"<br>";
			html+=JSON.stringify(Geo.pos)+"<br>";
			$("#debug_a").html(html);
		},
		getCookie : function(name) {
			var cookie = " " + document.cookie;
			var search = " " + name + "=";
			var setStr = null;
			var offset = 0;
			var end = 0;
			if (cookie.length > 0) {
				offset = cookie.indexOf(search);
				if (offset != -1) {
					offset += search.length;
					end = cookie.indexOf(";", offset)
					if (end == -1) {
						end = cookie.length;
					}
					setStr = unescape(cookie.substring(offset, end));
				}
			}
			return(setStr);
		}
	});
	Environment = new Object({
		Dics : Object(),
		Friends : Object(),
		OnlineUsers : Object(),
		System : { LastAjaxCall : Object(), popupclose_timeout_id: -1},
		init : function (data){
			Environment.Dics = data.dics;
			Environment.Friends = data.friends;
			Environment.OnlineUsers = data.online_users;
			//здесь будет обновление всего UI клиента
			//обновление боковой панели
			User.I = data.myInfo;
			NavLefPanel.turnOn(data);
			NavMsg.LoadMsgList(data.msg_list);
			//Устанавливаем  обработчики RealPlexor (вынести в функцию или объект)
			//Подключаем RealPlexor
			
			realplexor.subscribe("u"+data.myInfo.id, function(data, id) {
				if(data.type=="msg" || data.type==null){
					//console.log(data);
					NavMsg.RplIncome(data);//обработчик входящих сообщений
				}
				else
				if(data.type=="typing" ){
					//console.log(data);
					NavMsg.Utils.keyPress.rec_handler(data);//обработчик входящих сообщений
				}
			});
			//подписываемся на общий канал оповещений
			
			realplexor.subscribe("general_evants", function(data, id) {
				if(data.type=="watch_online"){
					Rpl.watch_online(data.stat_array);
					//console.log(data.stat_array); 
				}				
			});
			
			realplexor.execute();
			//Инициализируем геопозиционирование
			Geo.init();
			//Загружаем обновления
			Evants.init();
			Evants.total_all=data.evants.total_all;
			Evants.list=data.evants.evants;
			Evants.Display(data.evants, Evants.url_params);
			//считываем с объектов оповещения и отображаем баджеры на боковой панели
			NavLefPanel.Ntfy.refresh();
			
		},
		Nations : {
			nations_selectmenu : function(selected_id){
				var html="";
				var html_selected="";
				$.each(Environment.Dics.nations, function(key,obj){
					if(obj.id == selected_id)
						html_selected="selected";
					else
						html_selected="";
					html+="<option value='"+obj.id+"' "+html_selected+">"+Environment.Nations.modify(obj.title, "ая")+"</option>";
				});
				return html;
			},
			nations_listview : function(selected_id){
				var html="";
				var html_selected="";
				$.each(Environment.Dics.nations, function(key,obj){
					if(obj.id == selected_id)
						html_selected="selected";
					else
						html_selected="";
					html+="<li><a href='' nation_id='"+obj.id+"'>"+Environment.Nations.modify(obj.title, "ая")+"</a></li>";
				});
				return html;
			},
			modify : function(nation_str, postfix){
				if(!nation_str)
					return null;
				else
					return nation_str.substr(0,nation_str.length-2)+postfix;
			},
			nation_by_id : function(id){ //type=title, nationality
				var found_i=-1;
				$.each(Environment.Dics.nations, function(key,obj){
					if(obj.id == id){
						found_i = key;
					}
				});
				if(found_i>=0)
					return Environment.Dics.nations[found_i];
				else
				if(id==100)
					return {title: "Не тематический", nationality: ""};
				else
					return {title: "", nationality: ""};
			}
		},
		Utils : {
			is_friend : function(user_id){
				var found_i=-1;
				$.each(Environment.Friends.list, function(key,obj){
					if(obj.id == user_id){
						found_i = key;
					}
				});
				if(found_i>=0)
					return true
				else
					return false;
			},
			get_friend_index : function(listObj, user_id){
				var found_i=-1;
				$.each(listObj, function(key,obj){
					if(obj.id == user_id){
						found_i = key;
					}
				});
				return found_i;
			},
			retryAjax : function(ev){
				clearTimeout(Environment.System.popupclose_timeout_id);
				$( "#popup_window" ).popup( "close");
				$.ajax(Environment.System.LastAjaxCall);
			},
			refresh_public_navbar : function (navbar_id, active_class){
				$(navbar_id+" .btn-evants").removeClass("ui-btn-active");
				$(navbar_id+" .btn-fotos").removeClass("ui-btn-active");
				$(navbar_id+" .btn-music").removeClass("ui-btn-active");
				$(navbar_id+" .btn-users").removeClass("ui-btn-active");
				$(navbar_id+" ."+active_class).addClass("ui-btn-active")
			}
		},
		ShowVotes: function(base, t_key, page_id){
			var params = {method : "getMarks", base: base, t_key: t_key};
			var html;
			var list;
			$.get( LS("server/proc_votes.php"), params, 
				function( data ) {
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							console.log(data); 
							if(data.votes!=null)
								list='<li data-role="list-divider">Оценка: '+data.rating+'</li>';
							$.each(data.votes, function(key,obj){
								console.log(obj);
								list+='<li class="ui-shadow" id="votelist_'+obj.user.id+'" user_id="'+obj.user.id+'">';
								list+='<img src="'+User.html.avatar_url(obj.user.foto,60)+'" class="userlist_afoto user-avatar-circle" user_id="'+obj.user.id+'"> ';
								list+='<h2>'+User.html.online_status(obj.user, "tiny")+" "+ User.html.gender(obj.user)+ " " + obj.user.name+'</h2>'; 
								list+='<p>'+User.html.translate(obj.user, "ru", "оценил")+" на "+ User.html.mark_icon(obj.mark)+'</p>'; 
								list+='</li>';
							});
							html='<div data-role="popup"  id="popup_votes" class="ui-content" style="max-width:300px; z-index:99;"><a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Закрыть</a>';
							html+='<ul id="popup_votes_list" data-role="listview" data-theme="a" >'+list+'</ul></div>';
							var popup_obj=$("#" +page_id).append(html);
							$( "#popup_votes" ).popup();
							$( "#popup_votes_list" ).listview();
							$( "#popup_votes" ).popup( "open", {PositionTo : "window"} );
							//событие на клик по аватарке
							$( "#popup_votes .user-avatar-circle").off("vclick");
							$( "#popup_votes .user-avatar-circle").on("vclick", UserPage.Go);
							
							
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
				},
				"json"
			);			
		}
	});
	//Геопозиционирование
	Geo = new Object({
		is_supported : false,
		pos : {x :-1, y: -1, time: getUnixTime()},
		init : function(){
			//проверка поддержки geo
			if(GLOBAL_APP_VERS.type == "web_mobile"){
				if(navigator.geolocation) {
					Geo.is_supported = true;
				} else {
					Geo.is_supported = false;
				}
			}
			
			if(Geo.is_supported){
				var pos_str;
				var pos_obj;
				if(GLOBAL_APP_VERS.type == "web_mobile"){
					pos_str = getCookie("m_geo");
				}
				else
				if(GLOBAL_APP_VERS.type == "app_mobile"){					
					pos_str = window.localStorage.getItem("geo");
				}
				if(pos_str!=null){
					pos_obj = JSON.parse(pos_str);
					//если последнее обновление было более 10 мин назад то запрашиваем координаты. Или координаты другого юзера
					if((parseInt(pos_obj.time)+600 < getUnixTime()) || (pos_obj.id!=User.I.id)){
						Geo.Get();
					}
				
				}
				//если в хранилище нет данных то запрашиваем с сервера
				else{
					Geo.Get();
				}
				
			}
			
		},
		Get : function(){
			if(GLOBAL_APP_VERS.type == "web_mobile"){
				navigator.geolocation.getCurrentPosition(function(position) {
					var latitude = position.coords.latitude;
					var longitude = position.coords.longitude;
					var local_info = {x: String(latitude), y: String(longitude), time: String(getUnixTime()), id: User.I.id};
					
					Geo.pos = {x: latitude, y: longitude, time: getUnixTime()};
					Geo.Send(Geo.pos);
					if(GLOBAL_APP_VERS.type == "web_mobile"){
						setCookie("m_geo", JSON.stringify(local_info));
					}
					else
					if(GLOBAL_APP_VERS.type == "app_mobile"){					
						window.localStorage.removeItem("geo");
						window.localStorage.setItem("geo", JSON.stringify(local_info));
					}
					
				});	
			}
		},
		Send : function(pos){
			var params = pos;
			params.method = "setLocation";
			$.get( LS("server/proc_geo.php"), params, 
				function( data ) {
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							
						}
						else{
							if(GLOBAL_APP_VERS.type == "web_mobile"){
								setCookie("m_geo", null);
							}
							else
							if(GLOBAL_APP_VERS.type == "app_mobile"){	
								window.localStorage.removeItem("geo");
							}
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
				},
				"json"
			);
		},
		Map : {
			obj : Object(),
			canvas_id: "map_canvas",
			initialize : function(){
				var map_options = {
					zoom: 9,
					center: new google.maps.LatLng(55.752198, 37.619044)
				};
				Geo.Map.obj = new google.maps.Map(document.getElementById(Geo.Map.canvas_id), map_options);
				Geo.Map.Show();
			},
			init : function() {
			  var script = document.createElement('script');
			  script.type = 'text/javascript';
			  script.src = 'http://maps.google.com/maps/api/js?sensor=false&' + 'callback=Geo.Map.initialize';
			  document.body.appendChild(script);
			},
			DisplayUsers : function(geo_user_arr){
				var markerImg = new Object();
				var pos = new Object();
				var infowindow = new Object();
				var marker = new Object();
				$.each(geo_user_arr, function(key, geo_user){
					//определяем формат маркера
					markerImg = new google.maps.MarkerImage(
						User.html.avatar_url(geo_user.user.foto,40),
						new google.maps.Size(50,50),
						new google.maps.Point(0,0),
						new google.maps.Point(0,50)
					);
					//местоположение
					pos = new google.maps.LatLng(geo_user.pos[0], geo_user.pos[1]);
					//тултип
					infowindow[key] = new google.maps.InfoWindow({
					 content: geo_user.user.name
					});
					
					//ставим маркер
					marker[key] = new google.maps.Marker({
					  icon: markerImg,
					  position: pos, 
					  map: Geo.Map.obj,
					  title: geo_user.user.name
					});
					google.maps.event.addListener(marker[key], 'click', function() {
					  infowindow[key].open(Geo.Map.obj, marker[key]);
					});
				});
			},
			Show : function(type){
				var params = {method: "getUsersLocation"}
				$.get( LS("server/proc_geo.php"), params, 
					function( data ) {
						if(data.auth_status=="success" ){
							if(data.method_status=="success"){
								console.log(data);
								Geo.Map.DisplayUsers(data.geo_users);
							}
							else{
								show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
							}
							
						}
					},
					"json"
				);
			}
			
			
		},
		Page : {
			Go : function(){
				$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_map"), { transition: "none"} );
				Geo.Map.init();
			}
		}
	});
	//Комментарии
	Comments = new Object({ 
		list : Object(), //активная переписка
		source : Object(),
		ActiveUser : Object(),
		loading_data : 0,
		el_per_page: 32,
		total_all : 0,
		params: Object(),
		init : function(){
			Comments.loading_data=0;
			Comments.el_per_page=32;
			Comments.total_all=0;
			Comments.list = new Object();
			Comments.ActiveUser = new Object();
			Comments.Utils.hold_pressed = false;
			//очищаем стек выделенных сообщений и добавляем событие на клик
			Comments.Utils.stack = new Array();
			Comments.params = new Object();
			Comments.Utils.refresh_del_btn();
			Comments.Utils.shown=false;
			//обнуляем форму
			$("#nav-comment-txtarea").val("");
			$("#nav-sendcomment-btn").attr("reply_to","");
			
			
		},
		
		//обработка входящего comet сообщения. объект имеет такую же структуру что и Comments.MsgListObj
		RplIncome : function(data){
			
		},
		OpenComments : function(t_key, base){
			console.log(PS.isShown);
			//очищаем предыдущую переписку
			$("#comments-list").remove();
			Comments.init();
			$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_comment") );
			
			
			//загружаем данные с сервера и прорисовываем
			Comments.params={ method: "getComments", 
							t_key: t_key, 
							base: base,
							initial: 1, 
							el_per_page : Comments.el_per_page,
							last : 0
							};
			Comments.getCommentsFromServer(Comments.params);
			//обновляем ссылки, кнопки и тд
			$("#nav-sendcomment-btn").attr("t_key", t_key); //меняем парметр кнопки
			$("#nav-sendcomment-btn").attr("base", base); //меняем парметр кнопки
			
		}, 
		getCommentsFromServer : function(params){
			Comments.loading_data=1;
			$.get( LS("server/proc_comments.php"), params, 
				function( data ) {
					console.log(data);
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							Comments.total_all = data.total_all;
							Comments.params = params;
							
							//если первая загрузка
							if(params.initial == 1){
								Comments.list = data.comments;
								Comments.ActiveUser = data.owner_user;
								Comments.source = data.resource;
								Comments.Display(data);
							}
							//Если запрос отправлен для догрузки сообщений
							else{
								Comments.list=Comments.list.concat(data.comments);
								$.each(data.comment,  function (i, comment){
									
									if(i>0){
										if(how_long_time(timestamp2date(comment.time)).day!=how_long_time(timestamp2date(data.comment[i-1].time)).day){ //время отправки сообщения
											$("#comments-list").append("<div class='daysdevider'>"+how_long_time(timestamp2date(comment.time)).day+"</div>");
										}
									}
									Comments.SingleComment.Add({comment: comment},  "append");
									//console.log(message); 
								}); 
							}
							
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
					Comments.loading_data=0;
				},
				"json"
			)
			.fail(function(){
					Comments.loading_data=0;
				});
		},
		GoAppend : function(){ //отрабатывает для догрузки данных
			var params=Comments.params;
			if(Comments.list.length<Comments.total_all){
				params.last=Comments.list.length;
				params.initial=0;
				Comments.getCommentsFromServer(params);
			}
		},
		//визуализация комментариев при первой загрузке
		Display : function(data){   
			var html_="";
			var i=0;
			var user = new Object();
			//ресурс-----------
			$("#comments-source").removeClass("music");
			$("#comments-source").removeClass("fotos");
			$("#comments-source").removeClass("clips");
			//фотки
			if((data.resource.base == "fotos") || (data.resource.base == "users_fotos")){
				$("#comments-source").addClass("foto");
				html_="<div class='comments-foto'><img src='" +Fotos.Utils.foto_url(data.resource,800)+"'><div class='overlay'><i class='fa fa fa-chevron-circle-down'></i></div></div>";
				$("#comments-source").html(html_);
				$("#comments-source .comments-foto").off("vclick");
				$("#comments-source .comments-foto").on("vclick", Comments.Utils.onShow);
			}
			//музыка
			if((data.resource.base == "music")){
				$("#comments-source").addClass("music");
				Music.init();
				Music.Single.insert("comments-source", data.resource);
			}
			//видео
			if((data.resource.base == "clips")){
				$("#comments-source").addClass("clips");
				if(data.resource.yt==1)
					html_='<iframe class="youtube-player" type="text/html" width="560" height="315" src="http://www.youtube.com/embed/'+data.resource.path+'" frameborder="0"></iframe>';
				else
					html_='<h2>Просмотр этого видео доступно только в полной версии</h2>';
				$("#comments-source").html(html_);
			}
			//панель
			Comments.Bar.refresh();
			
			//лист комментариев--------
			html_='<div  id="comments-list">';
			if(!data.comments.length){
				html_+="<div style='text-align:center;'>Станьте первым, кто напишет здесь комментарий.</div>";
			}
			else{
				$.each(data.comments, function(key,comment){ 
					if(i>0){
						if(how_long_time(timestamp2date(data.comments[i].time)).day!=how_long_time(timestamp2date(data.comments[i-1].time)).day){
							html_+="<div class='daysdevider'>"+how_long_time(timestamp2date(data.comments[i].time)).day+"</div>";
						}
					}
					html_+=Comments.SingleComment.getHTML(comment);
					i++;
				});
			}
			html_+='</div>';
			
			$("#comments-div").html(html_);
			//меняем заголовок страницы
			$("#page_comment .topheader h1").html(User.html.online_status(data.owner_user,"tiny")+ " "+data.owner_user.name);
			$("#page_comment .topheader h1").attr("user_id", data.owner_user.id);
			//добавляем смайлы и тд к полученной переписке
			$("#page_comment .talktext p").text2richtext(); 
			$("#page_comment .talk-bubble").off("taphold");
			$("#page_comment .talk-bubble").off("vclick");
			$("#page_comment .talk-bubble").on("taphold", Comments.Utils.onHold);
			$("#page_comment .talk-bubble").on("vclick", Comments.Utils.onSelect);
			//gпереход на страницу пользователя
			$("#comments-list .user-avatar-rounded").off("vclick");
			$("#comments-list .user-avatar-rounded").on("vclick", UserPage.Go); 
			
			
			
			
		},
		SendCommentHandler : function (){
			var msg_text=$("#nav-comment-txtarea").val();
			var params = {
				method: "postComment",
				msg: msg_text,
				t_key: $(this).attr("t_key"),
				base: $(this).attr("base"),
				reply_to: $(this).attr("reply_to")
			};
			
			$.get( LS("server/proc_comments.php"), params, 
				function( data ) {
					if(data.auth_status=="success"){
						if(data.method_status=="success"){
						//рисуем диалог
							Comments.SingleComment.Add(data, "prepend");
							//обработка обновления спиков диалогов и переписки
							Comments.Utils.process_add(data, "outcome");
							//добавляем сообщение в массива
							Comments.list.unshift(data.comment);
							//звуковое сопровождение
							Audio_.outcome_msg.play();
							console.log("SendCommentHandlerHandler. Получен ответ " + JSON.stringify(data));	
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{ 
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
						console.log("SendMsgHandler");
				},
				"json"
			);
		},
		Like : function(ev){
			ev.preventDefault();
			var params= {base: $(this).attr("base"), t_key: $(this).attr("t_key"), value: $(this).attr("mark"), method: "putMark"};
			$.get( LS("server/proc_votes.php"), params, 
				function( data ) {
					console.log(data);
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							//Обновляем  оценки
							Comments.source.rating=data.vote.rating;
							Comments.source.voted=1; //метим что оценка проставлена
							Comments.Bar.refresh();			
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}	
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
				},
				"json"
			);
			
		},
		SingleComment : Object({ 
			getHTML : function(comment){
				var html_="";
				
				html_+="<div id='comment_"+comment.num+"'>";
				if(comment.user.id==User.I.id){
					html_+='<div style="float:right"><img src="'+User.html.avatar_url(comment.user.foto,60)+'" user_id = "'+comment.user.id+'" class="user-avatar-rounded"></div>';
					html_+='<div class="talk-bubble me tri-right round right-in" style="float:right"  user_id ="'+comment.user.id+'" name ="'+comment.user.name+'" comment_id="'+comment.num+'">';
					}
				else{
					html_+='<div style="float:left"><img src="'+User.html.avatar_url(comment.user.foto,60)+'" user_id = "'+comment.user.id+'" class="user-avatar-rounded"></div>';
					html_+='<div class="talk-bubble another tri-right round left-in" user_id ="'+comment.user.id+'" name ="'+comment.user.name+'" comment_id="'+comment.num+'">';
					}
				html_+='		<div class="talktext">';
				html_+='		<div class="options">'+User.html.online_status(comment.user, "tiny")+" "+ User.html.gender(comment.user)+ ' <b>'+comment.user.name+'</b> '+how_long_time(timestamp2date(comment.time)).msg_label+'</div>';
				html_+='			<p>'+ comment.text +'</p>';
				html_+='		</div>';
				html_+='</div>';
				html_+="</div>";
				html_+='<div style="clear:both"></div>';
				return html_;
			},
			Add : function(data, append_type){
				var new_msg_dom= new Object();
				if(append_type == "prepend"){
					$("#comments-list").prepend(Comments.SingleComment.getHTML(data.comment));
					$.mobile.silentScroll(0);
				}
				else
				if(append_type == "append"){
					$("#comments-list").append(Comments.SingleComment.getHTML(data.comment));
				}

				new_msg_dom=$("#comment_"+data.comment.num+" .talktext p");
				new_msg_dom.text2richtext();
				//добавляем эффект
				clickEffect1($("#comment_"+data.comment.num+" .talk-bubble"));
				//обработчики клика на сообщение
				$("#comment_"+data.comment.num+" .talk-bubble").on("taphold", Comments.Utils.onHold);
				$("#comment_"+data.comment.num+" .talk-bubble").on ( "vclick", Comments.Utils.onSelect);
				$("#comments-list .user-avatar-rounded").off("vclick");
				$("#comments-list .user-avatar-rounded").on("vclick", UserPage.Go); 
				
			}
		}),
		Delete :{
			//Выполняется при клике на кнопки удаления
			Do: function(ev){
				ev.preventDefault();
				var del_type=$(this).attr("del_type"); //all - все сообщения; selected - выбранные сообщения диалога
				var params = new Object();
				var error=0;
				var base;
				if(Comments.source.base == "users_fotos")
					base="comments2";
				else
					base="comments";
				// определяем параметры запроса
				if(del_type=="selected"){
					if(Comments.Utils.stack.length>0){
						var track_num = Comments.Utils.stack.join(",");
					}
					else
						error=1;
					params = {base: base, track_num: track_num, del_type : del_type};
				}
				else
				if(del_type=="all"){
					params = {base: base, base2: Comments.base, track_num: Comments.t_key, opt: "all", del_type : del_type};
				}
				if(!error){
					$.get( LS("server/proc_delete.php"), params, 
						function( data ) {
							if(data.auth_status=="success"){
								if(data.method_status=="success"){
								//обрабатываем успешное удаление
									Comments.Delete.Handle(params);
								}
								else{
									show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
								}
								
							}
							else{ 
								console.log("Сессия не существует на сервере." + JSON.stringify(data));	
								gl_logout();
							}
							
						},
						"json" 
					);
				}
			},
			//манипуляция с интерфейсом после успешного удаления с сервера
			Handle : function(params){
				if(params.del_type=="selected"){
					var stack = params.track_num.split(",");
					var i=0;
					//уменьшаем число комментариев
					Comments.source.comments = Comments.source.comments - stack.length;
					Comments.Bar.refresh();
					for(i=0;i<stack.length;i++){
						$("#comment_"+stack[i]).remove();
						//удаляем из объекта переписки
						var found_msg = Comments.Utils.get_comment_index(stack[i]);
						if(found_msg>=0){
							Comments.list.splice(found_msg,1);
						}
					}
					Comments.Utils.stack = new Array();
					$("#page_comment-trashbutton").css({display : "none"});
					$("#page_comment-trashbutton i").html("");	
				}
				else
				if(params.del_type=="all"){
					$("#comment-list").html(""); 
					$("#page_comment_confirm_delete").popup("close");
					//удаляем из объекта переписки
					Comments.list = new Object();
				}
			}
			
		},
		Go : function(ev){
			ev.preventDefault();
			var base=$(this).attr("base");
			var t_key=$(this).attr("t_key");
			Comments.OpenComments(t_key,base);
					
		},
		Bar : {
			refresh : function(){
				var source = Comments.source;
				//сколько комментов
				if(source.comments>0){
					$("#comments-content span.comments").html(source.comments); 
				}
				else{
					$("#comments-content span.comments").html("");
				}
					
				//сколько лайков
				if(source.rating){
					$("#comments-content span.rating").html('<i class="fa fa-heart-o"></i>: ' + source.rating);
				}
				else{
					$("#comments-content span.rating").html("");
				}
				//добавляем атрибуты к ссылке
				$("#comments-content .btn-like, #comments-content .btn-unlike, #comments-content span.rating").attr("t_key", source.num);//like
				$("#comments-content .btn-like, #comments-content .btn-unlike, #comments-content span.rating").attr("base", source.base);//like
				$("#comments-content .btn-like").attr("mark", "plus");//like
				$("#comments-content .btn-unlike").attr("mark", "minus");//like

				//Лайк
				$("#comments-content .btn-like, #comments-content .btn-unlike").off("vclick");
				if(!source.voted)
					$("#comments-content .btn-like, #comments-content .btn-unlike").on("vclick", Comments.Like); 
				//Сколько лайков
				$("#comments-content span.rating").off("vclick");
				if(source.rating!=0)
					$("#comments-content span.rating").on("vclick", Comments.Utils.onShowVotes);
			}
			
		},
		Utils : { 
			hold_pressed: false,
			shown : false,
			process_add : function(msgObj, type){
				$("#nav-comment-txtarea").val("");
				$("#nav-sendcomment-btn").attr("reply_to","");
				Comments.source.comments++;
				Comments.Bar.refresh();
			},
			
			refresh_notification: function(){
				
			},
			refresh_del_btn : function(){
				//рисуем кнопку удаления
				if(Comments.Utils.stack.length>0){
					$("#page_comment-trashbutton").css({display : "inline-block"});
					$("#page_comment-trashbutton i").html(Comments.Utils.stack.length);	
				}
				else{
					$("#page_comment-trashbutton").css({display : "none"});
					$("#page_comment-trashbutton i").html("");	
					//выходим из режима удаления
					Comments.Utils.hold_pressed=false;
				}
			},
			get_comment_index: function(msg_num){
				var found_i=-1;
				var i=0;
				$.each(Comments.list, function(key, obj){
					//если входящее сообщение из существующего списка то обновляем счетчик
					if(obj.num==msg_num){
						found_i=i;
					}
					i++;
				});
				return found_i
			},
			stack : Array(),
			//если нажали и держим
			onHold : function(){
				var comment_id =$(this).attr("comment_id");
				//если это первое нажатие, то переходим в режим удаления
				if(!Comments.Utils.hold_pressed){
					if(Comments.list[Comments.Utils.get_comment_index(comment_id)].user.id == User.I.id || Comments.ActiveUser.id == User.I.id ){
						console.log("перешли в режим удаления");
						Comments.Utils.hold_pressed=true;
					}
				}
			},
			onSelect : function(ev){ //при клике на textbubble
				ev.preventDefault(); 
				var comment_id = $(this).attr("comment_id");
				var stack_pos = -1;
				//если мы в режиме удаления, то выделяем для удаления
				if(Comments.Utils.hold_pressed && (Comments.list[Comments.Utils.get_comment_index(comment_id)].user.id == User.I.id || Comments.ActiveUser.id == User.I.id)){
					console.log("выделил для удаления");
					stack_pos = Comments.Utils.stack.indexOf(comment_id);
					//если есть то удаляем
					if(stack_pos>=0){
						Comments.Utils.stack.splice(stack_pos,1);
						$("#comment_"+comment_id+" .talk-bubble").removeClass("selected");
					}
					else
					//если нет то добавляем
					{
						Comments.Utils.stack.push(comment_id);
						$("#comment_"+comment_id+" .talk-bubble").addClass("selected");
					}
					Comments.Utils.refresh_del_btn();
				}
				else{
					console.log("клик для ответа");
					clickEffect1($(this)); 
					var reply_to = $(this).attr("user_id");
					var name = $(this).attr("name");
					if(reply_to!=User.I.id){
						$("#nav-sendcomment-btn").attr("reply_to",  reply_to);
						$("#nav-comment-txtarea").val(name+", ");	
					}					
				}
				
			},
			
			confirm : function(){ //вызывает окноп подтверждения для удаления всех сообщений
				console.log($(this).attr("option_type"));
				if($(this).attr("option_type")=="delete_all"){
					$("#page_comment_menu").popup("close");
					setTimeout(function(){$("#page_comment_confirm_delete").popup("open")},500);
				}
				else
				if($(this).attr("option_type")=="ban"){
					$("#page_comment_menu").popup("close"); 
				}
				
			},
			onShow : function(ev){
				ev.preventDefault();
				var h = $(".comments-foto img").height();
				if(!Comments.Utils.shown){
					$(".comments-foto").velocity({height: h},400)
					Comments.Utils.shown = true;
					$(".comments-foto .overlay").html('<i class="fa fa fa-chevron-circle-up"></i>');
				}
				else{
					$(".comments-foto").velocity({height: "5em"},200)
					Comments.Utils.shown = false;
					$(".comments-foto .overlay").html('<i class="fa fa fa-chevron-circle-down"></i>');
				}
				
			},
			onShowVotes : function(ev){
				ev.preventDefault();
				var base= $(this).attr("base");
				var t_key= $(this).attr("t_key");
				var page_id= $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id");
				Environment.ShowVotes(base,t_key,page_id);
			}
		}
		
	});
	//События
	Evants =  new Object({
		list : Object(),
		ps_list : Array(),
		mus_list : Array(),
		el_per_page : 10,
		loading_data : 0,
		total_all: 0,
		url_params : Object(),
		new_ : Object(),
		init : function(){
			Evants.list = new Object();
			Evants.ps_list = new Array();
			Evants.mus_list = new Array();
			Evants.new_ = new Array();
			Evants.el_per_page = 10;
			Evants.loading_data =0;
			Evants.total_all = 0;
			Evants.url_params = {method: "getEvants", initial: 1, user_id: User.I.id, el_per_page: Evants.el_per_page, last: 0};
			Music.init();
			
		},
		//переходим на страницу с подгрузкой данных
		Go : function (){
			Evants.init();
			$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_evants"), { transition: "slide", reverse: true} );			
			$("#page_evants .navbar-public").css({display : "block"});
			Environment.Utils.refresh_public_navbar("#page_evants .navbar-public", "btn-evants");
			Evants.Load(Evants.url_params);
			
		},
		Load : function(params){ 
			Evants.loading_data=1;
			$.get( LS("refresh_ui.php"), params, 
				function( data ) {
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							Evants.total_all=data.evants.total_all;
							//если загрузка инициализирующая
							if(params.initial==1){
								//рисуем страницу событий
								Evants.list=data.evants.evants;
								Evants.Display(data.evants, params);
							}
							//если догрузка событий
							else{
								if(data.evants.evants.length>0){
									Evants.list=Evants.list.concat(data.evants.evants);
									Evants.Display(data.evants, params);
								}
							}
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}
						
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
					Evants.loading_data=0;
				},
				"json"
			);
		},
		SingleEvant : {
			html : function(evant_obj){
				var i=0;
				var html="";
				var html_body="";
				var html_source="";
				var base="";
				var html_comments="";
				var html_footer="";
				var source_class_name="";
				var comment_obj =  new Object();
				if(evant_obj!=null){
					if(evant_obj.ntfy == 1)
						var bar_class_name = "ntfy";
					else
						var bar_class_name ="";
					html='<div class="ui-corner-all rounded-corners" id="ev_'+evant_obj.num+'">'; 
					html+='<div class="ui-bar ui-bar-a '+bar_class_name+'">';
						html+='<h3 >';
							html+='<div user_id = "'+evant_obj.user.id+'"  class="user-foto user-go"><img src="'+User.html.avatar_url(evant_obj.user.foto,40)+'"  class="user-avatar-rounded"></div>';
							html+=' <div user_id = "'+evant_obj.user.id+'" class="user-name user-go">'+User.html.online_status(evant_obj.user, "tiny")+" "+ User.html.gender(evant_obj.user)+ ' '+evant_obj.user.name+'</div>';
							if(evant_obj.ntfy == 1){
								html+='<div class="ui-btn-right"><i ev_id="'+evant_obj.num+'" ev_source_type="'+evant_obj.source_type+'" ev_type="'+evant_obj.type+'" class="fa fa-times-circle-o  fa-lg fa-button-theme-a btn-close"></i></div>';
							}
							else{
								html+='<div class="ui-btn-right evant-time">'+how_long_time(timestamp2date(evant_obj.time)).day+'</div>';
							}
						html+='</h3>';
					html+='</div>';
					html+='<div class="ui-body ui-body-a"><p>';
					//если добавление фотографий
					if(evant_obj.type == 1 || evant_obj.type == 2){
						html_body+=User.html.translate(evant_obj.user, "ru", "Загрузил")+ " ";
						if(evant_obj.amount>0){
							html_body+= evant_obj.amount+" "+NumSklon(evant_obj.amount, ['новую фотографию', 'новые фотографии', 'новых фотографий']);
						}
						else
						html_body+= "новую фотографию";
					}
					//если добавление песен
					if(evant_obj.type == 3){
						html_body+=User.html.translate(evant_obj.user, "ru", "Загрузил")+ " ";
						if(evant_obj.amount>0){
							html_body+= evant_obj.amount+" "+NumSklon(evant_obj.amount, ['новую песню', 'новые песни', 'новых песен']);
						}
						else
						html_body+= "новую песню";
					}
					//если добавление песен в плей-лист
					if(evant_obj.type == 7){
						html_body+=User.html.translate(evant_obj.user, "ru", "Добавил")+ " ";
						if(evant_obj.amount>0){
							html_body+= evant_obj.amount+" "+NumSklon(evant_obj.amount, ['новую песню в свой плейлист', 'новые песни в свой плейлист', 'новых песен в свой плейлист']);
						}
						else
						html_body+= "новую песню в свой плейлист";
					}
					//если добавление видео
					if(evant_obj.type == 13){
						html_body+=User.html.translate(evant_obj.user, "ru", "Добавил")+ " ";
						if(evant_obj.amount>0){
							html_body+= evant_obj.amount+" "+NumSklon(evant_obj.amount, ['новую видеозапись', 'новые видеозаписи', 'новых видеозаписей']);
						}
						else
						html_body+= "новую видеозапись";
					}
					//если оценка 
					if(evant_obj.type == 6 || evant_obj.type == 8 || evant_obj.type == 9 || evant_obj.type == 10 ||(evant_obj.type == 600 || evant_obj.type == 800 || evant_obj.type == 900 || evant_obj.type == 1000)){
						html_body+=User.html.translate(evant_obj.user, "ru", "Оценил")+ " ";
						if(evant_obj.type>100){
							html_body+= "<b>Вашу</b> ";
						}
						switch(parseInt(evant_obj.type)){
							case 6: html_body+="фотографию "
							break;
							case 600: html_body+="фотографию "
							break;
							case 8: html_body+="фотографию "
							break;
							case 800: html_body+="фотографию "
							break;
							case 9: html_body+="песню "
							break;
							case 900: html_body+="песню "
							break;
							case 10: html_body+="видеозапись "
							break;
							case 1000: html_body+="видеозапись "
							break;
						}
						html_body+='на '+User.html.mark_icon(evant_obj.mark);

					}
					//если комментарий
					if(evant_obj.type == 15 || evant_obj.type == 1500){
						if(evant_obj.reply==1)
							html_body+="<b>"+User.html.translate(evant_obj.user, "ru", "Ответил")+ "</b> на Ваш комментарий к ";
						else{
							html_body+=User.html.translate(evant_obj.user, "ru", "Оставил")+ " ";
							if(evant_obj.amount>0){
								html_body+= evant_obj.amount+" "+NumSklon(evant_obj.amount, ['комментарий к ', 'комментария к ', 'комментариев к ']);
							}
							else
							html_body+= "комментарий к ";
						}
						if(evant_obj.type == 1500){
							html_body+= "<b>Вашей</b> ";
						}
						
						switch(evant_obj.source_type){
							case "fotos": html_body+="фотографии "
							break;
							case "music": html_body+="песне "
							break;
							case "clips": html_body+="видеозаписи "
							break;
						}
						html_comments += '<div class="talk-bubble another tri-right round left-in" >';
						html_comments+='		<div class="talktext">';
						html_comments+='			<p style="overflow: hidden;">'+ evant_obj.text +'</p>';
						html_comments+='		</div>';
						html_comments += '</div>';
						
						

					}
					//если новый друг
					if(evant_obj.type == 4){
						html_body+='Теперь дружит с '+User.html.online_status(evant_obj.source, "tiny")+" "+ User.html.gender(evant_obj.source)+ ' <b>'+evant_obj.source.name+'</b>';
					}
					//если поменял аватар
					if(evant_obj.type == 5){
						html_body+=User.html.translate(evant_obj.user, "ru", "Загрузил")+' новую аватарку';
					}
					//если получил подарок
					if(evant_obj.type == 14){
						html_body+=User.html.translate(evant_obj.user, "ru", "Получил")+' новый подарок!';
					}
					//-----------РЕСУРСЫ:
					//фотографии
					if(evant_obj.source_type == 'fotos'){
						if(evant_obj.source.private_foto==1)
							base="users_fotos";
						else
							base="fotos";
						if(evant_obj.source.path.indexOf("small/")==0)
							evant_obj.source.path=evant_obj.source.path.substr(6);
						//если можно перейти к комментариям, то делаем PS
						if(base && parseInt(evant_obj.source.id)){
							html_source+="<div class='comments_fotos'  t_key='"+evant_obj.source.id+"' base='"+base+"'>";
							html_source+="<a href='"+User.html.fotos_url(evant_obj.source.path, evant_obj.source.private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(evant_obj.source.path, evant_obj.source.private_foto, "small")+"'></a>";
							//загоняем скелет списка для PS
							//if(Evants.Utils.get_source_index(evant_obj.source.id, base)==-1){
								Evants.ps_list.push({
								num : evant_obj.num, 
								base: base, 
								source : { num: evant_obj.source.id} 
								});
							//}							
						}
						//иначе нужно перейти к фотогалереи 
						else{
							html_source+="<div class='user-fotos'  t_key='"+evant_obj.source.id+"' base='"+base+"'>";
							html_source+="<img src='"+User.html.fotos_url(evant_obj.source.path, evant_obj.source.private_foto, "small")+"'>";
						}
						html_source+="</div>";
					}
					//клипы
					if(evant_obj.source_type == 'clips'){
						base="clips";
						html_source+="<div class='comments_clips'  t_key='"+evant_obj.source.id+"' base='clips'><img src='"+Video.Utils.shot(evant_obj.source.path,"small")+"'></div>";
					}
					//юзеры
					if(evant_obj.source_type == 'user'){
						html_source+='<div class="user-go"  user_id="'+evant_obj.source.id+'"><img src="'+User.html.avatar_url(evant_obj.source.foto,150)+'" class="user-avatar-rounded"></div>';
					} 
					//музыка
					if(evant_obj.source_type == 'music'){
						base="music";
						//если есть все данные для проигрывания музыки
						if(evant_obj.source.id && evant_obj.source.path){
							Evants.mus_list.push({num: evant_obj.source.id, artist : evant_obj.source.artist, title : null, path : evant_obj.source.path, ev_id : evant_obj.num});
						}
						html_source+="<div class='comments_music'  t_key='"+evant_obj.source.id+"' base='music'>"+evant_obj.source.artist+"</div>";
					} 
					//подарки
					if(evant_obj.source_type == 'gift'){
						html_source+="<div class='gifts-go'  user_id='"+evant_obj.source.id+"'><img src='"+User.html.gift_url(evant_obj.source.path)+"'></div>";
					} 
					
					//футер с кнопками 
					if(base && parseInt(evant_obj.source.id)){
						html_footer+='<div data-role="navbar"  class="footer" data-iconpos="left">';
						html_footer+='	<ul>';
						html_footer+='		<li class="btn-like" ev_id="'+evant_obj.num+'" base="'+base+'" t_key="'+evant_obj.source.id+'" mark="plus"><a href="#" data-icon="thumbs-o-up"  >Нравится</a></li>';
						html_footer+='		<li class="btn-unlike" ev_id="'+evant_obj.num+'" base="'+base+'" t_key="'+evant_obj.source.id+'" mark="minus"><a href="#" data-icon="thumbs-o-down"  >Не нравится</a></li>';
						html_footer+='		<li class="btn-comments" ev_id="'+evant_obj.num+'" base="'+base+'" t_key="'+evant_obj.source.id+'"><a href="#" data-icon="comment-o"  >Комментарии</a></li>';
						html_footer+='	</ul>';
						html_footer+='</div>';
					}
					
					html+=html_body;
					html+=html_source;
					if(html_comments)
						html+=html_comments;
					html+=html_footer;
					html+='</p></div>';
					html+='</div>';
				}
				return html;
			}
		},
		//функция первой отрисовки 
		Display: function(data, params){ 
			var html="";
			if(data.total_all>0){
				var i=0;
				$.each(data.evants, function(key,obj){
					html+= Evants.SingleEvant.html(obj);
					i++;
				});
				if(params.initial==1){
					$("#page_evants_list").html(html);
					$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_evants"), { transition: "none"} );
					$.mobile.silentScroll(0);
				}
				else{
					$("#page_evants_list").append(html);
				}
			
			
				
				
				//добавляем PS к фотографиям и видео
				PS.ReCreate($("#page_evants_list .comments_fotos a"), Evants.ps_list, "ajax");
				//на страницу пользователя
				$("#page_evants_list .user-go").off("vclick");
				$("#page_evants_list .user-go").on("vclick",UserPage.Go);
				//навбар
				$("#page_evants_list .footer").navbar();
				$("#page_evants_list .footer .btn-like, #page_evants_list .footer .btn-unlike").on("vclick",Evants.Like);
				$("#page_evants_list .footer .btn-comments").off("vclick");
				$("#page_evants_list .footer .btn-comments").on("vclick",Comments.Go);
				
				//смайлики
				$("#page_evants .talktext p").text2richtext();  
				//музыка
				$.each(Evants.mus_list, function(key,obj){
					Music.Single.insert("ev_"+obj.ev_id+" .comments_music", obj);
				});
				//мигалка для оповещений
				//$(".ntfy .btn-close").velocity({ opacity: 0.3 },{duration:400, loop: true})
				$(".ntfy .btn-close").off("vclick");
				$(".ntfy .btn-close").on("vclick",Evants.Hide);
				Evants.new_=data.new_;
			}
				
			
		},
		Utils : {
			get_source_index: function(t_key, base){
				var found_i=-1;
				var i=0;
				$.each(Evants.ps_list, function(key, obj){
					//если входящее сообщение из существующего списка то обновляем счетчик
					if(obj.source.num==t_key && obj.base==base){
						found_i=i;
					}
					i++;
				});
				return found_i
			},
			decrease_ntfy_obj : function(source_type, delta){
				if(source_type=="fotos"){
					Evants.new_.fotos=Evants.new_.fotos-delta;
					if(Evants.new_.fotos<0)
						Evants.new_.fotos=0;
				}
				else
				if(source_type=="music"){
					Evants.new_.music=Evants.new_.music-delta;
					if(Evants.new_.music<0)
						Evants.new_.music=0;
				}
				else
				if(source_type=="clips"){
					Evants.new_.clips=Evants.new_.clips-delta;
					if(Evants.new_.clips<0)
						Evants.new_.clips=0;
				}
			}
		},
		onScroll : function(){
			var params=Evants.url_params;
			if(Evants.list.length<Evants.total_all){
				params.last=Evants.list.length;
				params.initial=0;
				Evants.Load(params);
			}
		},
		Like : function(ev){
			ev.preventDefault();
			var ev_id = $(this).attr("ev_id");
			var params= {base: $(this).attr("base"), t_key: $(this).attr("t_key"), value: $(this).attr("mark"), method: "putMark"};
			$.get( LS("server/proc_votes.php"), params, 
				function( data ) {
					console.log(data);
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							//Обновляем  оценки
							//Comments.source.rating=data.vote.rating;
							//Comments.source.voted=1; //метим что оценка проставлена
							//Comments.Bar.refresh();	
							$("#ev_"+ev_id+" .footer .btn-like, #ev_"+ev_id+" .footer .btn-unlike").remove();
							$("#ev_"+ev_id+" .footer ul").removeClass("ui-grid-b"); $("#ev_"+ev_id+" .footer ul").addClass("ui-grid-a");
							$("#ev_"+ev_id+" .footer .btn-comments").removeClass("ui-block-c"); $("#ev_"+ev_id+" .footer .btn-comments").addClass("ui-block-b");
							$("#ev_"+ev_id+" .footer ul").prepend('<li class="count-likes ui-block-a"><i class="fa fa-heart-o fa-lg "></i>: '+data.vote.rating+'</li>')
							console.log(data.vote.rating);							
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}	
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
				},
				"json"
			);
			
		},
		Hide : function(ev){
			ev.preventDefault();
			var ev_id = $(this).attr("ev_id");
			var ev_type = $(this).attr("ev_type");
			var ev_source_type = $(this).attr("ev_source_type");
			var params= {ev_id: ev_id, ev_type: ev_type, method: "hideEvant"};
			Evants.Utils.decrease_ntfy_obj(ev_source_type,1);
			NavLefPanel.Ntfy.refresh();
			$("#ev_"+ev_id).velocity("fadeOut", {duration :1000});
			$.get( LS("refresh_ui.php"), params, 
				function( data ) {
					console.log(data);
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){

							console.log(data);							
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}	
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
				},
				"json"
			);
		}
		
	});
	//Видео
	Video = new Object({
		Utils : {
			shot : function(path, size){
				if(size == "small")
					return "http://video.shaxdag.com/shots/small/"+path;
			}
		}
	});
	PS = new Object ({
		list : Object(),
		GoAppend_f : Object(),
		cursor: 0,
		mode: 0,
		isShown: 0,
		OnDisplay : function(e){
			/* здесь должна быть функция call-back для подгрузки нового контента. Надо подумать как передать ее в качестве параметра 
			if((e.index==(PS.list.length-3)) && e.action=="next" && PS.GoAppend_f!=null){
				PS.GoAppend_f();
			}
			*/
			//если мы в режиме подгрузки данных, и данных нет, то обновляем
			if(PS.mode == "ajax" && PS.list[e.index].user==null){
				PS.refreshFromServer(e.index);
			}
			else{
				PS.cursor=e.index;
				PS.Toolbar.refresh(); 
				PS.Toolbar.refresh_caption();
			}
			//если доступ закрыт
			if(PS.list[e.index].lock == 1){
				$(".ps-carousel-item-"+[e.index]+" img").attr("src", "http://www.iconsearch.ru/uploads/icons/siena/128x128/lockblue.png");
				$(".ps-carousel-item-"+[e.index]+" img").css({width: "100px", height: "100px", top: "50%", left: "50%"});
			}
		},
		
		onShow : function(e){
			PS.isShown=1;
		},
		onHide : function(e){
			PS.isShown=0;
		},
		Toolbar :{
			get : function(){ 
				var html;
				if(PS.list.length==1)
					var css_visibility="visibility: hidden;";
				html='<div class="ps-toolbar-close ps-btn-close" ><i class="fa fa-times fa-lg fa-button-theme-a"></i></div>';
				html+='<div class="ps-toolbar-previous ps-btn-back" style="'+css_visibility+'"><i class="fa fa-chevron-left fa-lg fa-button-theme-a"></i></div>';
				html+='<div class="ps-btn-like" base="" t_key=""><i class="fa fa-heart-o fa-lg fa-button-theme-a"></i><span></span></div>'; 
				html+='<div class="ps-btn-comments"><i class="fa fa-comment-o fa-lg fa-button-theme-a"></i><span></span></div>'; 
				html+='<div class="ps-toolbar-next ps-btn-forward" style="'+css_visibility+'"><i class="fa fa-chevron-right fa-lg fa-button-theme-a"></i></div>';
				return html;
			},
			refresh : function(){
				var base = PS.list[PS.cursor].base;
				//сколько комментов
				if(PS.list[PS.cursor].source.comments>0){
					$(".ps-btn-comments span").html(PS.list[PS.cursor].source.comments); 
				}
				else{
					$(".ps-btn-comments span").html(""); 
				}
				//сколько лайков
				if(PS.list[PS.cursor].source.rating){
					$(".ps-btn-like span").html(PS.list[PS.cursor].source.rating);
					if(PS.list[PS.cursor].source.rating>0)
						$(".ps-btn-like span").css({color: "rgb(85, 212, 51)"});
					else
					if(PS.list[PS.cursor].source.rating<0)
						$(".ps-btn-like span").css({color: "rgb(229, 66, 38)"});
				}
				else{
					$(".ps-btn-like span").html("");
				}
				//добавляем атрибуты к ссылке
				$(".ps-btn-like").attr("t_key", PS.list[PS.cursor].source.num);//like
				$(".ps-btn-like").attr("base", base);
				$(".ps-btn-comments").attr("t_key", PS.list[PS.cursor].source.num);//comment
				$(".ps-btn-comments").attr("base", base);
				
					
				if(PS.list[PS.cursor].voted!=null){
					$(".ps-btn-like i").removeClass("fa-heart-o");
					$(".ps-btn-like i").addClass("fa-heart");
				}
				else{
					$(".ps-btn-like i").removeClass("fa-heart"); 
					$(".ps-btn-like i").addClass("fa-heart-o");
				}
			},
			refresh_caption : function(){
				var html;
				var user = PS.list[PS.cursor].user; 
				//если данные есть, то обновляем заголовок
				if(user!=null){
					html='<div class="avatar" user_id="'+user.id+'"><img src="'+User.html.avatar_url(user.foto,40)+'" class="userlist_afoto user-avatar-rounded"></div>';
					html+='<div class="name" user_id="'+user.id+'">'+User.html.online_status(user, "tiny")+" "+ User.html.gender(user)+ " " + user.name+'<br><span>'+PS.list[PS.cursor].source.title+'</span></div>';
					$(".ps-caption-content").html(html);
					//обработчики кликов
					//на страницу пользователя
					$(".ps-caption-content .avatar, .ps-caption-content .name").off("click");
					$(".ps-caption-content .avatar, .ps-caption-content .name").on("click", PS.Toolbar.Handler.GoUser);
					//Лайк
					$(".ps-btn-like").off("vclick");
					$(".ps-btn-like").on("vclick", PS.Toolbar.Handler.Like);
					//комментарии 
					$(".ps-btn-comments").off("vclick");
					$(".ps-btn-comments").on("vclick", PS.Toolbar.Handler.Comment);
				}
				else{
					$(".ps-caption-content").html("загрузка...");
				}
			},
			Handler : { 
				Like : function(ev){
					if(PS.isShown && PS.list[PS.cursor].voted==null ){
						rotateEffect1($(this));
						var params= {base: $(this).attr("base"), t_key: $(this).attr("t_key"), value: "plus", method: "putMark", cursor: PS.cursor};
						$.get( LS("server/proc_votes.php"), params, 
							function( data ) {
								console.log(data);
								if(data.auth_status=="success" ){
									if(data.method_status=="success"){
										//обновляем туллбар к фотке по которой пришел ответ
										PS.list[params.cursor].source.rating=data.vote.rating;
										PS.list[params.cursor].voted=1; //метим что оценка проставлена
										PS.Toolbar.refresh();			
									}
									else{
										show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
									}	
								}
								else{
									console.log("Сессия не существует на сервере." + JSON.stringify(data));	
									gl_logout();
								}
							},
							"json"
						);
					}
				},
				Comment : function(ev){
					ev.preventDefault();
					var base=$(this).attr("base");
					var t_key=$(this).attr("t_key");
					//если переход из PS то сначала закрываем его
					if (typeof photoSwipeInstance != "undefined" && photoSwipeInstance != null) { 
						if(PS.isShown){
							photoSwipeInstance.hide(true);
						}
					}
					Comments.OpenComments(t_key,base);
				},
				GoUser : function(ev){
					ev.preventDefault();
					var user_id=$(this).attr("user_id");
					//если переход из PS то сначала закрываем его
					if (typeof photoSwipeInstance != "undefined" && photoSwipeInstance != null) { 
						if(PS.isShown){
							photoSwipeInstance.hide(true);
						}
					}
					UserPage.GoId(user_id);
				}
			}
		},
		//обновляет данные по слайду текущему слайду
		refreshFromServer : function(cursor){
			var base = PS.list[cursor].base;
			var t_key = PS.list[cursor].source.num;
			$.get( LS("server/proc_source.php"), {method : "getSourceInfo", t_key: t_key, base: base}, 
				function( data ) {
					console.log(data);
					if(data.auth_status=="success" ){
						if(data.method_status=="success"){
							//обновляем туллбар к фотке по которой пришел ответ
							PS.list[cursor]=data.element;	
							PS.cursor=cursor;
							PS.Toolbar.refresh(); 
							PS.Toolbar.refresh_caption();
						}
						else{
							show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
						}	
					}
					else{
						console.log("Сессия не существует на сервере." + JSON.stringify(data));	
						gl_logout();
					}
				},
				"json"
			);
		},
		getFromServer : function(cursor){
			var base = PS.list[cursor].base;
			var t_key = PS.list[cursor].source.num;
			var data = JSON.parse(
				$.ajax({
					type: "GET",
					url: LS("server/proc_source.php"),
					data: {method : "getSourceInfo", t_key: t_key, base: base},
					async: false
				}).responseText
				);
			PS.list[cursor]=data;
			console.log(data);
		},
		ReCreate : function(dom_fotos,list_obj, mode){
			PS.list = list_obj;
			PS.isShown=0;
			PS.cursor=0;
			PS.mode=mode;
			if (typeof photoSwipeInstance != "undefined" && photoSwipeInstance != null) { 
				window.Code.PhotoSwipe.detatch(photoSwipeInstance);
			}
			photoSwipeInstance = dom_fotos.photoSwipe({zIndex: 2, 
				loop: false, 
				getToolbar: PS.Toolbar.get, 
				captionAndToolbarAutoHideDelay: 100000,
				fadeInSpeed: 0,
				fadeOutSpeed: 0});
			//обработчик показа изображения
			photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onDisplayImage, PS.OnDisplay);
			photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onShow, PS.onShow);
			photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onHide, PS.onHide);
			photoSwipeInstance.addEventHandler(window.Code.PhotoSwipe.EventTypes.onCaptionAndToolbarShow, PS.Toolbar.refresh_caption); 
		}
	});
	Uploader = new Object({
		list : Array(),
		current : Object(),
		upload_type: 0, //"fotos" - fotogallery "users_fotos", "music", "clips"
		init : function(upload_type){
			Uploader.list = new Array();
			Uploader.current = new Object();
			Uploader.upload_type=upload_type;
		},
		Display : function(){
			$( ":mobile-pagecontainer" ).pagecontainer( "change", $("#page_upload"), { transition: "none"} );
			$("#page_upload .loaded").html("");
			//если фотографии для галереи
			if(Uploader.upload_type == "fotos"){
				$("#page_upload .uploader").collapsible("expand");
				Uploader.Fotos.refresh_upload_form();
				
			}
			else
			//если фотографии для друзей
			if(Uploader.upload_type == "users_fotos"){
				$("#page_upload .uploader").collapsible("expand");
				Uploader.Users_Fotos.refresh_upload_form();
				
			}
		},
		Upload : function(ev){
			ev.preventDefault();
			//загрузка фотографии
			if(Uploader.upload_type=="fotos"){
				var title = $("#uploader_fotos_title").val();
				var album = $("#uploader_fotos_album").val();
				var nation = $("#uploader_fotos_nation").val();
				var params = {method: "uploadFotos", title: title, album: album, nation: nation, id: Uploader.current.id};
				if(!Uploader.current.id){
					show_popup("message_not_sent", "Выберите фотографию для загрузки", $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
				}
				else
				if(!album){
					show_popup("message_not_sent", "Выберите альбом для фотографии", $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
				}
				else
				if(!nation){
					show_popup("message_not_sent", "Выберите народность, к которой относится данная фотография", $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
				}
				else{
					$("#page_upload .uploader .btn-save").css({display: "none"});
					//загружаем фотографии в альбом и фотогаларею
					$.get( LS("server/proc_upload.php"), params, 
						function( data ) {
							var html="";
							if(data.auth_status=="success" ){
								if(data.method_status=="success"){
									$("#page_upload .uploader").collapsible("collapse");
									Uploader.Fotos.refresh_upload_form();
									//html для загруженных фотографий
									html+="<div class='foto num_"+data.foto.num+"'>";
									html+="<a href='"+User.html.fotos_url(data.foto.path, data.foto.private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(data.foto.path, data.foto.private_foto, "small")+"'></a>";
									html+="<div class='btn-delete'><button num='"+data.foto.num+"' base='"+Uploader.upload_type+"' class='ui-btn ui-icon-delete ui-btn-icon-left ui-mini'>Удалить</button></div>";
									html+="</div>";
									$("#page_upload .loaded").append(html);
									clickEffect1($("#page_upload .loaded .num_"+data.foto.num)); 
									Uploader.list.push({base: Uploader.upload_type, user : User.I, source: data.foto});
									Uploader.current=null;
									$("#page_upload .counter span").html(Uploader.list.length);									
									PS.ReCreate($("#page_upload .loaded .foto a"), Uploader.list, null);
									//обработчик удаления
									$("#page_upload .loaded .num_"+data.foto.num+" .btn-delete button").on("vclick",Fotos.link.Delete);
									//всплывающее сообщение
									show_popup("fast_ntfy", "Фотография появится в общем разделе после проверки модераторами.", null);
								}
								else{
									show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
								}
								
							}
							else{
								console.log("Сессия не существует на сервере." + JSON.stringify(data));	
								gl_logout();
							}
							$("#page_upload .uploader .btn-save").css({display: "block"});
						},
						"json"
					);
				}
				
			}
			else
			//загрузка фотографии
			if(Uploader.upload_type=="users_fotos"){
				var title = $("#uploader_fotos_title").val();
				var params = {method: "uploadUsersFotos", title: title,  id: Uploader.current.id};
				if(!Uploader.current.id){
					show_popup("message_not_sent", "Выберите фотографию для загрузки", $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
				}				
				else{
					$("#page_upload .uploader .btn-save").css({display: "none"});
					//загружаем фотографии в альбом и фотогаларею
					$.get( LS("server/proc_upload.php"), params, 
						function( data ) {
							var html="";
							if(data.auth_status=="success" ){
								if(data.method_status=="success"){
									$("#page_upload .uploader").collapsible("collapse");
									Uploader.Users_Fotos.refresh_upload_form();
									//html для загруженных фотографий
									html+="<div class='foto num_"+data.foto.num+"'>";
									html+="<a href='"+User.html.fotos_url(data.foto.path, data.foto.private_foto, "full")+"' rel='external'><img src='"+User.html.fotos_url(data.foto.path, data.foto.private_foto, "small")+"'></a>";
									html+="<div class='btn-delete'><button num='"+data.foto.num+"' base='"+Uploader.upload_type+"' class='ui-btn ui-icon-delete ui-btn-icon-left ui-mini'>Удалить</button></div>";
									html+="</div>";
									$("#page_upload .loaded").append(html);
									clickEffect1($("#page_upload .loaded .num_"+data.foto.num)); 
									Uploader.list.push({base: Uploader.upload_type, user : User.I, source: data.foto});
									Uploader.current=null;
									$("#page_upload .counter span").html(Uploader.list.length);									
									PS.ReCreate($("#page_upload .loaded .foto a"), Uploader.list, null);
									//обработчик удаления
									$("#page_upload .loaded .num_"+data.foto.num+" .btn-delete button").on("vclick",Fotos.link.Delete);
								}
								else{
									show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
								}
								
							}
							else{
								console.log("Сессия не существует на сервере." + JSON.stringify(data));	
								gl_logout();
							}
							$("#page_upload .uploader .btn-save").css({display: "block"});
						},
						"json"
					);
				}
				
			}
		},
		Fotos : {
			refresh_upload_form : function(){
				$("#page_upload .uploader p").html(Uploader.Fotos.html.uploadForm());	
				$("#page_upload .uploader p").trigger("create");				
				UserList.link.refresh_nation_selectmenu_sp($("#uploader_fotos_nation"));
				$("#page_upload .upload-btn input").off("change");
				$("#page_upload .upload-btn input").on("change", Uploader.Fotos.Preview);
				$("#page_upload .uploader .btn-save").off("vclick");
				$("#page_upload .uploader .btn-save").on("vclick", Uploader.Upload);
				$("#page_upload .uploader .btn-save").css({display: "block"});
			},
			html : {
				uploadForm : function(){
					var html;
					html="";
					html+='<div class="preview"><div class="preview-src"><img src=""></div><i class="fa fa-camera"></i><div class="upload-btn">Выберите фотографию <input  type="file"  accept="image/jpeg,image/png,image/gif" /></div></div>';
					html+='<div class="options">'; 
					html+='<textarea rows=2  id="uploader_fotos_title" placeholder="Название вашей фотографии"></textarea>';
					
					html+='<select data-native-menu="false" id="uploader_fotos_album">';
					html+='<option value="" data-placeholder="true">Выберите альбом</option>';
					html+='<option value="1" >Люди</option>';
					html+='<option value="2" >Культура</option>';
					html+='<option value="3" >Графика</option>';
					html+='<option value="4" >Природа</option>';
					html+='</select>';
					
					html+='<select data-native-menu="false" id="uploader_fotos_nation">';
					html+='<option value="" data-placeholder="true">Выберите народность</option>';
					html+='</select>';
					html+='<button class="ui-btn ui-icon-check ui-btn-icon-left btn-save" >Загрузить</button>';
					html+='</div>';
					return html;
					
				}
			},
			Preview : function(ev){
				var	len = this.files.length; 
				var file;				
				var formdata = new FormData();
				for ( i=0; i < len; i++ ) {
					file = this.files[i];
					console.log(this.files[i]);
					//alert(JSON.stringify(file));
					if (getFileExt(file.name)=="jpg" || getFileExt(file.name)=="jpeg" || getFileExt(file.name)=="png" ||  getFileExt(file.name)=="gif") {
						if (formdata) {
							formdata.append("userfile", file);
							formdata.append("method", "savePicture");
							//скрываем кнопку сохранения на момент загрузки
							$("#page_upload .uploader .btn-save").css({display: "none"});
							$.ajax({
								url: LS("server/proc_preview.php"),
								type: "POST",
								data: formdata,
								processData: false,
								contentType: false,
								success: function (res) {
									var data;
									console.log(res);
									data = JSON.parse(res); 
									if(data.auth_status == "success"){	
										if(data.method_status == "success"){
											//сохраняем id текущей фотографии и отоображаем превью
											Uploader.current ={id : data.num, src : data.src};
											$("#page_upload .uploader .preview i").css({display: "none"}); 
											$("#page_upload .uploader .preview .preview-src img").attr("src", User.html.preview_url("large_800/"+data.src, "fotos"));
											$("#page_upload .uploader .preview .preview-src").css({display: "block"});
											//отображаем кнопку снова
											$("#page_upload .uploader .btn-save").css({display: "block"}); 
										
										}
										else
											show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
									} 
									else{
										console.log(data);	
										gl_logout();
									}
									console.log(data);
								}
							});
						}
					}
					else{
						show_popup("message_not_sent", "Фотография должна быть формата jpg/gif/png", $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
					}
				}
			}
		},
		Users_Fotos : {
			refresh_upload_form : function(){
				$("#page_upload .uploader p").html(Uploader.Users_Fotos.html.uploadForm());	
				$("#page_upload .uploader p").trigger("create");				
				$("#page_upload .upload-btn input").off("change");
				$("#page_upload .upload-btn input").on("change", Uploader.Users_Fotos.Preview);
				$("#page_upload .uploader .btn-save").off("vclick");
				$("#page_upload .uploader .btn-save").on("vclick", Uploader.Upload);
				$("#page_upload .uploader .btn-save").css({display: "block"});
			},
			html : {
				uploadForm : function(){
					var html;
					html="";
					html+='<div class="preview"><div class="preview-src"><img src=""></div><i class="fa fa-camera"></i><div class="upload-btn">Выберите фотографию <input  type="file"  accept="image/jpeg,image/png,image/gif" /></div></div>';
					html+='<div class="options">'; 
					html+='<textarea rows=2  id="uploader_fotos_title" placeholder="Название вашей фотографии"></textarea>';
																			
					html+='<button class="ui-btn ui-icon-check ui-btn-icon-left btn-save" >Загрузить</button>';
					html+='</div>';
					return html;
					
				}
			},
			Preview : function(ev){
				var	len = this.files.length; 
				var file;				
				var formdata = new FormData();
				for ( i=0; i < len; i++ ) {
					file = this.files[i];
					console.log(this.files[i]);
					//alert(JSON.stringify(file));
					if (getFileExt(file.name)=="jpg" || getFileExt(file.name)=="jpeg" || getFileExt(file.name)=="png" ||  getFileExt(file.name)=="gif") {
						if (formdata) {
							formdata.append("userfile", file);
							formdata.append("method", "savePicture");
							//скрываем кнопку сохранения на момент загрузки
							$("#page_upload .uploader .btn-save").css({display: "none"});
							$.ajax({
								url: LS("server/proc_preview.php"),
								type: "POST",
								data: formdata,
								processData: false,
								contentType: false,
								success: function (res) {
									var data;
									console.log(res);
									data = JSON.parse(res); 
									if(data.auth_status == "success"){	
										if(data.method_status == "success"){
											//сохраняем id текущей фотографии и отоображаем превью
											Uploader.current ={id : data.num, src : data.src};
											$("#page_upload .uploader .preview i").css({display: "none"}); 
											$("#page_upload .uploader .preview .preview-src img").attr("src", User.html.preview_url("large_800/"+data.src, "fotos"));
											$("#page_upload .uploader .preview .preview-src").css({display: "block"}); 
											//отображаем кнопку снова
											$("#page_upload .uploader .btn-save").css({display: "block"}); 
										}
										else
											show_popup("message_not_sent", data.error_text, $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
									} 
									else{
										console.log(data);	
										gl_logout();
									}
									console.log(data);
								}
							});
						}
					}
					else{
						show_popup("message_not_sent", "Фотография должна быть формата jpg/gif/png", $( ":mobile-pagecontainer" ).pagecontainer( "getActivePage" ).attr("id"));
					}
				}
			}
		},
		Utils :{
			get_list_index: function(num){
				var found_i=-1;
				$.each(Uploader.list, function(key, obj){
					if(obj.source.num==num){
						found_i=key;
					}
				});
				return found_i
			}
		}
		
	});
  <!-------------------------------------------------------------------------------------- обработчики страниц-->
  <!------------------------------- обработчики страниц авторизации-->
	$( document ).on( "pagecreate", "#page_auth", function() {
		//обработчик кнопки входа
		$( "#auth_login_btn" ).on( "click", function() {
			if( $("#auth_login").val().length==0 || $("#auth_pass").val().length== 0) {
				show_popup("", "Укажите логин и пароль для входа в Шах-Даг", "page_auth");
			}
			else{
				var chk_status=0;
				if($("#auth_save_pass").prop("checked"))
					chk_status=1;
				gl_auth($("#auth_login").val(), $("#auth_pass").val(), chk_status);
			}			
				
			
		});
		
	});
	
	<!------------------------------- обработчики страницы переписки-->
	$( document ).on( "pagecreate", "#page_msg2", function() {
		$( "#nav-sendmsg-btn").on( "vclick", function(){
			NavMsg.SendMsgHandler($(this).attr("send_to"))
			
		}); 
		$( "#nav-sendmsg-smile").on( "click", show_smiles);
		$("#page_msg2 .topheader h1").on( "vclick", UserPage.Go);
		$("#page_msg2-trashbutton").on ( "vclick", NavMsg.Delete.Do);
		$("#page_msg2_confirm_delete_yes").on ( "vclick", NavMsg.Delete.Do);
		$("#page_msg2_menu .page_msg2_menu_li").on ("vclick", NavMsg.Utils.confirm);
		$("#nav-msg-txtarea").on("keyup", NavMsg.Utils.keyPress.send_handler);
	});
	
	$( document ).on( "pagecreate", "#page_music", function() {
		Music.link.refresh_nation_footer();
		$("#page_music_sort_popup .navbar_footer_music_li").on ("click", Music.link.btn_sort_onClick);
		$("#page_music_navbar .navbar_footer_search").on ("vclick", Music.link.btn_search_onClick);
		$( "#page_music" ).on( "swiperight", function(){UserList.GoUsers();} );
		//обработка кликов по форме поиска
		$("#page_music .ui-controlgroup-controls .btn-find").on ("vclick", Music.link.SearchForm.search);
		$("#page_music .ui-controlgroup-controls .btn-close").on ("vclick", Music.link.SearchForm.hide);
	});
	$( document ).on( "pagecreate", "#page_usersearch", function() {
		//присваиваем обработчики  к кнопкам фильтров
		$( "#page_usersearch .navbar_footer_online").on( "vclick", UserList.link.btn_online_onClick);
		$( "#page_usersearch .navbar_footer_gender_li").on( "vclick", UserList.link.btn_gender_onClick);
		UserList.link.refresh_nation_footer();
		$( "#page_usersearch" ).on( "swipeleft", function(){Music.GoAll(null,1);} );
		$( "#page_usersearch" ).on( "swiperight", function(){Fotos.GoGallery();} );
	});
	//обработчик страницы фотогалереи
	$( document ).on( "pagecreate", "#page_fotos", function() {
		//присваиваем обработчики  к кнопкам фильтров
		$( "#page_fotos .navbar_footer_gender_li").on( "vclick", Fotos.link.btn_gender_onClick);
		$( "#page_fotos .navbar_footer_album_li").on( "vclick", Fotos.link.btn_album_onClick);
		//обработчик добавления фоток
		$( "#page_fotos .topheader .btn-upload").on( "vclick", Fotos.link.btn_upload_onClick);
		Fotos.link.refresh_nation_footer();
		$( "#page_fotos" ).on( "swipeleft", function(){UserList.GoUsers();} );
		$( "#page_fotos" ).on( "swiperight", function(){Evants.Go();} );
	});
	//обработчик страницы личных фотографий
	$( document ).on( "pagecreate", "#page_usersfotos", function() {
		$( "#page_usersfotos .topheader .btn-upload").on( "vclick", Fotos.link.btn_upload_onClick);		
		
	});
	//обработчик страницы поиска людей
	$( document ).on( "pagecreate", "#page_usersearch_sp", function() {
		$("#page_usersearch_city").autocomplete(LS("server/autocomplete/show_cities.php"), {
			delay:10,
			minChars:2,
			matchSubset:0,
			autoFill:false,
			matchContains:1,
			cacheLength:1,
			selectFirst:true,
			maxItemsToShow:6
		  });
		$("#page_usersearch_country").autocomplete(LS("server/autocomplete/show_countries.php"), {
			delay:10,
			minChars:2,
			matchSubset:0,
			autoFill:false,
			matchContains:1,
			cacheLength:1,
			selectFirst:true,
			maxItemsToShow:6
		  });
		  $(".page_usersearch_etno").autocomplete(LS("server/autocomplete/show_kladr.php"), {
			delay:10,
			minChars:2,
			matchSubset:0,
			autoFill:false,
			matchContains:1,
			cacheLength:1,
			selectFirst:true,
			maxItemsToShow:6
		  });
		  UserList.link.refresh_nation_selectmenu_sp($("#page_usersearch_nation"));
		  $("#page_usersearch_search-button").on ( "click", UserList.Search);
		  
	});
	<!------------------------------- обработчики страницы комментариев-->
	$( document ).on( "pagecreate", "#page_comment", function() {
		$( "#nav-sendcomment-btn").on( "vclick", Comments.SendCommentHandler); 
		$( "#nav-comment-smile").on( "click", show_smiles);
		$("#page_comment .topheader h1").on( "vclick", UserPage.Go);
		$("#page_comment-trashbutton").on ( "vclick", Comments.Delete.Do);
		$("#page_comment_confirm_delete_yes").on ( "vclick", Comments.Delete.Do);
		$("#page_comment_menu .page_comment_menu_li").on ("vclick", Comments.Utils.confirm);
	});
	<!------------------------------- обработчики страницы событий-->
	$( document ).on( "pagecreate", "#page_evants", function() {
		$( "#page_evants" ).on( "swipeleft", function(){Fotos.GoGallery();} );
	});
	
	
</script>

<!-- Start of first page: #one -->
<div data-role="page" id="page_auth">

	<div data-role="header" class='topheader'>
		<h1>Шах-Даг</h1>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
	</div><!-- /header -->
	
	<div role="main" class="ui-content page_limited" >
		<div data-role="collapsibleset" data-theme="a"  data-collapsed-icon="arrow-r" >
			<div data-role="collapsible" data-expanded-icon="lock" data-collapsed="false" >
				<h3>Войти</h3>
				<input type="text" name="login" id="auth_login" placeholder="Ваш логин" value="">
				<input type="password" data-clear-btn="true" autocomplete="off" name="password" id="auth_pass" placeholder="Ваш пароль" value="">
				<div class="ui-grid-c ui-responsive">
					<div class="ui-block-a"></div>
					<div class="ui-block-b">
						<label for="auth_save_pass">Запомнить</label>
						<input type="checkbox" id="auth_save_pass" name="save_pass">
					</div>
					<div class="ui-block-c"><input type="button" data-icon="check" id="auth_login_btn" data-theme="b" value="Войти"></div>
				</div>
			</div>
			<div data-role="collapsible" data-expanded-icon="arrow-d">
				<h3>Регистрация</h3>
				<p>Здесь будут поля для регистрации</p>
			</div>
		</div>
	</div><!-- /content -->
	
	
</div><!-- /page one -->
<!-------------------------------------------- Страница сообщений ---------------------------------------->
<div data-role="page" id="page_msg1" data-theme="a">

	<div data-role="header" class='topheader' data-position="fixed">
		<div class='ui-btn-left'>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-envelope ui-btn-icon-notext topmenu-msg'>Сообщения </a>
		</div>
		<h1>Сообщения</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content page_limited" id="msg-list">
				

	</div><!-- /content -->
 
	<div data-role="footer">
		<h4>Page Footer</h4>
	</div><!-- /footer -->
</div>
<!-------------------------------------------- Страница сообщений с перепиской ---------------------------------------->
<div data-role="page" id="page_msg2" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed" > 
		<div class='ui-btn-left'>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-envelope ui-btn-icon-notext topmenu-msg'>Сообщения </a>
		</div>
		<h1 user_id="0">Сообщения</h1>
		<div class='ui-btn-right'>
			<a class="fa-button right" id="page_msg2-trashbutton" del_type="selected" style="display:none;" href="#">
				<i class="fa fa-trash-o fa-lg fa-button-theme-a"></i> 
			</a>
			<a class="fa-button right" data-rel="popup" href="#page_msg2_menu">
				<i class="fa fa-ellipsis-v fa-lg fa-button-theme-a"></i> 
			</a>	
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content page_limited" id="msg-with-user">
		<div id="page_msg2_typing"><i class="fa fa-pencil fa-lg"></i> печатает...</div>		 

	</div><!-- /content -->
	<!-- меню страницы переписки -->
	<div data-role="popup" id="page_msg2_menu" data-theme="b">
        <ul data-role="listview" data-inset="true" style="min-width:210px;">
			<li><a href="#page_msg2_confirm_delete" class="page_msg2_menu_li" option_type="delete_all" data-rel="popup" data-position-to="window"><i class="fa fa-trash-o fa-lg"></i>  Удалить все</a></li>
            <li><a href="#"  class="page_msg2_menu_li" option_type="ban"><i class="fa fa-ban fa-lg"></i>  Заблокировать</a></li>
        </ul>
	</div>
	<!-- окно подтверждения -->
	<div data-role="popup" id="page_msg2_confirm_delete" data-overlay-theme="b" data-theme="b" data-dismissible="false" style="max-width:400px;">
		<div data-role="header" data-theme="a">
		<h1>Удалить переписку</h1>
		</div>
		<div role="main" class="ui-content">
			<h3 class="ui-title">Вы уверены что хотите удалить всю переписку?</h3>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" del_type="dialog" id="page_msg2_confirm_delete_yes" >Да</a>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Отмена</a>
		</div>
	</div>

	<div data-role="footer" data-position="fixed" data-tap-toggle="false">

		<div class="footer-msg-form">
			<div class="txt-div">
					<textarea id="nav-msg-txtarea" placeholder="Отправить сообщение..."></textarea>	
			</div>
			<div id="nav-sendmsg-smile" class="smile-div" txtarea_id="nav-msg-txtarea">
				<a href="#" class="fa-button" ><i class="fa fa-smile-o fa-lg "></i></a>
			</div>
			<div id="nav-sendmsg-btn" class="send-div" send_to="" >
				<a href="#" class="fa-button" ><i class="fa fa-chevron-right fa-lg "></i></a>	
			</div>
		</div>
	</div><!-- /footer -->
</div>
<!-------------------------------------------- Страница пользователя ---------------------------------------->
<div data-role="page" id="page_user" data-theme="a" >

	<div data-role="header" class='topheader' data-position="fixed">
		<div class='ui-btn-left'>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-envelope ui-btn-icon-notext topmenu-msg'>Сообщения </a>
		</div>
		<h1>Пользователь</h1>
		<div class="ui-btn-right" id="page_user_header_right">
			<a href="#" data-role="button" data-inline="true" data-icon="comment" data-iconpos="notext" >Button1</a>
			<a href="#right_panel" data-role="button" data-inline="true" data-icon="dedent" data-iconpos="notext" >Button1</a>
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content page_limited">
	
		<div id="page_user_name">
			
		</div>
		<div id="page_user_left">
			<div id="page_user_avatar">
				
			</div>
		</div>
		<div id="page_user_right">
			<div id="page_user_info1">				
				<div data-role="controlgroup" data-type="horizontal">
					<button data-icon="search" data-iconpos="notext">Search</button>
					<button data-icon="search" data-iconpos="notext">Search</button>
					<button data-icon="search" data-iconpos="notext">Search</button>
				</div>
			</div>
			<div id="page_user_fotos">
			</div>
			<div id="page_user_friends">
			</div>
		</div>
	
				

	</div><!-- /content -->	
</div>
<!-------------------------------------------- Страница музыки ---------------------------------------->
<div data-role="page" id="page_music" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed">
		<div class='ui-btn-left'>
		<a class="fa-button left" id="" href="#" >
				<i class="fa fa-chevron-left fa-lg fa-button-theme-a"></i> 
		</a>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-envelope ui-btn-icon-notext topmenu-msg'>Сообщения </a>
		</div>
		<h1>Музыка</h1>
		<div class='ui-btn-right'>
		<a href="#right_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-right'>Меню </a>
		</div>
		
	</div><!-- /header -->

	<div role="main" class="ui-content page_limited" >
		<div data-role="navbar" data-grid="c" class="ui-navbar navbar-public" role="navigation">
			<ul class="ui-grid-c">
				<li class="ui-block-a"><a href="javascript: Evants.Go()" class="ui-link ui-btn ui-btn-b btn-evants"><i class="fa fa-bell"></i> <span>Новости</span></a></li>
				<li class="ui-block-b"><a href="javascript: Fotos.GoGallery()" class="ui-link ui-btn ui-btn-b btn-fotos ui-btn-active"><i class="fa fa-camera"></i> <span>Фотогаларея</span></a></li>
				<li class="ui-block-c"><a href="javascript: UserList.GoUsers()" class="ui-link ui-btn ui-btn-b  btn-users"><i class="fa fa-users"></i> <span>Люди</span></a></li>
				<li class="ui-block-d"><a href="javascript: Music.GoAll(null,1)" class="ui-link ui-btn ui-btn-b btn-music"><i class="fa fa-music"></i> <span>Музыка</a></span></li> 
			</ul>
		</div>	
		<div id="page_music_list">
		</div>
				
	
	
	</div><!-- /content -->
	<a href="javascript: Debug.show()" id="debug_a">Debug show</a> 
	<div id="debug_div"></div>
	
	
	<div data-role="footer" data-position="fixed" data-tap-toggle="false" data-theme="b">
		<div data-role="navbar" id="page_music_navbar">
            <ul>
                <li><a href="#page_music_sort_popup" data-icon="bars" data-rel="popup" class="navbar_footer_sort">Сортировка</a></li>
				<li><a href="#page_music_nation_popup" data-rel="popup"  data-icon="globe" class="navbar_footer_nation">Народы</a></li>
				<li><a href=""   data-icon="search" class="navbar_footer_search">Поиск</a></li>
            </ul>
        </div>
		<div data-role="controlgroup" class="searchform" data-type="horizontal">
		    <input type="search"  data-wrapper-class="ui-btn">
		    <button class="controlgroup-btn btn-find">Найти</button>
			<button class="controlgroup-btn btn-close"><i class="fa fa-times"></i></button>
		</div>
	</div>
	<!-- список полов -->
	<div data-role="popup" id="page_music_sort_popup" data-theme="b">
        <ul data-role="listview" data-inset="true" style="min-width:210px;">
			<li data-role="list-divider">Сортировать по</li>
			<li><a href="#" sort_id="" class="navbar_footer_music_li">Дате добавления</a></li> 
            <li><a href="#" sort_id="1" class="navbar_footer_music_li">Последним комментариям</a></li>
            <li><a href="#" sort_id="2" class="navbar_footer_music_li">Рейтингу</a></li>
			<li><a href="#" sort_id="3" class="navbar_footer_music_li">Числу комментариев</a></li>
        </ul>
	</div>
	<!-- список наций -->
	<div data-role="popup" id="page_music_nation_popup" data-theme="b">
        <ul data-role="listview" data-inset="true" class="navbar_footer_nation_ul" style="min-width:210px;">
			<li data-role="list-divider">Выберите народы</li>
			<li><a href="#" class="navbar_footer_nation_li">Все</a></li>
            
        </ul>
	</div>
	
	
	
</div>

<!-------------------------------------------- Страница public foto ---------------------------------------->
<div data-role="page" id="page_fotos" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed">
		<div class='ui-btn-left'>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-home ui-btn-icon-notext topmenu-msg'>Домой </a>
		</div>
		<h1>Фотогалерея</h1>
		<div class='ui-btn-right'>
			<a class="fa-button right" data-rel="popup" href="#">
				<i class="fa fa-plus fa-lg fa-button-theme-a btn-upload" upload_type="fotos"></i> 
			</a>	
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content  page_limited page_fotos_list" >
		<div data-role="navbar" data-grid="c" class="ui-navbar navbar-public" role="navigation">
			<ul class="ui-grid-c">
				<li class="ui-block-a"><a href="javascript: Evants.Go()" class="ui-link ui-btn ui-btn-b btn-evants"><i class="fa fa-bell"></i> <span>Новости</span></a></li>
				<li class="ui-block-b"><a href="javascript: Fotos.GoGallery()" class="ui-link ui-btn ui-btn-b btn-fotos ui-btn-active"><i class="fa fa-camera"></i> <span>Фотогаларея</span></a></li>
				<li class="ui-block-c"><a href="javascript: UserList.GoUsers()" class="ui-link ui-btn ui-btn-b  btn-users"><i class="fa fa-users"></i> <span>Люди</span></a></li>
				<li class="ui-block-d"><a href="javascript: Music.GoAll(null,1)" class="ui-link ui-btn ui-btn-b btn-music"><i class="fa fa-music"></i> <span>Музыка</a></span></li> 
			</ul>
		</div>		
		<div id="page_fotos_list">
		</div>

	</div><!-- /content -->
	
	
	<div data-role="footer" data-position="fixed" data-tap-toggle="false" data-theme="b">
		<div data-role="navbar" id="page_fotos_navbar">
            <ul>
                <li><a href="#page_fotos_album_popup" data-icon="bars" data-rel="popup" class="navbar_footer_album">Альбом</a></li>
                <li><a href="#page_fotos_gender_popup" data-rel="popup"  data-icon="male" class="navbar_footer_gender">Пол</a></li>
				<li><a href="#page_fotos_nation_popup" data-rel="popup"  data-icon="globe" class="navbar_footer_nation">Народы</a></li>
            </ul>
        </div>
	</div>
	<!-- список альбомов -->
	<div data-role="popup" id="page_fotos_album_popup" data-theme="b">
        <ul data-role="listview" data-inset="true" style="min-width:210px;">
			<li data-role="list-divider">Выберите раздел</li>
			<li><a href="#" album_id="" class="navbar_footer_album_li">Все</a></li>
            <li><a href="#" album_id="1" class="navbar_footer_album_li">Люди</a></li>
			<li><a href="#" album_id="2" class="navbar_footer_album_li">Культура</a></li>
			<li><a href="#" album_id="3" class="navbar_footer_album_li">Графика</a></li>
			<li><a href="#" album_id="4" class="navbar_footer_album_li">Природа</a></li>
        </ul>
	</div>
	<!-- список полов -->
	<div data-role="popup" id="page_fotos_gender_popup" data-theme="b">
        <ul data-role="listview" data-inset="true" style="min-width:210px;">
			<li data-role="list-divider">Выберите пол</li>
			<li><a href="#" gender_id="" class="navbar_footer_gender_li">Все</a></li>
            <li><a href="#" gender_id="М" class="navbar_footer_gender_li"><i class="fa fa-male fa-lg"></i>  Парни</a></li>
            <li><a href="#" gender_id="Ж" class="navbar_footer_gender_li"><i class="fa fa-female fa-lg"></i> Девушки</a></li>
        </ul>
	</div>
	<!-- список наций -->
	<div data-role="popup" id="page_fotos_nation_popup" data-theme="b">
        <ul data-role="listview" data-inset="true" class="navbar_footer_nation_ul" style="min-width:210px;">
			<li data-role="list-divider">Выберите народы</li>
			<li><a href="#" class="navbar_footer_nation_li">Все</a></li>
            
        </ul>
	</div>
</div>
<!-------------------------------------------- Страница users fotos foto ---------------------------------------->
<div data-role="page" id="page_usersfotos" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed">
		<div class='ui-btn-left'>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-home ui-btn-icon-notext topmenu-msg'>Домой </a>
		</div>
		<h1>Пользователь</h1>
		<div class='ui-btn-right'>
			<a class="fa-button right btn-upload" upload_type="users_fotos" href="#">
				<i class="fa fa-plus fa-lg fa-button-theme-a"></i> 
			</a>	
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content  page_limited page_fotos_list" id="page_usersfotos_list">
				

	</div><!-- /content -->
	
	
	<div data-role="footer" data-position="fixed" data-tap-toggle="false" data-theme="b">
		
	</div>
</div>


<!-------------------------------------------- Страница поиска людей ---------------------------------------->
<div data-role="page" id="page_usersearch" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed">
		<div class='ui-btn-left'>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-envelope ui-btn-icon-notext topmenu-msg'>Сообщения </a>
		</div>
		<h1>Люди</h1>
		<div class="ui-btn-right">
			<a href="#" data-role="button" data-inline="true" data-icon="comment" data-iconpos="notext" >Button1</a>
			<a href="#right_panel" data-role="button" data-inline="true" data-icon="dedent" data-iconpos="notext" >Button1</a>
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content page_limited" >
		<div data-role="navbar" data-grid="c" class="ui-navbar navbar-public" role="navigation">
			<ul class="ui-grid-c">
				<li class="ui-block-a"><a href="javascript: Evants.Go()" class="ui-link ui-btn ui-btn-b btn-evants"><i class="fa fa-bell"></i> <span>Новости</span></a></li>
				<li class="ui-block-b"><a href="javascript: Fotos.GoGallery()" class="ui-link ui-btn ui-btn-b btn-fotos"><i class="fa fa-camera"></i> <span>Фотогаларея</span></a></li>
				<li class="ui-block-c"><a href="javascript: UserList.GoUsers()" class="ui-link ui-btn ui-btn-b ui-btn-active btn-users"><i class="fa fa-users"></i> <span>Люди</span></a></li>
				<li class="ui-block-d"><a href="javascript: Music.GoAll(null,1)" class="ui-link ui-btn ui-btn-b btn-music"><i class="fa fa-music"></i> <span>Музыка</a></span></li> 
			</ul>
		</div>
		<div id="page_userlist_list">
		</div>
				

	</div><!-- /content -->
	<!-- /footer -->
	<div data-role="footer" data-position="fixed" data-tap-toggle="false" data-theme="b">
		<div data-role="navbar" id="page_usersearch_navbar">
            <ul>
                <li><a href="#" data-icon="circle" class="navbar_footer_online">Онлайн</a></li>
                <li><a href="#page_usersearch_gender_popup" data-rel="popup"  data-icon="male" class="navbar_footer_gender">Пол</a></li>
				<li><a href="#page_usersearch_nation_popup" data-rel="popup"  data-icon="globe" class="navbar_footer_nation">Народы</a></li>
                <li><a href="#page_usersearch_sp" data-icon="search" class="navbar_footer_search">Поиск</a></li>
            </ul>
        </div>
	</div>
	<!-- список полов -->
	<div data-role="popup" id="page_usersearch_gender_popup" data-theme="b">
        <ul data-role="listview" data-inset="true" style="min-width:210px;">
			<li data-role="list-divider">Выберите пол</li>
			<li><a href="#" gender_id="" class="navbar_footer_gender_li">Все</a></li>
            <li><a href="#" gender_id="М" class="navbar_footer_gender_li"><i class="fa fa-male fa-lg"></i>  Парни</a></li>
            <li><a href="#" gender_id="Ж" class="navbar_footer_gender_li"><i class="fa fa-female fa-lg"></i> Девушки</a></li>
        </ul>
	</div>
	<div data-role="popup" id="page_usersearch_nation_popup" data-theme="b">
        <ul data-role="listview" data-inset="true" class="navbar_footer_nation_ul" style="min-width:210px;">
			<li data-role="list-divider">Выберите народы</li>
			<li><a href="#" class="navbar_footer_nation_li">Все</a></li>
            
        </ul>
	</div>
</div>
<div data-role="page" id="page_usersearch_sp" data-theme="a" >

	<div data-role="header" class='topheader' data-position="fixed">
		<h1>Поиск людей</h1>
		<a href="#left_panel" data-icon="bars" data-tap-toggle="false" data-iconpos="notext">Меню</a>
		<div class="ui-btn-right">
			<a href="#" data-role="button" data-inline="true" data-icon="comment" data-iconpos="notext" >Button1</a>
			<a href="#right_panel" data-role="button" data-inline="true" data-icon="dedent" data-iconpos="notext" >Button1</a>
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content  page_limited" >
		<h3 class="ui-bar ui-bar-a">Основное</h3>
		<div class="ui-body">
			<label for="page_usersearch_name">Имя:</label>
			<input type="text" name="page_usersearch_name" id="page_usersearch_name" placeholder="Имя или ник" data-clear-btn="true">
			<label for="page_usersearch_gender">Пол:</label>
			<select name="page_usersearch_gender" data-native-menu="false" id="page_usersearch_gender">
				<option value="" data-placeholder="true">Выберите пол</option>
				<option value="">Все</option>
				<option value="М">Мужской</option>
				<option value="Ж">Женский</option>
			</select>
			<label for="page_usersearch_nation">Народность:</label>
			<select name="page_usersearch_nation" data-native-menu="false" id="page_usersearch_nation">
				<option value="" data-placeholder="true">Выберите народность</option>
			</select>
			<label for="page_usersearch_city">Город</label>
			<input type="text" name="page_usersearch_city" id="page_usersearch_city" placeholder="Город проживания" data-clear-btn="true">
			<label for="page_usersearch_country">Страна</label>
			<input type="text" name="page_usersearch_country" id="page_usersearch_country" placeholder="Страна проживания" data-clear-btn="true">
		</div>
		
		<h3 class="ui-bar ui-bar-a">Этнические параметры</h3>
		<div class="ui-body">
			<label for="page_usersearch_resp">Республика:</label>
			<input type="text" name="page_usersearch_resp" class="page_usersearch_etno" id="page_usersearch_resp" placeholder="Родная республика" data-clear-btn="true">
			<label for="page_usersearch_city">Район</label>
			<input type="text" name="page_usersearch_raion" class="page_usersearch_etno" id="page_usersearch_raion" placeholder="Родной район республики" data-clear-btn="true">
			<label for="page_usersearch_selo">Селение</label>
			<input type="text" name="page_usersearch_selo" class="page_usersearch_etno" id="page_usersearch_selo" placeholder="Родное селение" data-clear-btn="true">
		</div>
		<h3 class="ui-bar ui-bar-a">Образование</h3>
		<div class="ui-body">
			<label for="page_usersearch_vuz">Учебное заведение:</label>
			<input type="text" name="page_usersearch_vuz"  id="page_usersearch_vuz" placeholder="Название учебного заведения целиком" data-clear-btn="true">
			<label for="page_usersearch_faculty">Факультет</label>
			<input type="text" name="page_usersearch_faculty" id="page_usersearch_faulty" placeholder="Название факультета целиком" data-clear-btn="true">
		</div>
	</div><!-- /content -->
	
	<div data-role="footer" data-position="fixed" data-theme=b data-tap-toggle="false">
		<div class="ui-grid-a">
			<div class="ui-block-a"><a href="#" class="ui-btn ui-corner-all ui-btn-b" id="page_usersearch_search-button" style='width:97%'>Найти</a></div>
			<div class="ui-block-b"><a href="#page_usersearch" class="ui-btn ui-corner-all ui-btn-а" style='width:97%'>Отмена</a></div>
		</div>
			
			
		
	</div><!-- /footer -->

</div>

<!-------------------------------------------- КАРТА ---------------------------------------->
<div data-role="page" id="page_map" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed">
		<div class='ui-btn-left'>
		<a class="fa-button left" id="" href="#" >
				<i class="fa fa-chevron-left fa-lg fa-button-theme-a"></i> 
		</a>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-envelope ui-btn-icon-notext topmenu-msg'>Сообщения </a>
		</div>
		<h1>Кто рядом</h1>
		<div class='ui-btn-right'>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-right'>Меню </a>
		</div>
		
	</div><!-- /header -->

	<div role="main" class="ui-content" id="map_canvas" >

	</div><!-- /content -->
	
</div>

<!-------------------------------------------- Страница комментариев ---------------------------------------->
<div data-role="page" id="page_comment" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed" > 
		<div class='ui-btn-left'>
		<a class="fa-button left" id="" href="#" data-rel="back" >
				<i class="fa fa-chevron-left fa-lg fa-button-theme-a"></i> 
		</a>
		<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
		</div>
		<h1 user_id="0">Комментарии</h1>
		<div class='ui-btn-right'>
			<a class="fa-button right" id="page_comment-trashbutton" del_type="selected" style="display:none;" href="#">
				<i class="fa fa-trash-o fa-lg fa-button-theme-a"></i> 
			</a>
			<a class="fa-button right" data-rel="popup" href="#page_comment_menu">
				<i class="fa fa-ellipsis-v fa-lg fa-button-theme-a"></i> 
			</a>	
		</div>
	</div><!-- /header -->

	<div role="main" class="ui-content page_limited" id="comments-content">	 
	<div id="comments-source">
		</div>
		<h3 class="ui-bar ui-bar-b" style='margin-top:0px'>
			<i class="fa fa-comment-o"></i> <span class='comm_label'>Комментарии</span> 
			 <span class='comments'></span>
			<div class="ui-btn-right">
				<span class='ui-btn ui-btn-inline ui-mini ui-corner-all rating'></span>
				<a base="" t_key="" mark="" class="ui-btn ui-btn-inline ui-mini ui-corner-all ui-icon-thumbs-o-up ui-btn-icon-notext btn-like" >+1</a>
				<a base="" t_key="" mark=""class="ui-btn ui-btn-inline ui-mini ui-corner-all ui-icon-thumbs-o-down ui-btn-icon-notext btn-unlike" >-1</a>
			</div>
		
		</h3> 
			<div id="comments-div">
			</div>
	</div><!-- /content -->
	<!-- меню страницы переписки -->
	<div data-role="popup" id="page_comment_menu" data-theme="b">
        <ul data-role="listview" data-inset="true" style="min-width:210px;">
			<li><a href="#page_comment_confirm_delete" class="page_comment_menu_li" option_type="delete_all" data-rel="popup" data-position-to="window"><i class="fa fa-trash-o fa-lg"></i>  Очистить комментарии</a></li>
            <li><a href="#"  class="page_comment_menu_li" option_type="delete_resource"><i class="fa fa-remove fa-lg"></i>  Удалить фотографию</a></li>
        </ul>
	</div>
	<!-- окно подтверждения -->
	<div data-role="popup" id="page_comment_confirm_delete" data-overlay-theme="b" data-theme="b" data-dismissible="false" style="max-width:400px;">
		<div data-role="header" data-theme="a">
		<h1>Удалить все комментарии</h1>
		</div>
		<div role="main" class="ui-content">
			<h3 class="ui-title">Вы уверены что хотите удалить все комментарии</h3>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" del_type="all" id="page_comment_confirm_delete_yes" >Да</a>
			<a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Отмена</a>
		</div>
	</div>

	<div data-role="footer" data-position="fixed" data-tap-toggle="false">
		<div class="footer-msg-form">
			<div class="txt-div">
					<textarea id="nav-comment-txtarea" placeholder="Отправить сообщение..."></textarea>	
			</div>
			<div id="nav-comment-smile" class="smile-div" txtarea_id="nav-comment-txtarea">
				<a href="#" class="fa-button" ><i class="fa fa-smile-o fa-lg "></i></a>
			</div>
			<div id="nav-sendcomment-btn" class="send-div" reply_to="" >
				<a href="#" class="fa-button" ><i class="fa fa-chevron-right fa-lg "></i></a>	
			</div>
		</div>
	
		
		
		
	</div><!-- /footer -->
</div>

<!-------------------------------------------- Страница Событий ---------------------------------------->
<div data-role="page" id="page_evants" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed">
		<div class='ui-btn-left'>
			<a class="fa-button left" id="" href="#" >
					<i class="fa fa-chevron-left fa-lg fa-button-theme-a"></i> 
			</a>
			<a href="#left_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-left'>Меню </a>
			<a href="#page_msg1" class='ui-btn ui-btn-a ui-corner-all ui-icon-envelope ui-btn-icon-notext topmenu-msg'>Сообщения </a>
		</div>
		<h1>Новости</h1>
		<div class='ui-btn-right'>
			<a href="#right_panel" class='ui-btn  ui-btn-a ui-corner-all ui-icon-bars ui-btn-icon-notext topmenu-right'>Меню </a>
		</div>
		
	</div><!-- /header -->

	<div role="main" class="ui-content page_limited" id="page_evants_content" >
		<div data-role="navbar" data-grid="c" class="ui-navbar navbar-public" role="navigation" style="">
			<ul class="ui-grid-c">
				<li class="ui-block-a"><a href="javascript: Evants.Go()" class="ui-link ui-btn  ui-btn-b ui-btn-active btn-evants"><i class="fa fa-bell"></i> <span>Новости</span></a></li>
				<li class="ui-block-b"><a href="javascript: Fotos.GoGallery()" class="ui-link ui-btn-b ui-btn btn-fotos"><i class="fa fa-camera"></i> <span>Фотогаларея</span></a></li>
				<li class="ui-block-c"><a href="javascript: UserList.GoUsers()" class="ui-link ui-btn-b ui-btn btn-users"><i class="fa fa-users"></i> <span>Люди</span></a></li>
				<li class="ui-block-d"><a href="javascript: Music.GoAll(null,1)" class="ui-link ui-btn-b ui-btn btn-music"><i class="fa fa-music"></i> <span>Музыка</a></span></li> 
			</ul>
		</div>
		<div id="page_evants_list"></div>
	</div><!-- /content -->
	
</div>

<!-------------------------------------------- Страница Загрузки контента ---------------------------------------->
<div data-role="page" id="page_upload" data-theme="a" >

	<div data-role="header" class='topheader' data-tap-toggle="false" data-position="fixed">
		<div class='ui-btn-left'>
			<a class="fa-button left" id="" href="#" >
					<i class="fa fa-chevron-left fa-lg fa-button-theme-a"></i> 
			</a>
		</div>
		<h1>Загрузка</h1>
		
	</div><!-- /header -->

	<div role="main" class="ui-content page_limited" id="page_upload_content" >
		<div data-role="collapsible" class='uploader' data-theme="b" data-content-theme="b">
			<h4>Добавить</h4>
			<p></p>
		</div>
		
		<h3 class="counter">Загружено (<span>0</span>)</h3>
		<div class="loaded">
		</div>
	</div><!-- /content -->
	
</div>
<!--Панель боковая-->
<div data-role="panel" data-position="left" data-position-fixed="true" data-display="overlay"  data-theme="b" id="left_panel">
		<h2>Меню</h2>
		<p> Вы не вошли под своим аккаунтом на Шах-Даг</p>
		<p><a href="#page_auth"  data-transition="slide" data-icon="lock" class="ui-btn ui-shadow ui-corner-all ui-btn-b nav-login">Войти</a></p>
	
</div>
<!--Панель боковая-->
<div data-role="panel" data-position="right" data-position-fixed="true" data-display="overlay"  data-theme="b" id="right_panel">
		<h2>Шах-Даг</h2>
		<p><a href="javascript: Fotos.GoGallery()"  data-transition="slide" data-icon="lock" class="ui-btn ui-shadow ui-corner-all ui-btn-b">Фотогалерея</a></p>
		<p><a href="javascript: Music.GoAll(null,1)"  data-transition="slide" data-icon="lock" class="ui-btn ui-shadow ui-corner-all ui-btn-b">Музыка</a></p>
		<p><a href="javascript: UserList.GoSearch()"  data-transition="slide" data-icon="lock" class="ui-btn ui-shadow ui-corner-all ui-btn-b">Люди</a></p>
		<p><a href="javascript: Geo.Page.Go()"  data-transition="slide" data-icon="lock" class="ui-btn ui-shadow ui-corner-all ui-btn-b">Карта</a></p>
	
</div>
<!--ajax loader-->
<div class="ajax-loader-center"><i class="fa fa-spinner animation-rotate-1s" style="font-size: 2em;"></i></div> 
</body>  
</html>
